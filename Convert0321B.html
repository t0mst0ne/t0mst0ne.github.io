<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIS 4.0 彙總報告整理 V0405D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            overflow-x: hidden;
        }

        /* 主要佈局容器 */
        .app-container {
            display: flex;
            min-height: 100vh;
            flex-direction: row; /* 水平布局 */
        }

        /* 左側邊欄樣式 */
        .sidebar {
            width: 240px;
            min-width: 240px;
            flex-shrink: 0;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        /* 標題區 */
        .sidebar-header {
            padding: 15px;
            background-color: #1a2530;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #3d556b;
        }

        /* 按鈕容器 */
        .action-buttons {
            margin-top: 10;
            padding: 15px 10px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            border-top: 1px solid #3d556b;
            border-bottom: 1px solid #3d556b;
        }

        .action-buttons button {
            padding: 10px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            transition: all 0.2s;
            text-align: left;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .action-buttons button:hover {
            background-color: #2980b9;
        }

        .action-buttons button i {
            margin-right: 8px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .action-buttons .advanced-button {
            background-color: #16a085;
        }

        .action-buttons .advanced-button:hover {
            background-color: #138a72;
        }

        .action-buttons .danger-button {
            background-color: #e74c3c;
        }

        .action-buttons .danger-button:hover {
            background-color: #c0392b;
        }

        .tab-buttons {
            display: flex;
            flex-direction: row;
            background-color: #2c3e50;
            border-radius: 0 0 0 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-bottom: 15px;
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 50;
            width: 100%;
            left: 0;
            box-sizing: border-box;
        }

        .tab-button {
            padding: 12px 20px;
            background-color: transparent;
            border: none;
            outline: none;
            cursor: pointer;
            color: #ecf0f1;
            text-align: center;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-button:hover {
            background-color: #34495e;
        }

        .tab-button.active {
            background-color: #34495e;
            color: #3498db;
            border-bottom-color: #3498db;
            font-weight: bold;
        }

        .tab-button i {
            margin-right: 10px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* 輸入區域工具欄 */
        .input-controls {
            margin-top: auto;
            padding: 15px;
            background-color: #1a2530;
            border-top: 1px solid #3d556b;
        }

        .toggle-input-btn {
            padding: 10px;
            width: 100%;
            background-color: #f39c12;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-input-btn:hover {
            background-color: #d68910;
        }

        .toggle-input-btn i {
            margin-right: 8px;
        }

        /* 主要內容區 */
        /* 確保主內容區域有足夠的頂部內邊距 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 0; /* 修改：移除頂部內邊距 */
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 20px;
            transition: all 0.3s;
        }

        /* 輸入區域 */
        .input-area {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none; /* 默認隱藏 */
            margin-top: 10px; /* 新增：增加頂部間距 */
        }

        textarea {
            width: 100%;
            height: 180px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            resize: vertical;
        }

        /* Tab內容區域 */
        .tab-content {
            display: none;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            min-height: 600px;
            margin-top: 10px; /* 新增：增加頂部間距 */
        }

        .tab-content.active {
            display: block;
        }

        /* 原始樣式保留 */
        pre {
            background: #f8f8f8;
            padding: 10px;
            white-space: pre-wrap;
            border-radius: 4px;
            border: 1px solid #eee;
            font-family: monospace;
            max-height: 600px;
            overflow-y: auto;
        }

        #chartContainer {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .chart-wrapper {
            min-width: 250px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 10px;
            cursor: move;
            background-color: white;
        }

        .chart-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        @media (max-width: 992px) {
            #chartContainer {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            #chartContainer {
                grid-template-columns: 1fr;
            }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                min-width: 100%;
                position: static;
            }
            
            .tab-buttons {
                width: 100%;
                border-radius: 0;
                overflow-x: auto;
            }
            
            .tab-button {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .action-buttons {
                margin-top: 0;
                grid-template-columns: 1fr 1fr;
                border-top: none;
            }
        }

        /* 引用舊樣式以保持原有功能 */
        .sensitivity-S {
            color: #28a745;          /* 綠色: 敏感 */
            font-weight: bold;
        }
        .sensitivity-R {
            color: #dc3545;          /* 紅色: 抗藥性 */
            font-weight: bold;
        }
        .sensitivity-I {
            color: #fd7e14;          /* 橙色: 中間型 */
            font-weight: bold;
        }
        .sensitivity-SDD {
            color: #17a2b8;          /* 藍綠色: 劑量依賴的敏感性 */
            font-weight: bold;
        }
        .sensitivity-D {
            color: #6610f2;          /* 紫色: 未定義/其他 */
            font-weight: bold;
        }
        .drug-name {
            font-family: monospace;  /* 使用等寬字體 */
        }
        .mic-value {
            font-style: italic;
            font-size: 0.9em;
            color: #6c757d;
        }
        .antibiotic-result {
            display: inline-block;
            margin-right: 12px;
            margin-bottom: 6px;
            padding: 3px 6px;
            border-radius: 4px;
            background-color: rgba(0,0,0,0.03);
        }
        .organism-container {
            margin-bottom: 10px;
            padding: 10px;
            border-left: 3px solid #29ab97;
            background-color: rgba(41, 171, 151, 0.05);
        }

        /* 這邊引用所有藥敏相關樣式，確保功能正常 */
        .sensitivity-analysis {
            margin: 20px 0;
            font-family: Arial, sans-serif;
        }
        .organism-container { font-size: 13px; }

        .organism-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .organism-button {
            background-color: #f1f1f1;
            border: 2px solid transparent;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .organism-button:hover {
            background-color: #e9e9e9;
        }

        .organism-button.active {
            background-color: #1e88e5;
            color: white;
            border-color: #0d47a1;
        }

        .antibiotic-class {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .class-header {
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
            font-weight: bold;
        }

        .antibiotic-list {
            padding: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .antibiotic-item {
            display: flex;
            align-items: center;
        }

        .antibiotic-name {
            margin-right: 8px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .sensitivity-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 15px;
            min-width: 24px;
            text-align: center;
        }

        .sensitivity-badge.sensitivity-S {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #81c784;
        }

        .sensitivity-badge.sensitivity-I {
            background-color: #fff8e1;
            color: #f57f17;
            border: 1px solid #ffd54f;
        }

        .sensitivity-badge.sensitivity-R {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .sensitivity-badge.sensitivity-SDD {
            background-color: #e1f5fe;
            color: #0277bd;
            border: 1px solid #4fc3f7;
        }

        .sensitivity-badge.sensitivity-D {
            background-color: #f3e5f5;
            color: #6a1b9a;
            border: 1px solid #ce93d8;
        }

        .specimen-info {
            font-size: 12px;
            color: #6c757d;
            margin-left: 5px;
        }

        .mic-value {
            font-size: 11px;
            color: #6c757d;
            margin-left: 4px;
        }

        .antibiotic-item:hover {
            background-color: rgba(0,0,0,0.02);
            border-radius: 4px;
        }

        .sensitivity-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }

        .sensitivity-table th,
        .sensitivity-table td {
            padding: 6px;
            border: 1px solid #ddd;
        }

        .sensitivity-table th {
            background-color: #f1f1f1;
            text-align: center;
        }

        .sensitivity-table thead th:first-child,
        .sensitivity-table tbody td:first-child {
            position: sticky;
            left: 0;
            z-index: 1;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sensitivity-table thead th:first-child {
            z-index: 2;
        }

        .sensitivity-table tbody tr:nth-child(odd) td:first-child {
            background-color: #fff;
        }

        .sensitivity-table tbody tr:nth-child(even) td:first-child {
            background-color: #f9f9f9;
        }

        .sensitivity-table tbody tr.class-header td {
            background-color: #f8f9fa;
            font-weight: bold;
            position: relative;
        }

        .sensitivity-table .untested {
            background-color: #f5f5f5;
            color: #9e9e9e;
            opacity: 0.5;
        }

        .sensitivity-table .sensitivity-S {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }

        .sensitivity-table .sensitivity-I {
            background-color: #fff8e1;
            color: #f57f17;
            font-weight: bold;
        }

        .sensitivity-table .sensitivity-R {
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
        }

        .sensitivity-table .sensitivity-SDD {
            background-color: #e1f5fe;
            color: #0277bd;
            font-weight: bold;
        }

        .sensitivity-table .sensitivity-D {
            background-color: #f3e5f5;
            color: #6a1b9a;
            font-weight: bold;
        }

        .sensitivity-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            font-size: 12px;
        }

        /* 新增彈出通知樣式 */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: #2ecc71;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 9999;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-notification.error {
            background-color: #e74c3c;
        }

        /* 動畫效果 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
    <!-- 加入Fontawesome圖標庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- 左側邊欄 -->
        <div class="sidebar">
            <div class="sidebar-header">
                HIS 4.0 彙總報告整理 0405D
            </div>

            <!-- 標籤頁按鈕 -->
            <div class="tab-buttons">
                <button class="tab-button active" onclick="openTab(event, 'textTab')">
                    <i class="fas fa-align-left"></i> 文字
                </button>
                <button class="tab-button" onclick="openTab(event, 'chartTab')">
                    <i class="fas fa-chart-line"></i> 趨勢
                </button>
                <button class="tab-button" onclick="openTab(event, 'microTab')">
                    <i class="fas fa-bacterium"></i> 微生物
                </button>
                <button class="tab-button" onclick="openTab(event, 'sensitivityTab')">
                    <i class="fas fa-tablets"></i> 藥敏
                </button>
                <button class="tab-button" onclick="openTab(event, 'summaryTab')">
                    <i class="fas fa-table"></i> 表格
                </button>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="action-buttons">
                <button onclick="clearAndParse()" title="清除輸入並貼上剪貼簿內容，然後自動整理" class="advanced-button">
                    <i class="fas fa-paste"></i> 貼上+整理
                </button>
                <button onclick="parseReport()" title="解析報告並整理微生物及趨勢圖">
                    <i class="fas fa-magic"></i> 整理資料
                </button>
                <button onclick="parseAndCopy()" title="整理報告並複製到剪貼簿">
                    <i class="fas fa-copy"></i> 整理+複製
                </button>
                <button onclick="letCopy()" title="複製文字報告到剪貼簿">
                    <i class="far fa-copy"></i> 複製
                </button>
                <button onclick="toggleOrder()" title="上下反轉文字報告順序">
                    <i class="fas fa-arrow-down-up-across-line"></i> 順序對調
                </button>
                <button onclick="clearInput()" title="清除輸入內容">
                    <i class="fas fa-eraser"></i> 清除內容
                </button>
                <button onclick="resetAll()" title="重置所有數據和顯示" class="danger-button">
                    <i class="fas fa-trash-alt"></i> 重置全部
                </button>
            </div>
            
            <!-- 輸入區控制 -->
            <div class="input-controls">
                <button class="toggle-input-btn" onclick="toggleInputArea()">
                    <i class="fas fa-keyboard"></i> 顯示輸入區
                </button>
            </div>
        </div>
        
        <!-- 主要內容區 -->
        <div class="main-content">
            <!-- 輸入區域 -->
            <div class="input-area" id="inputAreaContainer">
                <textarea id="inputReport" placeholder="請貼上原始報告"></textarea>
            </div>
            
            <!-- 標籤頁內容 -->
            <div id="textTab" class="tab-content active">
                <pre id="output"></pre>
            </div>
            
            <div id="chartTab" class="tab-content">
                <div class="micro-marker-legend">
                    <span class="micro-marker-dot"></span> 標記表示此日期有微生物檢測結果，將滑鼠移到標記上可查看詳細資訊
                </div>
                <div id="chartContainer"></div>
            </div>
            
            <div id="microTab" class="tab-content">
                <div id="microbiologyResults" style="font-size: 16px; line-height: 1.5;"></div>
            </div>
            
            <div id="sensitivityTab" class="tab-content">
                <div class="sensitivity-analysis">
                    <h3>抗生素敏感性分析</h3>
                    <div class="organism-selector" id="organismSelector"></div>
                    <div id="antibioticResults"></div>
                </div>
            </div>
            
            <div id="summaryTab" class="tab-content">
                <div id="summaryControls"></div>
                <div id="summaryTableContainer"></div>
            </div>
        </div>
    </div>

<script>
// 輸入區域的切換
function toggleInputArea() {
    const inputArea = document.getElementById('inputAreaContainer');
    const toggleBtn = document.querySelector('.toggle-input-btn');
    
    if (inputArea.style.display === 'none' || !inputArea.style.display) {
        inputArea.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> 隱藏輸入區';
    } else {
        inputArea.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> 顯示輸入區';
    }
}

// 頁籤切換的新函數
function openTab(evt, tabName) {
    // 隱藏所有頁籤內容
    const tabContents = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
    }
    
    // 取消所有頁籤按鈕的活動狀態
    const tabButtons = document.getElementsByClassName("tab-button");
    for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
    }
    
    // 顯示當前頁籤內容並將按鈕設為活動狀態
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
    
    // 如果切換到圖表頁籤，確保圖表正確顯示
    if (tabName === 'chartTab' && labData.length > 0) {
        setTimeout(() => {
            // 防止圖表放大問題 - 先不觸發resize事件
            const charts = document.querySelectorAll('#chartContainer canvas');
            charts.forEach(canvas => {
                const chart = Chart.getChart(canvas);
                if (chart) {
                    // 取消圖表的響應式設計，僅在此處理一次大小
                    chart.options.responsive = false;
                    chart.resize();
                    // 重新啟用響應式設計
                    chart.options.responsive = true;
                }
            });
        }, 10);
    }
    
    // 如果切換到表格頁籤且尚未初始化，進行初始化
    if (tabName === 'summaryTab' && labData.length > 0) {
        const summaryControls = document.getElementById('summaryControls');
        if (!summaryControls.innerHTML.trim()) {
            initSummaryTab();
        }
    }
}

// 顯示通知函數
function showNotification(message, isError = false) {
    // 移除舊通知
    const oldToast = document.querySelector('.toast-notification');
    if (oldToast) {
        oldToast.remove();
    }
    
    // 創建新通知
    const toast = document.createElement('div');
    toast.className = 'toast-notification' + (isError ? ' error' : '');
    toast.textContent = message;
    
    // 添加到頁面
    document.body.appendChild(toast);
    
    // 觸發動畫
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    // 2秒後消失
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 2000);
}

// 頁面載入完成後執行
document.addEventListener('DOMContentLoaded', function() {
    // 檢查本地存儲中是否有輸入區可見性設置
    const inputAreaVisible = localStorage.getItem('inputAreaVisible') === 'true';
    const inputArea = document.getElementById('inputAreaContainer');
    const toggleBtn = document.querySelector('.toggle-input-btn');
    
    if (inputAreaVisible) {
        inputArea.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> 隱藏輸入區';
    } else {
        inputArea.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> 顯示輸入區';
    }
    
    // 添加輸入框可見性設置存儲功能
    const originalToggleInputArea = toggleInputArea;
    window.toggleInputArea = function() {
        originalToggleInputArea();
        
        // 存儲設置到本地存儲
        const isVisible = document.getElementById('inputAreaContainer').style.display === 'block';
        localStorage.setItem('inputAreaVisible', isVisible);
    };
    
    // 檢查手機模式
    checkMobileMode();
    
    // 窗口大小改變時檢查手機模式
    window.addEventListener('resize', checkMobileMode);
});

// 檢查是否應切換到手機模式
function checkMobileMode() {
    const appContainer = document.querySelector('.app-container');
    if (window.innerWidth <= 768 && !appContainer.classList.contains('mobile-mode')) {
        appContainer.classList.add('mobile-mode');
        // 在手機模式下可能需要執行特定操作
    } else if (window.innerWidth > 768 && appContainer.classList.contains('mobile-mode')) {
        appContainer.classList.remove('mobile-mode');
        // 切換回桌面模式時的操作
    }
}

// 修改部分原始函數以添加通知
// 注意：這些修改需要在原始函數定義之後執行
function enhanceOriginalFunctions() {
    if (typeof window.letCopy === 'function') {
        const originalLetCopy = window.letCopy;
        window.letCopy = async function() {
            try {
                await originalLetCopy();
                showNotification('文字已成功複製到剪貼簿！');
            } catch (err) {
                showNotification('複製失敗：' + err.message, true);
                console.error('複製失敗:', err);
            }
        };
    }
    
    if (typeof window.parseAndCopy === 'function') {
        const originalParseAndCopy = window.parseAndCopy;
        window.parseAndCopy = async function() {
            try {
                await originalParseAndCopy();
                showNotification('解析結果已複製到剪貼簿！');
            } catch (err) {
                showNotification('複製失敗：' + err.message, true);
                console.error('複製失敗:', err);
            }
        };
    }
    
    if (typeof window.clearAndParse === 'function') {
        const originalClearAndParse = window.clearAndParse;
        window.clearAndParse = async function() {
            try {
                await originalClearAndParse();
                showNotification('剪貼簿內容已成功貼上並解析！');
            } catch (err) {
                showNotification('操作失敗：' + err.message, true);
                console.error('自動貼上失敗:', err);
            }
        };
    }
    
    if (typeof window.resetAll === 'function') {
        const originalResetAll = window.resetAll;
        window.resetAll = function() {
            originalResetAll();
            showNotification('所有數據已重置！');
        };
    }
}

// 在頁面載入後執行增強函數
window.addEventListener('load', function() {
    // 確保原始函數都已載入後再增強它們
    setTimeout(enhanceOriginalFunctions, 100);
});

// 下面是原本橫式布局的邏輯代碼

// Original JavaScript preserved
let originalOutput = "";
let isReversed = true;
let labData = [];
let allAntibioticResults = []; // 儲存藥敏數據
let allOrganisms = []; // 儲存微生物數據

// 監測的檢驗項目，按順序排列
const monitoredLabs = [
  'WBC', 'CRP', 'Cr', 'Plt', 'ALT', 'AST', 'Bil-T', 'Na', 'K', 'Hb', 
  'CMV-DNA', 'Aspergi-Ag-BAL', 'Aspergillus-Ag'
];
// 檢驗項目名稱映射
const labNameMappings = {
    'Creatinine': 'Cr',
    'Albumin': 'Alb',
    'Total Bilirubin': 'Bil-T',
    'T-Bilirubin': 'Bil-T',
    'Direct Bilirubin': 'Bil-D',
    'D-Bilirubin': 'Bil-D',
    'Hemoglobin': 'Hb',
    'Platelets': 'Plt',
    'Hematocrit': 'Hct',
    'Ca(Calcium)': 'Ca',
    'Inorganic P': 'P',
    'Na(Sodium)': 'Na',
    'K(Potassium)': 'K',
    'Mg(Magnesium)': 'Mg',
    'Nucleated RBC': 'NRBC',
    'Segment': 'Seg',
    'Lymphocyte': 'Lym',
    'Monocyte': 'Mo',
    'Eosinophil': 'Eos',
    'Basophil': 'Baso',
    'Meta-Myelocyte': 'Meta-Myelo',
    'Myelocyte': 'Myelo',
    'Band': 'B',
    'Abs Neutro. #': 'ANC',
    'WBC': 'WBC',
    'CRP': 'CRP',
    'ALT': 'ALT',
    'ALT(SGPT)': 'ALT',
    'ALT/GPT': 'ALT',
    'ALT/PT': 'ALT',
    'AST': 'AST',
    'AST(SGOT)': 'AST',
    'AST/GOT': 'AST',
    'AST/OT': 'AST',
    'CMV-DNA Q-PCR': 'CMV-DNA',
    'Aspergi.Ag(BAL)': 'Aspergi-Ag-BAL',
    'Aspergillus Ag': 'Aspergillus-Ag'
};

// 跳過的檢測項目
const skipTests = [
    'Estimated GFR',
    'Temperature',
    'TEMP',
    'MCH',
    'MCHC',
    'PDW',
    'MPV',
    'Nor.plasma mean',
    'APTT data/mean'
];

// 尿液檢查的關鍵詞，用於排除尿液檢查中的WBC
const urineTestKeywords = [
    'Color', 'Turbidity', 'SP.Gravity', 'pH', 'Nitrite', 
    'Ketone', 'Urobilinogen', 'UACR', 'MALB(U)', 'CREA(U)', 
    'Ca.Oxalate', 'Epith-Cell'
];

// 抗生素分類
// 更新 antibioticClasses 以包含TB藥物
const antibioticClasses = {
    "Penicillins": ["Ampicillin", "Penicillin", "Amoxicillin", "Oxacillin", "Piperacillin", "Ticarcillin"],
    "Cephalosporins": ["Cefazolin", "Ceftriaxone", "Ceftazidime", "Cefepime", "Cefuroxime", "Cefoxitin", "Cefoperazone/sulbactam", "Ceftaroline"],
    "Carbapenems": ["Ertapenem", "Imipenem", "Meropenem", "Doripenem"],
    "Aminoglycosides": ["Gentamicin", "Amikacin", "Tobramycin", "Streptomycin"],
    "Fluoroquinolones": ["Ciprofloxacin", "Levofloxacin", "Moxifloxacin", "Norfloxacin"],
    "Beta-lactam combinations": ["Amoxicillin/Clavulanate", "Amoxicillin/clavulanic acid", "Piperacillin/Tazobactam", "Ticarcillin/Clavulanate", "Ampicillin/Sulbactam", "Ampicillin-sulbactam", "Ceftazidime-avibactam", "Ceftolozane-tazobactam", "Ceftazidime/avibactam", "Ceftolozane/tazobactam"],
    "Macrolides": ["Azithromycin", "Erythromycin", "Clarithromycin"],
    "Tetracyclines": ["Tetracycline", "Doxycycline", "Minocycline", "Tigecycline"],
    "Glycopeptides": ["Vancomycin", "Teicoplanin"],
    "Sulfonamides": ["Trimethoprim/Sulfamethoxazole", "Sulfamethoxazole", "Sufamethoxazole-Trimethoprim"],
    "Lipopeptides": ["Daptomycin"],
    "Oxazolidinones": ["Linezolid"],
    "Polymyxin": ["Polymyxin B", "Colistin"],
    "First-line Anti-TB Drugs": ["Isoniazid", "Rifampin", "Ethambutol", "Pyrazinamide"],
    "Second-line Anti-TB Drugs": ["Streptomycin", "Kanamycin", "Amikacin", "Capreomycin", "Moxifloxacin", "Levofloxacin", "Cycloserine", "Para-aminosalicylic"],
    "Others": ["Chloramphenicol", "Clindamycin", "Fosfomycin", "Nitrofurantoin", "Metronidazole"]
};

// 清除輸入並解析新報告
async function clearAndParse() {
    try {
        // 清除輸入框
        document.getElementById("inputReport").value = "";
        
        // 嘗試從剪貼簿獲取內容
        const clipboardText = await navigator.clipboard.readText();
        
        // 將剪貼簿內容填入輸入框
        document.getElementById("inputReport").value = clipboardText;
        
        // 解析報告
        parseReport();
        
        // 提示成功
        const textarea = document.getElementById("inputReport");
        const originalBg = textarea.style.backgroundColor;
        textarea.style.backgroundColor = "#e6ffe6"; // 淡綠色閃爍
        setTimeout(() => {
            textarea.style.backgroundColor = originalBg;
        }, 500);
    } catch (err) {
        alert("無法自動貼上剪貼簿內容。請檢查是否已授予網頁讀取剪貼簿的權限。");
        console.error('自動貼上失敗:', err);
    }
}

// 清除輸入內容
function clearInput () {
    // 清除輸入框
    document.getElementById("inputReport").value = "";
}

// 重置所有狀態
// Update the resetAll function
function resetAll() {
    // 清空輸入框
    document.getElementById("inputReport").value = "";
    
    // 清空輸出區
    document.getElementById("output").textContent = "";
    
    // 清空圖表
    document.getElementById("chartContainer").innerHTML = "";
    
    // 清空微生物結果
    document.getElementById("microbiologyResults").innerHTML = "<p>無微生物檢查結果</p>";
    
    // 清空藥敏測試結果
    document.getElementById("antibioticResults").innerHTML = "<p>無藥敏測試結果</p>";
    document.getElementById("organismSelector").innerHTML = "";
    
    // 清空摘要表格
    const summaryControls = document.getElementById('summaryControls');
    const summaryTableContainer = document.getElementById('summaryTableContainer');
    if (summaryControls) summaryControls.innerHTML = '';
    if (summaryTableContainer) summaryTableContainer.innerHTML = '<p style="text-align: center; padding: 20px;">請在上方選擇檢驗項目並點擊「更新表格」按鈕</p>';
    
    // 重置數據
    labData = [];
    allAntibioticResults = [];
    allOrganisms = [];
    originalOutput = "";
    isReversed = true;
    
    // 切換到文字標籤頁
    openTab({ currentTarget: document.querySelector('.tab-button[onclick*="textTab"]') }, 'textTab');
    
    // 提示重置完成
    const notification = document.createElement("div");
    notification.textContent = "已重置所有數據";
    notification.style.position = "fixed";
    notification.style.top = "20px";
    notification.style.left = "50%";
    notification.style.transform = "translateX(-50%)";
    notification.style.backgroundColor = "#4CAF50";
    notification.style.color = "white";
    notification.style.padding = "12px 20px";
    notification.style.borderRadius = "4px";
    notification.style.zIndex = "9999";
    notification.style.boxShadow = "0 2px 5px rgba(0,0,0,0.3)";
    document.body.appendChild(notification);
    
    // 2秒後移除提示
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 2000);
}

// 清理數值, 考慮原始資料有大於小於特定數值的極端值
function cleanValue(testCode, value) {
    // 移除括號中的內容
    value = value.replace(/\([^)]*\)/g, '').trim();
    
    // 處理小於符號的情況（如 "<0.1"）
    if (value.includes('<')) {
        // 提取數值部分，假設為閾值的一半
        const numericMatch = value.match(/<([\d.]+)/);
        if (numericMatch) {
            return (parseFloat(numericMatch[1]) / 2).toString();
        }
    }
    
    // 處理大於符號的情況（如 ">500"）
    if (value.includes('>')) {
        // 提取數值部分，假設為閾值的1.5倍（可調整為合理值）
        const numericMatch = value.match(/>([\d.]+)/);
        if (numericMatch) {
            return (parseFloat(numericMatch[1]) * 1.5).toString();
        }
    }

    // 處理 "Not detected" 和 "Target Not Detected"
    if (value.toLowerCase() === 'not detected' || 
        value.toLowerCase() === 'target not detected') {
        return '0';
    }
    
    // 提取數字部分
    const numericMatch = value.match(/^[\d.]+/);
    return numericMatch ? numericMatch[0] : value;
}

// 判斷是否跳過該行
function shouldSkipLine(line) {
    const skipPatterns = [
        /^[SCVM]\d{9}/,
        /開單醫師/,
        /院區:/,
        /檢體別:/,
        /來源:/,
        /生日:/,
        /床位:/,
        /科別:/,
        /姓名:/,
        /姓名\t/,
        /性別:/,
        /病歷號:/,
        /醫檢師:/,
        /long/i,
        /第\d+\/\d+頁/,
        /僅供參考非正式報告/,
        /[A-Z]\d{2}[A-Z]\d{4}/,
        /半定量$/,
        /檢驗項目縮寫\t項目中文說明/,
        /藥物名稱 \\ 序號/
    ];
    return skipPatterns.some(pattern => pattern.test(line));
}

// 簡化檢驗名稱
function simplifyLabName(testCode) {
    return labNameMappings[testCode] || testCode;
}

// 提取檢體資訊
function extractSpecimen(block) {
    const match = block.match(/檢體別:\s*([^\t\n]+)/);
    return match ? match[1].trim() : "";
}

// 判斷區塊是否為尿液檢查
function isUrineTest(block) {
    // 檢查是否包含尿液檢查的關鍵詞
    return urineTestKeywords.some(keyword => block.includes(keyword)) || 
           block.toLowerCase().includes('urine') || 
           block.includes('尿液');
}

// 線性回歸計算
function linearRegression(x, y) {
    const n = x.length;
    
    // 計算平均值
    let sumX = 0;
    let sumY = 0;
    for (let i = 0; i < n; i++) {
        sumX += x[i];
        sumY += y[i];
    }
    const meanX = sumX / n;
    const meanY = sumY / n;
    
    // 計算斜率和截距
    let numerator = 0;
    let denominator = 0;
    for (let i = 0; i < n; i++) {
        numerator += (x[i] - meanX) * (y[i] - meanY);
        denominator += (x[i] - meanX) * (x[i] - meanX);
    }
    
    const slope = denominator !== 0 ? numerator / denominator : 0;
    const intercept = meanY - slope * meanX;
    
    return {
        slope,
        intercept
    };
}

// 尋找最接近值的索引
function findClosestIndex(array, value) {
    let closestIndex = 0;
    let minDiff = Math.abs(array[0] - value);
    
    for (let i = 1; i < array.length; i++) {
        const diff = Math.abs(array[i] - value);
        if (diff < minDiff) {
            minDiff = diff;
            closestIndex = i;
        }
    }
    
    return closestIndex;
}

// 修改 processMICBlock 函數以處理日期時間和收件編號
function processMICBlock(block) {
    let lines = block.split('\n');
    let organisms = [];
    let micResults = [];
    let isCollectingOrganisms = false;
    let isCollectingMIC = false;
    let specimen = extractSpecimen(block);
    
    // 提取日期時間和收件編號信息
    let sampleDateTime = block.match(/採檢時間:\s*(\d{4}\/\d{2}\/\d{2})\s*(\d{1,2}:\d{2})/);
    let sampleDate = block.match(/採檢時間:\s*(\d{4}\/\d{2}\/\d{2})/);
    let shortDate = sampleDate ? sampleDate[1].slice(5).replace('/', '-') : "";
    let fullDate = sampleDate ? sampleDate[1] : "";
    let sampleTime = sampleDateTime ? sampleDateTime[2] : "";
    let fullDateTime = sampleDateTime ? `${sampleDateTime[1]} ${sampleDateTime[2]}` : fullDate;
    let datetime = sampleTime ? `${shortDate} ${sampleTime}` : shortDate;
    
    // 提取收件編號
    let sampleID = extractSampleID(block);
    
    // 用於存儲序號與對應的數組索引映射
    let numberToIndexMap = {};
    
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;
        
        let parts = line.split('\t');
        
        if (parts[0] === "MIC" && parts[3] && parts[4]) {
            // 提取序號，確保它是整數
            const number = parseInt(parts[2]) || 0;
            
            // 儲存這個序號對應的索引位置
            numberToIndexMap[number] = organisms.length;
            
            organisms.push({
                number: number,  // 保存原始序號
                name: parts[3],
                growth: parts[4],
                datetime: datetime,
                sampleTime: sampleTime,
                sampleID: sampleID
            });
            isCollectingOrganisms = true;
        }
        else if (isCollectingOrganisms && line.includes("藥物名稱")) {
            isCollectingOrganisms = false;
            isCollectingMIC = true;
        }
        else if (isCollectingMIC && parts.length > 1) {
            let drug = parts[0].trim();
            if (!drug || drug === "藥物名稱 \\ 序號") continue;
            
            // 從索引1開始處理每個細菌的藥敏結果
            for (let j = 1; j < parts.length; j++) {
                if (parts[j] && parts[j].trim()) {
                    // 提取這個列對應的序號
                    const columnNumber = j;
                    
                    let resultParts = parts[j].trim().split(' ');
                    let result = resultParts[0]; // S, R, I
                    let micValue = resultParts.length > 1 ? resultParts.slice(1).join(' ') : ''; // MIC值
                    
                    if (result && ['S', 'I', 'R', 'D', 'SDD'].includes(result)) {
                        // 找出此序號對應的微生物
                        let organismIndex = null;
                        
                        // 檢查是否有直接匹配的序號
                        if (numberToIndexMap[columnNumber] !== undefined) {
                            organismIndex = numberToIndexMap[columnNumber];
                        }
                        
                        // 如果找到了對應的微生物
                        if (organismIndex !== null && organisms[organismIndex]) {
                            micResults.push({
                                drug: drug,
                                organism: organisms[organismIndex].name,
                                result: result,
                                micValue: micValue,
                                testType: 'MIC',
                                specimen: specimen,
                                date: fullDate,
                                shortDate: shortDate,
                                datetime: datetime,
                                sampleTime: sampleTime,
                                sampleID: sampleID,
                                fullDateTime: fullDateTime,
                                number: columnNumber  // 保存序號
                            });
                        }
                    }
                }
            }
        }
    }
    
    // 生成HTML格式的結果，添加日期時間
    let htmlResults = '';
    organisms.forEach(org => {
        let orgResults = micResults.filter(r => r.organism === org.name);
        if (orgResults.length > 0 || org.growth) {
            htmlResults += `<div class="organism-container">
                <div><strong>${org.datetime} MIC ${specimen} ${org.name}</strong> "${org.growth}":</div>
                <div style="padding-left: 20px; margin-top: 5px;">`;
            
            orgResults.forEach(r => {
                htmlResults += `<span class="antibiotic-result">
                    <span class="drug-name">${r.drug}</span>
                    <span class="sensitivity-${r.result}">${r.result}</span>
                    ${r.micValue ? `<span class="mic-value"> ${r.micValue}</span>` : ''}
                </span>`;
            });
            
            htmlResults += `</div></div>`;
        }
    });
    
    // 為了保持與原來邏輯一致，我們仍然返回原始的純文本結果用於文字Tab
    let formattedResults = [];
    organisms.forEach(org => {
        let orgResults = micResults.filter(r => r.organism === org.name);
        if (orgResults.length > 0 || org.growth) {
            formattedResults.push(`MIC ${specimen} ${org.name} "${org.growth}":`);
            orgResults.forEach(r => {
                let resultText = `${r.drug} ${r.result}`;
                if (r.micValue) {
                    resultText += ` ${r.micValue}`;
                }
                formattedResults.push(resultText);
            });
        }
    });
    
    return {
        results: formattedResults.join(' '),
        htmlResults: htmlResults,
        specimen: specimen,
        micResults: micResults, // 返回完整的MIC結果數據
        organisms: organisms    // 返回所有識別出的微生物
    };
}

// 處理抗生素區塊 - 修改以正確處理序號與藥敏結果的關聯
function processAntibioticBlock(block) {
    let lines = block.split('\n');
    let organisms = [];
    let antibioticResults = [];
    let isCollectingOrganisms = false;
    let isCollectingAntibiotics = false;
    let specimen = extractSpecimen(block);
    let cultureType = "";
    let hasNoGrowth = false;
    
    // 提取完整日期和時間
    let sampleDateTime = block.match(/採檢時間:\s*(\d{4}\/\d{2}\/\d{2})\s*(\d{1,2}:\d{2})/);
    let fullDateTime = sampleDateTime ? `${sampleDateTime[1]} ${sampleDateTime[2]}` : "";
    let sampleDate = block.match(/採檢時間:\s*(\d{4}\/\d{2}\/\d{2})/);
    let shortDate = sampleDate ? sampleDate[1].slice(5).replace('/', '-') : "";
    let fullDate = sampleDate ? sampleDate[1] : "";
    let sampleTime = sampleDateTime ? sampleDateTime[2] : "";
    
    // 提取收件編號，用於生成唯一標識
    let sampleID = extractSampleID(block);
    
    // 構建唯一的datetime字符串，用於區分同一天不同時間的樣本
    let datetime = sampleTime ? `${shortDate} ${sampleTime}` : shortDate;
    
    // 首先識別所有微生物及其序號
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;
        
        let parts = line.split('\t');
        
        // 確定培養類型
        if (parts[0] === "Blood Culture" || parts[0] === "Aerobic Culture" || parts[0] === "Anaerobic Cultu") {
            cultureType = parts[0] === "Blood Culture" ? "B/C" : 
                          parts[0] === "Aerobic Culture" ? "Aerobic" : "Anaerobic";
        }
        
        // 檢查是否有"No Growth"
        if (parts[0] === "Blood Culture" && parts[3] && parts[3].includes("No Growth")) {
            hasNoGrowth = true;
            continue;
        }
        
        if ((parts[0] === "Aerobic Culture" || parts[0] === "Blood Culture" || parts[0] === "Anaerobic Cultu") && 
            parts.length >= 4 && parts[2] && parts[3]) {
            // 提取序號，確保它是整數
            const seqNumber = parseInt(parts[2]) || 0;
            
            // 儲存微生物信息，明確包含序號和時間信息
            organisms.push({
                number: seqNumber,  // 保存序號
                name: parts[3],
                growth: parts[4] || '',
                cultureType: cultureType,
                datetime: datetime,  // 添加時間信息
                sampleID: sampleID   // 添加收件編號
            });
            
            isCollectingOrganisms = true;
        }
    }
    
    // 再處理藥敏結果部分
    let drugNamesFound = false;
    let drugResults = false;
    
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;
        
        if (line.includes("藥物名稱") || line.includes("藥物名稱 \\ 序號")) {
            drugNamesFound = true;
            continue; // 跳過標題行
        }
        
        // 處理藥敏結果行
        if (drugNamesFound && !line.includes("檢驗結果說明")) {
            // 分割行，確保正確處理空格
            let parts = line.split('\t');
            if (parts.length < 2) continue;
            
            let drug = parts[0].trim();
            if (!drug || drug === "藥物名稱 \\ 序號") continue;
            
            // 遍歷每個序號結果列
            for (let j = 1; j < parts.length; j++) {
                let resultText = parts[j] ? parts[j].trim() : '';
                if (!resultText) continue;
                
                // 提取藥敏結果和MIC值
                let resultParts = resultText.split(' ');
                let result = resultParts[0]; // S, R, I, D, SDD等
                let micValue = resultParts.length > 1 ? resultParts.slice(1).join(' ') : '';
                
                if (result && ['S', 'I', 'R', 'D', 'SDD'].includes(result)) {
                    // 尋找對應序號的菌株
                    let matchingOrganism = organisms.find(org => org.number === j);
                    
                    if (matchingOrganism) {
                        // 存儲藥敏結果，明確標記序號和時間信息
                        antibioticResults.push({
                            drug: drug,
                            organism: matchingOrganism.name,
                            result: result,
                            micValue: micValue,
                            testType: matchingOrganism.cultureType,
                            specimen: specimen,
                            date: fullDate,
                            fullDateTime: fullDateTime,
                            shortDate: shortDate,
                            datetime: datetime,     // 添加時間信息
                            sampleTime: sampleTime, // 添加采樣時間
                            sampleID: sampleID,     // 添加收件編號
                            number: j               // 序號
                        });
                        
                        drugResults = true;
                    }
                }
            }
        }
    }
    
    // 生成HTML格式的結果，顯示序號信息
    let htmlResults = '';
    
    // 如果有"No Growth"，添加相應的顯示
    if (hasNoGrowth) {
        htmlResults += `<div class="organism-container">
            <div><strong>${datetime} B/C No Growth</strong> <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>
        </div>`;
    }
    
    // 為每個菌種序號組合生成單獨的結果顯示
    organisms.forEach(org => {
        let orgResults = antibioticResults.filter(r => r.organism === org.name && r.number === org.number);
        
        if (orgResults.length > 0 || org.growth) {
            let prefix = org.cultureType === "B/C" ? org.cultureType : `${org.cultureType} ${specimen}`;
            
            // 明確顯示序號和時間
            htmlResults += `<div class="organism-container">
                <div><strong>${org.datetime} ${prefix} ${org.name}</strong> (序號:${org.number}) "${org.growth}":</div>
                <div style="padding-left: 20px; margin-top: 5px;">`;
            
            orgResults.forEach(r => {
                htmlResults += `<span class="antibiotic-result">
                    <span class="drug-name">${r.drug}</span> 
                    <span class="sensitivity-${r.result}">${r.result}</span>
                    ${r.micValue ? `<span class="mic-value"> ${r.micValue}</span>` : ''}
                </span>`;
            });
            
            htmlResults += `</div></div>`;
        }
    });
    
    // 為了保持與原來邏輯一致，我們仍然返回原始的純文本結果用於文字Tab
    let formattedResults = [];
    
    // 添加"No Growth"信息到文本結果
    if (hasNoGrowth) {
        formattedResults.push(`B/C No Growth`);
    }
    
    // 確保為每個菌株序號生成單獨的結果顯示
    organisms.forEach(org => {
        let orgResults = antibioticResults.filter(r => r.organism === org.name && r.number === org.number);
        
        if (orgResults.length > 0 || org.growth) {
            let prefix = org.cultureType === "B/C" ? org.cultureType : `${org.cultureType} ${specimen}`;
            formattedResults.push(`${prefix} ${org.name} (序號:${org.number}) "${org.growth}":`);
            
            orgResults.forEach(r => {
                let resultText = `${r.drug} ${r.result}`;
                if (r.micValue) {
                    resultText += ` ${r.micValue}`;
                }
                formattedResults.push(resultText);
            });
        }
    });
    
    return {
        results: formattedResults.join(' '),
        htmlResults: htmlResults,
        specimen: specimen,
        hasNoGrowth: hasNoGrowth,
        antibioticResults: antibioticResults, // 包含序號信息的抗生素結果
        organisms: organisms                  // 包含序號信息的微生物
    };
}

// 修改 parseReportText 函數以在存儲微生物信息時包含時間和檢體編號
function parseReportText(text) {
    let blocks = text.split(/收件編號:\s+/).slice(1);
    let result = "";
    labData = []; // 重置檢驗數據
    allAntibioticResults = []; // 重置藥敏數據
    allOrganisms = []; // 重置微生物數據
    
    blocks.forEach(block => {
        let sampleDate = block.match(/採檢時間:\s*(\d{4}\/\d{2}\/\d{2})/);
        let shortDate = sampleDate ? sampleDate[1].slice(5).replace('/', '-') : "";
        let fullDate = sampleDate ? sampleDate[1] : "";

        // 提取時間信息
        let sampleDateTime = block.match(/採檢時間:\s*(\d{4}\/\d{2}\/\d{2})\s*(\d{1,2}:\d{2})/);
        let sampleTime = sampleDateTime ? sampleDateTime[2] : "";  // 格式如 "17:02"
        
        // 提取完整的採檢時間
        let fullDateTime = sampleDateTime ? `${sampleDateTime[1]} ${sampleDateTime[2]}` : fullDate;
        
        // 提取日期時間的唯一標識值
        let datetime = sampleTime ? `${shortDate} ${sampleTime}` : shortDate;
        
        // 提取收件編號
        let sampleID = extractSampleID("收件編號: " + block);

        let specimen = extractSpecimen(block);
        
        // 檢測是否為尿液檢查
        let isUrineSpecimen = isUrineTest(block);
        
        // 處理結核菌培養(TB Culture)結果 - 新增
        if (block.includes('TB Culture') || block.includes('分枝桿菌培養')) {
            let processedData = processTBData(block);
            if (processedData.results) {
                result += `${shortDate} ${processedData.results}\n`;
            }
            
            // 儲存TB藥敏結果
            if (processedData.tbDrugs && processedData.tbDrugs.length > 0) {
                allAntibioticResults = [...allAntibioticResults, ...processedData.tbDrugs];
            }
            
            // 儲存TB微生物資訊
            if (processedData.organisms && processedData.organisms.length > 0) {
                processedData.organisms.forEach(org => {
                    allOrganisms.push({
                        name: org.name,
                        growth: org.growth,
                        specimen: specimen,
                        date: fullDate,
                        shortDate: shortDate,
                        testType: org.cultureType || 'Culture',
                        number: org.number // 添加序號信息
                    });
                });
            }
            
            return;
        }
        
        // 處理MIC數據
        if (block.includes('MIC') && block.includes('藥物名稱')) {
            let processedData = processMICBlock(block);
            if (processedData.results) {
                result += `${shortDate} ${processedData.results}\n`;
            }
            
            // 儲存MIC結果用於藥敏分析頁面
            if (processedData.micResults && processedData.micResults.length > 0) {
                allAntibioticResults = [...allAntibioticResults, ...processedData.micResults];
            }
            
            // 儲存微生物資訊
            if (processedData.organisms && processedData.organisms.length > 0) {
                processedData.organisms.forEach(org => {
                    allOrganisms.push({
                        name: org.name,
                        growth: org.growth,
                        specimen: specimen,
                        date: fullDate,
                        shortDate: shortDate,
                        testType: 'MIC'
                    });
                });
            }
            
            return;
        }
        
        // 處理一般抗生素敏感性測試
        if ((block.includes('藥物名稱')) && (block.includes('Aerobic Culture') || block.includes('Blood Culture') || block.includes('Anaerobic Cultu'))) {
            let processedData = processAntibioticBlock(block);
            if (processedData.results) {
                result += `${shortDate} ${processedData.results}\n`;
            }
            
            // 儲存抗生素結果用於藥敏分析頁面
            if (processedData.antibioticResults && processedData.antibioticResults.length > 0) {
                allAntibioticResults = [...allAntibioticResults, ...processedData.antibioticResults];
            }
            
            // 儲存微生物資訊
            if (processedData.organisms && processedData.organisms.length > 0) {
                processedData.organisms.forEach(org => {
                    allOrganisms.push({
                        name: org.name,
                        growth: org.growth,
                        specimen: specimen,
                        date: fullDate,
                        shortDate: shortDate,
                        testType: org.cultureType || 'Culture'
                    });
                });
            }
            
            return;
        }
let isMicrobiology = block.includes('學門別:微生物') || 
                            block.includes('Aerobic Culture') || 
                            block.includes('Blood Culture') || 
                            block.includes('Anaerobic Cultu') ||
                            block.includes('Fungus Culture') ||
                            block.includes('MIC');
                            
        let lines = block.split('\n');
        let extractedData = [];
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            if (!line || shouldSkipLine(line)) continue;
            
            let parts = line.split('\t');
            
            if (parts.length >= 3) {
                if (isMicrobiology) {
                    if (parts[0] === "Aerobic Culture" && parts[3]) {
                        extractedData.push(`Aerobic ${specimen} ${parts[3]}`);
                        
                        // 儲存微生物資訊
                        allOrganisms.push({
                            name: parts[3],
                            growth: parts[4] || '',
                            specimen: specimen,
                            date: fullDate,
                            shortDate: shortDate,
                            testType: 'Aerobic'
                        });
                    } else if (parts[0] === "Anaerobic Cultu" && parts[3]) {
                        extractedData.push(`Anaerobic ${specimen} ${parts[3]}`);
                        
                        // 儲存微生物資訊
                        allOrganisms.push({
                            name: parts[3],
                            growth: parts[4] || '',
                            specimen: specimen,
                            date: fullDate,
                            shortDate: shortDate,
                            testType: 'Anaerobic'
                        });
                    } else if (parts[0] === "MIC" && parts[3]) {
                        extractedData.push(`MIC ${specimen} ${parts[3]}`);
                        
                        // 儲存微生物資訊
                        allOrganisms.push({
                            name: parts[3],
                            growth: parts[4] || '',
                            specimen: specimen,
                            date: fullDate,
                            shortDate: shortDate,
                            testType: 'MIC'
                        });
                    } else if (parts[0] === "Blood Culture" && parts[3] && parts[3].includes("No Growth")) {
                        extractedData.push("B/C No growth");
                    } else if (parts[0] === "Blood Culture" && parts[3]) {
                        extractedData.push(`B/C ${parts[3]}`);
                        
                        // 儲存微生物資訊
                        allOrganisms.push({
                            name: parts[3],
                            growth: parts[4] || '',
                            specimen: 'Blood',
                            date: fullDate,
                            shortDate: shortDate,
                            testType: 'B/C'
                        });
                    } else if (parts[0] === "Fungus Culture" && parts[3]) {
                        extractedData.push(`Fungus ${specimen} ${parts[3]}`);
                        
                        // 儲存微生物資訊
                        allOrganisms.push({
                            name: parts[3],
                            growth: parts[4] || '',
                            specimen: specimen,
                            date: fullDate,
                            shortDate: shortDate,
                            testType: 'Fungus'
                        });
                    }
                } else {
                    if (parts[0] && parts[2]) {
                        let testCode = parts[0].trim();
                        if (skipTests.includes(testCode)) continue;
                        
                        let originalValue = parts[2].trim();
                        
                        // 處理特殊情況如ALT/GPT
                        if (testCode.includes('ALT') || testCode.includes('GPT')) {
                            testCode = 'ALT';
                        }
                        
                        // 簡化測試代碼
                        testCode = simplifyLabName(testCode);
                        
                        // 提取實際數值
                        let value = cleanValue(testCode, originalValue);
                        
                        if (testCode && originalValue && !testCode.includes('檢驗項目縮寫')) {
                            extractedData.push(`${testCode} ${originalValue}`);
                            
                            // 儲存需要監測的檢驗項目數據，但排除尿液檢查中的項目
                            if (!(isUrineSpecimen && (testCode === 'WBC' || testCode === 'RBC'))) {
                                // 嘗試提取數值部分以便圖表顯示
                                let numericValue = parseFloat(value);
                                if (!isNaN(numericValue)) {
                                    labData.push({
                                        date: fullDate,
                                        time: sampleTime,  // 時間字段
                                        shortDate: shortDate,
                                        test: testCode,
                                        value: numericValue,
                                        rawValue: originalValue,
                                        specimen: specimen
                                    });
                                }
                            }
                        }
                    }
                }
            }
        }
        
        if (extractedData.length > 0) {
            result += `${shortDate} ${extractedData.join(' ')}\n`;
        }
    });
    
    return result.trim();
}

// 修改 extractMicrobiologyData 函數，確保能正確識別 TB Culture 數據
function extractMicrobiologyData(text) {
    const blocks = text.split(/收件編號:\s+/).slice(1);
    const microData = [];
    
    blocks.forEach(block => {
        // 擴展檢查條件，專門包含 TB Culture 相關關鍵詞
        if (block.includes('Blood Culture') || 
            block.includes('Aerobic Culture') || 
            block.includes('Anaerobic Cultu') || 
            block.includes('MIC') || 
            block.includes('Fungus Culture') ||
            block.includes('CMV-DNA Q-PCR') ||
            block.includes('Aspergi.Ag(BAL)') ||
            block.includes('Aspergillus Ag') ||
            // 明確加入 TB Culture 相關條件
            block.includes('TB Culture') ||
            block.includes('分枝桿菌培養') ||
            block.includes('acid fast bacilli') ||
            block.includes('Mycobacterium') ||
            block.includes('Ethambutol') ||
            block.includes('Isoniazid') ||
            block.includes('Rifampin') ||
            block.includes('Streptomycin') ||
            block.includes('結核菌') ||
            block.includes('tubercul') ||
            block.includes('血液培養(from PORT A)')) {
            
            microData.push(block);
        }
    });
    
    return microData;
}

// 反轉輸出順序
function reverseOutput(text) {
    return text.split('\n').reverse().join('\n');
}

// 切換順序按鈕
function toggleOrder() {
    let outputElement = document.getElementById("output");
    if (outputElement.textContent) {
        outputElement.textContent = reverseOutput(outputElement.textContent);
        isReversed = !isReversed;
    }
}

// 解析報告按鈕
function parseReport() {
    let text = document.getElementById("inputReport").value;
    let parsedText = parseReportText(text);
    originalOutput = parsedText;
    document.getElementById("output").textContent = isReversed ? reverseOutput(parsedText) : parsedText;
    generateCharts();
    generateMicrobiologyResults();
    generateSensitivityAnalysis();
    
    // Initialize the summary tab
    initSummaryTab();
    
    // 自動切換到藥敏標籤頁
    if (allAntibioticResults.length > 0) {
        openTab({ currentTarget: document.querySelector('.tab-button[onclick*="sensitivityTab"]') }, 'sensitivityTab');
    }
    // 如果沒有藥敏結果但有微生物結果，則切換到微生物標籤頁
    else if (extractMicrobiologyData(text).length > 0) {
        openTab({ currentTarget: document.querySelector('.tab-button[onclick*="microTab"]') }, 'microTab');
    }
}

// 複製按鈕
async function letCopy() {
    try {
        // 獲取輸出區域的文本
        const outputText = document.getElementById("output").textContent;
        
        // 檢查是否有內容可複製
        if (!outputText.trim()) {
            alert("目前沒有內容可複製！");
            return;
        }
        
        // 複製到剪貼板
        await navigator.clipboard.writeText(outputText);
        
        // 提供成功反饋
        const outputElement = document.getElementById("output");
        const originalBg = outputElement.style.backgroundColor;
        outputElement.style.backgroundColor = "#e8f5e9"; // 淡綠色閃爍
        setTimeout(() => {
            outputElement.style.backgroundColor = originalBg;
        }, 500);
        
        alert("文字已複製到剪貼簿！");
    } catch (err) {
        alert("複製失敗，請手動複製結果。");
        console.error('複製失敗:', err);
    }
}

// 解析並複製按鈕
async function parseAndCopy() {
    let text = document.getElementById("inputReport").value;
    let parsedText = parseReportText(text);
    originalOutput = parsedText;
    let outputText = isReversed ? reverseOutput(parsedText) : parsedText;
    
    try {
        await navigator.clipboard.writeText(outputText);
        document.getElementById("output").textContent = outputText;
        generateCharts();
        generateMicrobiologyResults();
        generateSensitivityAnalysis();
        
        // Initialize the summary tab
        initSummaryTab();
        
        alert("解析結果已複製到剪貼簿！");
        
        // 自動切換到藥敏標籤頁
        if (allAntibioticResults.length > 0) {
            openTab({ currentTarget: document.querySelector('.tab-button[onclick*="sensitivityTab"]') }, 'sensitivityTab');
        }
        // 如果沒有藥敏結果但有微生物結果，則切換到微生物標籤頁
        else if (extractMicrobiologyData(text).length > 0) {
            openTab({ currentTarget: document.querySelector('.tab-button[onclick*="microTab"]') }, 'microTab');
        }
    } catch (err) {
        alert("複製失敗，請手動複製結果。");
        console.error('複製失敗:', err);
    }
}

// 提取收件編號函數
function extractSampleID(block) {
    const match = block.match(/收件編號:\s*([^\t\n]+)/);
    return match ? match[1].trim() : "";
}

// 修改 generateMicrobiologyResults 函數以處理 TB Culture 和藥敏結果
function generateMicrobiologyResults() {
    const microbiologyDiv = document.getElementById('microbiologyResults');
    const originalText = document.getElementById("inputReport").value;
    
    // 首先按收件編號分割報告
    const reportBlocks = originalText.split(/收件編號:\s+/).slice(1);
    
    if (reportBlocks.length > 0) {
        microbiologyDiv.innerHTML = '<h3 style="color: #29ab97; margin-top: 0;">微生物檢查結果</h3>';
        let htmlContent = '';
        
        // 收集所有微生物結果
        const noGrowthResults = {};
        const antibioticResults = {};
        const normalResults = {};
        const tbResults = {}; // 新增專門存放 TB 結果
        
        // 用於追蹤已處理的收件編號
        const processedSampleIDs = new Set();
        
        // 優先處理含有微生物的區塊
        reportBlocks.forEach(block => {
            // 重建完整區塊以供提取函數使用
            const fullBlock = "收件編號: " + block;
            
            // 提取收件編號
            const sampleID = extractSampleID(fullBlock);
            
            // 如果已經處理過這個收件編號，則跳過
            if (processedSampleIDs.has(sampleID)) {
                return;
            }
            
            // 標記已處理
            processedSampleIDs.add(sampleID);
            
            let sampleDate = fullBlock.match(/採檢時間:\s*(\d{4}\/\d{2}\/\d{2})/);
            let shortDate = sampleDate ? sampleDate[1].slice(5).replace('/', '-') : "";
            let specimen = extractSpecimen(fullBlock);
            
            // 處理 TB Culture 結果
            if (fullBlock.includes('TB Culture') || fullBlock.includes('分枝桿菌培養')) {
                const lines = fullBlock.split('\n');
                let tbOrganismFound = false;
                let tbDrugResults = [];
                
                // 尋找 TB 菌種信息
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    let parts = line.split('\t');
                    
                    if ((parts[0] === "TB Culture" || parts[0] === "分枝桿菌培養及抗酸性染色") && parts[3]) {
                        tbOrganismFound = true;
                        
                        const key = `${shortDate} TB ${specimen} ${parts[3]}`;
                        const resultNote = fullBlock.match(/檢驗結果說明: (.*?)$/m) ? fullBlock.match(/檢驗結果說明: (.*?)$/m)[1].trim() : "";
                        const acidFastInfo = parts[5] ? parts[5].trim() : "";
                        
                        // 暫存 TB 菌種信息
                        tbResults[key] = {
                            organism: parts[3],
                            acidFastInfo: acidFastInfo,
                            resultNote: resultNote,
                            drugs: []
                        };
                    }
                }
                
                // 尋找 TB 藥物敏感性結果
                if (fullBlock.includes('藥物名稱')) {
                    const drugStartIndex = lines.findIndex(line => line.includes('藥物名稱'));
                    
                    if (drugStartIndex !== -1) {
                        // 從藥物表格開始處理
                        for (let i = drugStartIndex + 1; i < lines.length; i++) {
                            let line = lines[i].trim();
                            if (!line) continue;
                            
                            let parts = line.split('\t');
                            if (parts.length >= 2 && parts[0] && parts[1]) {
                                const drug = parts[0].trim();
                                const result = parts[1].trim();
                                
                                // 檢查是否為 TB 藥物
                                if (drug.includes('Ethambutol') || 
                                    drug.includes('Isoniazid') || 
                                    drug.includes('Rifampin') || 
                                    drug.includes('Streptomycin')) {
                                    
                                    tbDrugResults.push({
                                        drug: drug,
                                        result: result
                                    });
                                }
                            }
                        }
                    }
                }
                
                // 如果找到 TB 菌和藥敏結果，加入到顯示
                if (tbOrganismFound || tbDrugResults.length > 0) {
                    // 如果只有藥敏沒有菌種，為 TB 添加一個預設key
                    const defaultKey = `${shortDate} TB ${specimen} Mycobacterium tuberculosis complex`;
                    const resultKey = Object.keys(tbResults)[0] || defaultKey;
                    
                    // 如果沒有找到菌種但有藥敏結果，創建預設條目
                    if (!tbOrganismFound && tbDrugResults.length > 0) {
                        const resultNote = fullBlock.match(/檢驗結果說明: (.*?)$/m) ? fullBlock.match(/檢驗結果說明: (.*?)$/m)[1].trim() : "";
                        
                        tbResults[defaultKey] = {
                            organism: "Mycobacterium tuberculosis complex",
                            acidFastInfo: "",
                            resultNote: resultNote,
                            drugs: []
                        };
                    }
                    
                    // 為所有TB菌株添加藥敏結果
                    Object.keys(tbResults).forEach(key => {
                        tbResults[key].drugs = tbDrugResults;
                    });
                    
                    // 生成HTML顯示
                    Object.keys(tbResults).forEach(key => {
                        let tbInfo = tbResults[key];
                        let tbHtml = `<div class="organism-container">
                            <div><strong>${shortDate} TB Culture ${specimen} ${tbInfo.organism}</strong> <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>`;
                        
                        // 添加抗酸染色信息
                        if (tbInfo.acidFastInfo) {
                            tbHtml += `<div style="padding-left: 20px; color: #666;">抗酸染色: ${tbInfo.acidFastInfo}</div>`;
                        }
                        
                        // 添加結果說明
                        if (tbInfo.resultNote) {
                            tbHtml += `<div style="padding-left: 20px; color: #6c757d; font-size: 0.9em; margin-top: 5px;">${tbInfo.resultNote}</div>`;
                        }
                        
                        // 添加藥敏結果
                        if (tbInfo.drugs && tbInfo.drugs.length > 0) {
                            tbHtml += `<div style="padding-left: 20px; margin-top: 5px;">`;
                            
                            tbInfo.drugs.forEach(drug => {
                                tbHtml += `<span class="antibiotic-result">
                                    <span class="drug-name">${drug.drug}</span> 
                                    <span class="sensitivity-${drug.result}">${drug.result}</span>
                                </span>`;
                            });
                            
                            tbHtml += `</div>`;
                        }
                        
                        tbHtml += `</div>`;
                        normalResults[key] = tbHtml;
                    });
                }
            }
            
            // 處理無生長(No Growth)結果
            if (fullBlock.includes('Blood Culture') && fullBlock.includes('No Growth')) {
                const key = `${shortDate} B/C (${sampleID})`;
                noGrowthResults[key] = `<div class="organism-container">
                    <div><strong>${shortDate} B/C No Growth</strong> <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>
                </div>`;
            }
            
            // 處理 Fungus 無生長結果
            if (fullBlock.includes('Fungus Culture') && fullBlock.includes('negative')) {
                const key = `${shortDate} Fungus ${specimen} (${sampleID})`;
                noGrowthResults[key] = `<div class="organism-container">
                    <div><strong>${shortDate} Fungus Culture ${specimen} negative</strong> <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>
                </div>`;
            }
            
            // 處理普通的Blood Culture結果(沒有藥敏結果)
            if (fullBlock.includes('Blood Culture') && !fullBlock.includes('藥物名稱') && !fullBlock.includes('No Growth')) {
                const lines = fullBlock.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    let parts = line.split('\t');
                    
                    if (parts[0] === "Blood Culture" && parts[3] && !parts[3].includes("No Growth")) {
                        const key = `${shortDate} B/C ${parts[3]} (${sampleID})`;
                        const resultNote = fullBlock.match(/檢驗結果說明: (.*?)$/m) ? fullBlock.match(/檢驗結果說明: (.*?)$/m)[1] : "";
                        normalResults[key] = `<div class="organism-container">
                            <div><strong>${shortDate} B/C ${parts[3]}</strong> "${parts[4] || ''}" <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>
                            ${resultNote ? `<div style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">${resultNote}</div>` : ''}
                        </div>`;
                    }
                }
            }
            
            // 處理細菌培養陰性結果
            if (fullBlock.includes('Colony count < 10000 CFU/mL') || 
                (fullBlock.includes('Aerobic Culture') && fullBlock.includes('negative'))) {
                const key = `${shortDate} Aerobic ${specimen} (${sampleID})`;
                const resultNote = fullBlock.match(/檢驗結果說明: (.*?)$/m) ? fullBlock.match(/檢驗結果說明: (.*?)$/m)[1] : "";
                noGrowthResults[key] = `<div class="organism-container">
                    <div><strong>${shortDate} Aerobic Culture ${specimen} negative/insignificant</strong> <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>
                    ${resultNote ? `<div style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">${resultNote}</div>` : ''}
                </div>`;
            }
            
            // 處理藥敏測試結果
            if (fullBlock.includes('藥物名稱') && (
                fullBlock.includes('Aerobic Culture') || 
                fullBlock.includes('Blood Culture') || 
                fullBlock.includes('Anaerobic Cultu')
            )) {
                let processedData = processAntibioticBlock(fullBlock);
                if (processedData.htmlResults) {
                    const cultureType = fullBlock.includes('Blood Culture') ? 'B/C' : 
                                      fullBlock.includes('Aerobic Culture') ? 'Aerobic' : 'Anaerobic';
                    
                    // 為每個細菌單獨創建結果條目
                    processedData.organisms.forEach(org => {
                        const key = `${shortDate} ${cultureType} ${org.name} (${sampleID})`;
                        
                        // 為每個細菌單獨創建HTML
                        let organismHtml = `<div class="organism-container">
                            <div><strong>${shortDate} ${cultureType} ${specimen} ${org.name}</strong> "${org.growth || ''}" <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>`;
                        
                        // 獲取此細菌的藥敏結果
                        const orgResults = processedData.antibioticResults.filter(r => r.organism === org.name);
                        
                        if (orgResults.length > 0) {
                            organismHtml += `<div style="padding-left: 20px; margin-top: 5px;">`;
                            
                            orgResults.forEach(r => {
                                organismHtml += `<span class="antibiotic-result">
                                    <span class="drug-name">${r.drug}</span> 
                                    <span class="sensitivity-${r.result}">${r.result}</span>
                                </span>`;
                            });
                            
                            organismHtml += `</div>`;
                        }
                        
                        organismHtml += `</div>`;
                        antibioticResults[key] = organismHtml;
                    });
                }
            }
            
            // 處理MIC數據
            if (fullBlock.includes('MIC') && fullBlock.includes('藥物名稱')) {
                let processedData = processMICBlock(fullBlock);
                if (processedData.htmlResults) {
                    processedData.organisms.forEach(org => {
                        const key = `${shortDate} MIC ${org.name} (${sampleID})`;
                        
                        // 為每個細菌單獨創建HTML
                        let organismHtml = `<div class="organism-container">
                            <div><strong>${shortDate} MIC ${specimen} ${org.name}</strong> "${org.growth || ''}" <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>`;
                        
                        // 獲取此細菌的MIC結果
                        const orgResults = processedData.micResults.filter(r => r.organism === org.name);
                        
                        if (orgResults.length > 0) {
                            organismHtml += `<div style="padding-left: 20px; margin-top: 5px;">`;
                            
                            orgResults.forEach(r => {
                                organismHtml += `<span class="antibiotic-result">
                                    <span class="drug-name">${r.drug}</span>
                                    <span class="sensitivity-${r.result}">${r.result}</span>
                                    ${r.micValue ? `<span class="mic-value"> ${r.micValue}</span>` : ''}
                                </span>`;
                            });
                            
                            organismHtml += `</div>`;
                        }
                        
                        organismHtml += `</div>`;
                        antibioticResults[key] = organismHtml;
                    });
                }
            }
            
            // 處理一般微生物結果 (沒有藥敏測試)
            if (!fullBlock.includes('TB Culture') && !fullBlock.includes('分枝桿菌培養')) {
                const lines = fullBlock.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    let parts = line.split('\t');
                    
                    // 處理好氧培養結果
                    if (parts[0] === "Aerobic Culture" && parts[3] && !lines.some(l => l.includes('藥物名稱'))) {
                        const key = `${shortDate} Aerobic ${parts[3]} (${sampleID})`;
                        normalResults[key] = `<div class="organism-container">
                            <div><strong>${shortDate} Aerobic ${specimen} ${parts[3]}</strong> "${parts[4] || ''}" <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>
                        </div>`;
                    }
                    
                    // 處理厭氧培養結果
                    if (parts[0] === "Anaerobic Cultu" && parts[3] && !lines.some(l => l.includes('藥物名稱'))) {
                        const key = `${shortDate} Anaerobic ${parts[3]} (${sampleID})`;
                        normalResults[key] = `<div class="organism-container">
                            <div><strong>${shortDate} Anaerobic ${specimen} ${parts[3]}</strong> "${parts[4] || ''}" <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>
                        </div>`;
                    }
                    
                    // 處理真菌培養結果
                    if (parts[0] === "Fungus Culture" && parts[3] && !parts[3].includes("negative")) {
                        const key = `${shortDate} Fungus ${parts[3]} (${sampleID})`;
                        normalResults[key] = `<div class="organism-container">
                            <div><strong>${shortDate} Fungus ${specimen} ${parts[3]}</strong> "${parts[4] || ''}" <span style="color: #666; font-size: 0.9em;">(${sampleID})</span></div>
                        </div>`;
                    }
                }
            }
        });
        
        // 按日期排序所有結果
        const allKeys = [
            ...Object.keys(noGrowthResults),
            ...Object.keys(antibioticResults),
            ...Object.keys(normalResults)
        ].sort((a, b) => {
            // 提取日期部分
            const dateA = a.split(' ')[0];
            const dateB = b.split(' ')[0];
            
            // 提取月和日
            const [monthA, dayA] = dateA.split('-').map(n => parseInt(n, 10));
            const [monthB, dayB] = dateB.split('-').map(n => parseInt(n, 10));
            
            // 處理跨年邏輯 - 11月和12月可能是去年的日期
            const currentMonth = new Date().getMonth() + 1; // 當前月份(1-12)
            const isLastYearA = monthA > 10 && currentMonth < 4;
            const isLastYearB = monthB > 10 && currentMonth < 4;
            
            if (isLastYearA && !isLastYearB) {
                return 1; // A是去年的，應該排在後面
            }
            if (!isLastYearA && isLastYearB) {
                return -1; // B是去年的，應該排在後面
            }
            
            // 同年比較：先比較月份，再比較日期
            if (monthA !== monthB) {
                return monthB - monthA;
            }
            return dayB - dayA;
        });
        
        // 顯示結果
        allKeys.forEach(key => {
            // 優先顯示藥敏結果
            if (antibioticResults[key]) {
                htmlContent += antibioticResults[key];
            } 
            // 然後是No Growth結果
            else if (noGrowthResults[key]) {
                htmlContent += noGrowthResults[key];
            } 
            // 最後是普通結果
            else if (normalResults[key]) {
                htmlContent += normalResults[key];
            }
        });
        
        microbiologyDiv.innerHTML += htmlContent;
    } else {
        microbiologyDiv.innerHTML = '<p>無微生物檢查結果</p>';
    }
}

// 修改 processTBData 函數以支持日期時間和收件編號
function processTBData(block) {
    let specimen = extractSpecimen(block);
    
    // 提取日期時間和收件編號信息
    let sampleDateTime = block.match(/採檢時間:\s*(\d{4}\/\d{2}\/\d{2})\s*(\d{1,2}:\d{2})/);
    let sampleDate = block.match(/採檢時間:\s*(\d{4}\/\d{2}\/\d{2})/);
    let shortDate = sampleDate ? sampleDate[1].slice(5).replace('/', '-') : "";
    let fullDate = sampleDate ? sampleDate[1] : "";
    let sampleTime = sampleDateTime ? sampleDateTime[2] : "";
    let fullDateTime = sampleDateTime ? `${sampleDateTime[1]} ${sampleDateTime[2]}` : fullDate;
    let datetime = sampleTime ? `${shortDate} ${sampleTime}` : shortDate;
    
    // 提取收件編號
    let sampleID = extractSampleID(block);
    
    let tbOrganisms = [];
    let tbDrugs = [];
    
    const lines = block.split('\n');
    
    // 提取 TB 菌種信息
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;
        
        let parts = line.split('\t');
        
        if ((parts[0] === "TB Culture" || parts[0] === "分枝桿菌培養及抗酸性染色") && parts[3]) {
            tbOrganisms.push({
                name: parts[3],
                acidFastInfo: parts[5] || "",
                specimen: specimen,
                datetime: datetime,
                sampleTime: sampleTime,
                sampleID: sampleID
            });
        }
    }
    
    // 提取 TB 藥敏結果
    if (block.includes('藥物名稱')) {
        const drugStartIndex = lines.findIndex(line => line.includes('藥物名稱'));
        
        if (drugStartIndex !== -1) {
            // 從藥物表格開始處理
            for (let i = drugStartIndex + 1; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;
                
                let parts = line.split('\t');
                if (parts.length >= 2 && parts[0] && parts[1]) {
                    // 藥物名稱可能包含濃度信息，例如 "Ethambutol (10ug/mL)"
                    const drug = parts[0].trim();
                    const result = parts[1].trim();
                    
                    // 提取基本藥物名稱和濃度信息
                    let baseDrugName = drug;
                    let concentration = "";
                    
                    // 檢查是否包含濃度信息 (括號內)
                    const concentrationMatch = drug.match(/(.+?)\s*\(([^)]+)\)/);
                    if (concentrationMatch) {
                        baseDrugName = concentrationMatch[1].trim();
                        concentration = concentrationMatch[2].trim();
                    }
                    
                    // 檢查是否為 TB 藥物
                    if (baseDrugName.includes('Ethambutol') || 
                        baseDrugName.includes('Isoniazid') || 
                        baseDrugName.includes('Rifampin') || 
                        baseDrugName.includes('Streptomycin') ||
                        baseDrugName.includes('Pyrazinamide')) {
                        
                        tbDrugs.push({
                            drug: drug,                         // 保留原始完整藥名（包含濃度）
                            baseDrugName: baseDrugName,         // 基本藥物名稱（不含濃度）
                            concentration: concentration,       // 濃度信息
                            result: result,
                            organism: tbOrganisms.length > 0 ? tbOrganisms[0].name : "Mycobacterium tuberculosis complex",
                            testType: 'TB',
                            specimen: specimen,
                            date: fullDate,
                            shortDate: shortDate,
                            datetime: datetime,
                            sampleTime: sampleTime,
                            sampleID: sampleID,
                            fullDateTime: fullDateTime
                        });
                    }
                }
            }
        }
    }
    
    // 如果沒有找到菌種但有藥敏結果，創建預設條目
    if (tbOrganisms.length === 0 && tbDrugs.length > 0) {
        tbOrganisms.push({
            name: "Mycobacterium tuberculosis complex",
            acidFastInfo: "",
            specimen: specimen,
            datetime: datetime,
            sampleTime: sampleTime,
            sampleID: sampleID
        });
    }
    
    // 生成HTML格式的結果
    let htmlResults = '';
    if (tbOrganisms.length > 0) {
        const resultNote = block.match(/檢驗結果說明: (.*?)$/m) ? block.match(/檢驗結果說明: (.*?)$/m)[1].trim() : "";
        
        htmlResults += `<div class="organism-container">
            <div><strong>${datetime} TB Culture ${specimen} ${tbOrganisms[0].name}</strong></div>`;
        
        // 添加抗酸染色信息
        if (tbOrganisms[0].acidFastInfo) {
            htmlResults += `<div style="padding-left: 20px; color: #666;">抗酸染色: ${tbOrganisms[0].acidFastInfo}</div>`;
        }
        
        // 添加結果說明
        if (resultNote) {
            htmlResults += `<div style="padding-left: 20px; color: #6c757d; font-size: 0.9em; margin-top: 5px;">${resultNote}</div>`;
        }
        
        // 添加藥敏結果
        if (tbDrugs.length > 0) {
            htmlResults += `<div style="padding-left: 20px; margin-top: 5px;">`;
            
            tbDrugs.forEach(drug => {
                htmlResults += `<span class="antibiotic-result">
                    <span class="drug-name">${drug.drug}</span> 
                    <span class="sensitivity-${drug.result}">${drug.result}</span>
                </span>`;
            });
            
            htmlResults += `</div>`;
        }
        
        htmlResults += `</div>`;
    }
    
    // 為了保持與原來邏輯一致，我們仍然返回原始的純文本結果用於文字Tab
    let formattedResults = [];
    if (tbOrganisms.length > 0) {
        formattedResults.push(`TB Culture ${specimen} ${tbOrganisms[0].name}:`);
        tbDrugs.forEach(drug => {
            formattedResults.push(`${drug.drug} ${drug.result}`);
        });
    }
    
    return {
        results: formattedResults.join(' '),
        htmlResults: htmlResults,
        organisms: tbOrganisms,
        tbDrugs: tbDrugs,
        specimen: specimen
    };
}

// 顯示抗生素敏感性結果
function displayAntibioticResults(organism) {
    const resultsContainer = document.getElementById('antibioticResults');
    resultsContainer.innerHTML = '';
    
    // 篩選選定微生物的藥敏結果
    const organismResults = allAntibioticResults.filter(item => item.organism === organism);
    
    if (organismResults.length === 0) {
        resultsContainer.innerHTML = '<p>無此微生物的藥敏結果</p>';
        return;
    }
    
    // 獲取此微生物的所有信息，按日期排序
    const organismInfoList = allOrganisms
        .filter(o => o.name === organism)
        .sort((a, b) => new Date(b.date) - new Date(a.date)); // 降序排列，最新日期在前
    
    // 使用最新的微生物信息
    const latestInfo = organismInfoList[0] || organismResults[0];
    
    // 添加微生物基本信息標題
    const infoDiv = document.createElement('div');
    infoDiv.className = 'organism-info';
    
    // 特別處理TB微生物的顯示
    const isTB = latestInfo.testType === 'TB' || organismResults.some(r => r.testType === 'TB');
    
    infoDiv.innerHTML = `
        <h4>${organism} ${isTB ? '<span style="color:#c62828;">(結核菌)</span>' : ''}</h4>
        ${latestInfo ? `
            <p>最近檢驗日：${latestInfo.date || '未知'}</p>
            <p>檢驗次數：${organismInfoList.length || '1'}次</p>
            <p>檢體：${latestInfo.specimen || '未知'}</p>
        ` : ''}
    `;
    resultsContainer.appendChild(infoDiv);
    
    // 按日期分組藥敏結果
    const resultsByDate = {};
    organismResults.forEach(result => {
        if (!resultsByDate[result.shortDate]) {
            resultsByDate[result.shortDate] = {
                results: [],
                testType: result.testType,
                specimen: result.specimen,
                date: result.date,
                shortDate: result.shortDate,
                // 查找對應日期的生長情況
                growth: organismInfoList.find(o => o.shortDate === result.shortDate)?.growth || ''
            };
        }
        resultsByDate[result.shortDate].results.push(result);
    });
    
    // 獲取日期數組並按時間降序排序（最新的在前面）
    const dates = Object.keys(resultsByDate).sort((a, b) => {
        const dateA = resultsByDate[a].date;
        const dateB = resultsByDate[b].date;
        return new Date(dateB) - new Date(dateA);
    });
    
    // 按日期順序顯示結果
    dates.forEach(shortDate => {
        const dateInfo = resultsByDate[shortDate];
        
        // 創建日期分組容器
        const dateGroup = document.createElement('div');
        dateGroup.className = 'date-group';
        dateGroup.style.marginTop = '20px';
        dateGroup.style.borderTop = '1px solid #e0e0e0';
        dateGroup.style.paddingTop = '15px';
        
        // 添加日期標題，TB測試特別顯示
        const dateHeader = document.createElement('div');
        dateHeader.className = 'date-header';
        dateHeader.style.marginBottom = '10px';
        dateHeader.style.fontWeight = 'bold';
        dateHeader.style.fontSize = '16px';
        
        // 特別處理TB測試的顯示標題
        if (dateInfo.testType === 'TB') {
            dateHeader.innerHTML = `
                <span style="color: #c62828;">${dateInfo.date}</span> 
                <span style="color: #555; margin-left: 10px;">TB Culture ${dateInfo.specimen}</span>
            `;
        } else {
            dateHeader.innerHTML = `
                <span style="color: #1e88e5;">${dateInfo.date}</span> 
                <span style="color: #555; margin-left: 10px;">${dateInfo.testType} ${dateInfo.specimen}</span>
                ${dateInfo.growth ? `<span style="color: #777; margin-left: 10px; font-style: italic;">"${dateInfo.growth}"</span>` : ''}
            `;
        }
        dateGroup.appendChild(dateHeader);
        
        // 將藥物按分類組織
        const drugsByClass = {};
        
        // 為TB測試創建特殊藥物分類
        if (dateInfo.testType === 'TB') {
            drugsByClass["First-line Anti-TB Drugs"] = [];
            drugsByClass["Second-line Anti-TB Drugs"] = [];
        } else {
            // 初始化所有藥物分類
            Object.keys(antibioticClasses).forEach(className => {
                drugsByClass[className] = [];
            });
        }
        
        // 分類藥物
        dateInfo.results.forEach(result => {
            let classified = false;
            
            // TB藥物特殊分類
            if (dateInfo.testType === 'TB') {
                // 第一線TB藥物
                if (result.drug.includes('Isoniazid') || 
                    result.drug.includes('Rifampin') || 
                    result.drug.includes('Ethambutol') || 
                    result.drug.includes('Pyrazinamide')) {
                    drugsByClass["First-line Anti-TB Drugs"].push(result);
                    classified = true;
                } 
                // 第二線TB藥物
                else if (result.drug.includes('Streptomycin') || 
                         result.drug.includes('Kanamycin') || 
                         result.drug.includes('Amikacin') || 
                         result.drug.includes('Capreomycin') || 
                         result.drug.includes('Moxifloxacin') || 
                         result.drug.includes('Levofloxacin') || 
                         result.drug.includes('Cycloserine') || 
                         result.drug.includes('Para-aminosalicylic')) {
                    drugsByClass["Second-line Anti-TB Drugs"].push(result);
                    classified = true;
                }
            } else {
                // 普通藥物分類
                for (const [className, drugs] of Object.entries(antibioticClasses)) {
                    if (drugs.some(drug => result.drug.includes(drug))) {
                        drugsByClass[className].push(result);
                        classified = true;
                        break;
                    }
                }
            }
            
            // 未分類的藥物放到"Others"
            if (!classified) {
                if (!drugsByClass["Others"]) {
                    drugsByClass["Others"] = [];
                }
                drugsByClass["Others"].push(result);
            }
        });
        
        // 創建此日期的藥物分類卡片
        for (const [className, drugs] of Object.entries(drugsByClass)) {
            // 跳過沒有藥物的分類
            if (drugs.length === 0) continue;
            
            // 創建分類卡片
            const classCard = document.createElement('div');
            classCard.className = 'antibiotic-class';
            classCard.style.marginBottom = '15px';
            
            // 添加分類標題
            const classHeader = document.createElement('div');
            classHeader.className = 'class-header';
            classHeader.textContent = className;
            classCard.appendChild(classHeader);
            
            // 添加藥物列表
            const drugList = document.createElement('div');
            drugList.className = 'antibiotic-list';
            
            drugs.forEach(drug => {
                const drugItem = document.createElement('div');
                drugItem.className = 'antibiotic-item';
                
                // 藥物名稱
                const drugName = document.createElement('span');
                drugName.className = 'antibiotic-name';
                drugName.textContent = drug.drug;
                drugItem.appendChild(drugName);
                
                // 敏感性標籤
                const sensitivityBadge = document.createElement('span');
                sensitivityBadge.className = `sensitivity-badge sensitivity-${drug.result}`;
                sensitivityBadge.textContent = drug.result;
                drugItem.appendChild(sensitivityBadge);
                
                // 添加MIC值（如果有）
                if (drug.micValue) {
                    const micValue = document.createElement('span');
                    micValue.className = 'mic-value';
                    micValue.textContent = drug.micValue;
                    drugItem.appendChild(micValue);
                }
                
                drugList.appendChild(drugItem);
            });
            
            classCard.appendChild(drugList);
            dateGroup.appendChild(classCard);
        }
        
        resultsContainer.appendChild(dateGroup);
    });
    
    // 如果有多次檢測，添加陽性率分析
    if (dates.length > 1) {
        addResistanceAnalysis(organism, organismResults);
    }
}

// 添加藥物耐藥性分析功能
function addResistanceAnalysis(organism, allResults) {
    const resultsContainer = document.getElementById('antibioticResults');
    
    // 創建分析容器
    const analysisDiv = document.createElement('div');
    analysisDiv.className = 'resistance-analysis';
    analysisDiv.style.marginTop = '30px';
    analysisDiv.style.padding = '15px';
    analysisDiv.style.backgroundColor = '#f8f9fa';
    analysisDiv.style.borderRadius = '8px';
    
    // 添加分析標題
    const analysisTitle = document.createElement('h5');
    analysisTitle.textContent = '藥敏趨勢分析';
    analysisTitle.style.marginBottom = '15px';
    analysisTitle.style.color = '#343a40';
    analysisDiv.appendChild(analysisTitle);
    
    // 獲取所有藥物名稱
    const allDrugs = [...new Set(allResults.map(r => r.drug))];
    
    // 對每種藥物計算耐藥性情況
    const drugAnalysis = document.createElement('div');
    drugAnalysis.className = 'drug-analysis';
    
    allDrugs.forEach(drug => {
        // 獲取此藥物的所有結果
        const drugResults = allResults.filter(r => r.drug === drug);
        if (drugResults.length < 2) return; // 只有一次檢測的藥物跳過
        
        // 計算各類結果的數量
        const counts = {
            S: drugResults.filter(r => r.result === 'S').length,
            I: drugResults.filter(r => r.result === 'I').length,
            R: drugResults.filter(r => r.result === 'R').length,
            SDD: drugResults.filter(r => r.result === 'SDD').length,
            D: drugResults.filter(r => r.result === 'D').length,
            total: drugResults.length
        };
        
        // 計算耐藥率
        const resistanceRate = ((counts.R + counts.I) / counts.total * 100).toFixed(1);
        
        // 創建藥物分析行
        const drugRow = document.createElement('div');
        drugRow.className = 'drug-row';
        drugRow.style.display = 'flex';
        drugRow.style.marginBottom = '8px';
        drugRow.style.alignItems = 'center';
        
        // 藥物名稱
        const drugName = document.createElement('div');
        drugName.className = 'drug-name';
        drugName.style.width = '200px';
        drugName.style.fontFamily = 'monospace';
        drugName.textContent = drug;
        drugRow.appendChild(drugName);
        
        // 藥敏結果分布
        const resultBar = document.createElement('div');
        resultBar.className = 'result-bar';
        resultBar.style.display = 'flex';
        resultBar.style.flexGrow = '1';
        resultBar.style.height = '24px';
        resultBar.style.borderRadius = '4px';
        resultBar.style.overflow = 'hidden';
        
        // 添加不同結果的部分
        if (counts.S > 0) {
            const sPart = document.createElement('div');
            sPart.style.width = `${counts.S / counts.total * 100}%`;
            sPart.style.backgroundColor = '#28a745';
            sPart.style.height = '100%';
            resultBar.appendChild(sPart);
        }
        
        if (counts.I > 0) {
            const iPart = document.createElement('div');
            iPart.style.width = `${counts.I / counts.total * 100}%`;
            iPart.style.backgroundColor = '#fd7e14';
            iPart.style.height = '100%';
            resultBar.appendChild(iPart);
        }
        
        if (counts.R > 0) {
            const rPart = document.createElement('div');
            rPart.style.width = `${counts.R / counts.total * 100}%`;
            rPart.style.backgroundColor = '#dc3545';
            rPart.style.height = '100%';
            resultBar.appendChild(rPart);
        }
        
        drugRow.appendChild(resultBar);
        
        // 耐藥率
        const rateDiv = document.createElement('div');
        rateDiv.className = 'resistance-rate';
        rateDiv.style.width = '80px';
        rateDiv.style.textAlign = 'right';
        rateDiv.style.paddingLeft = '10px';
        rateDiv.style.fontWeight = 'bold';
        
        // 設置顏色
        let color = '#28a745'; // 默認綠色
        if (resistanceRate > 30) color = '#fd7e14'; // 超過30%橙色
        if (resistanceRate > 50) color = '#dc3545'; // 超過50%紅色
        
        rateDiv.style.color = color;
        rateDiv.textContent = `${resistanceRate}%`;
        drugRow.appendChild(rateDiv);
        
        drugAnalysis.appendChild(drugRow);
    });
    
    // 如果有藥物分析，才添加到結果
    if (drugAnalysis.children.length > 0) {
        analysisDiv.appendChild(drugAnalysis);
        
        // 添加分析說明
        const analysisNote = document.createElement('div');
        analysisNote.className = 'analysis-note';
        analysisNote.style.marginTop = '15px';
        analysisNote.style.fontSize = '13px';
        analysisNote.style.color = '#6c757d';
        analysisNote.textContent = '顏色表示敏感性：綠色(S)、橙色(I)、紅色(R)，百分比為累計耐藥率(R+I)';
        analysisDiv.appendChild(analysisNote);
        
        resultsContainer.appendChild(analysisDiv);
    }
}

// 在表格中顯示抗生素敏感性結果 (改進版) - 支持按微生物+檢體+序號+時間+樣本ID篩選
function displayAntibioticResultsAsTable(organism, specimen, number, datetime, sampleID) {
    const resultsContainer = document.getElementById('antibioticResults');
    resultsContainer.innerHTML = '';
    
    // 篩選選定微生物+檢體+序號+時間+樣本ID的藥敏結果
    let organismResults = allAntibioticResults.filter(item => 
        item.organism === organism && 
        item.specimen === specimen && 
        (item.number == number || (!item.number && number === '0')) // 註意這裡使用==來比較，因為number可能是字符串
    );
    
    // 如果提供了日期時間和樣本ID，則進一步過濾
    if (datetime) {
        organismResults = organismResults.filter(item => 
            (item.datetime === datetime) || // 精確匹配完整日期時間
            (item.shortDate === datetime) || // 匹配簡短日期（向後兼容）
            (item.sampleTime && `${item.shortDate} ${item.sampleTime}` === datetime) // 匹配構造的日期時間
        );
    }
    
    if (sampleID) {
        organismResults = organismResults.filter(item => item.sampleID === sampleID);
    }
    
    if (organismResults.length === 0) {
        resultsContainer.innerHTML = '<p>無此微生物的藥敏結果</p>';
        return;
    }
    
    // 獲取此微生物+檢體+序號+時間+樣本ID的所有信息，按日期排序
    let organismInfoList = allOrganisms.filter(o => 
        o.name === organism && 
        o.specimen === specimen && 
        (o.number == number || (!o.number && number === '0'))
    );
    
    // 如果提供了日期時間和樣本ID，則進一步過濾有機體信息
    if (datetime) {
        organismInfoList = organismInfoList.filter(o => 
            (o.datetime === datetime) ||
            (o.shortDate === datetime) ||
            (o.sampleTime && `${o.shortDate} ${o.sampleTime}` === datetime)
        );
    }
    
    if (sampleID) {
        organismInfoList = organismInfoList.filter(o => o.sampleID === sampleID);
    }
    
    // 按日期時間排序（降序）
    organismInfoList = organismInfoList.sort((a, b) => {
        // 如果有日期時間，則使用它
        const dateA = a.datetime ? new Date(a.datetime.replace(' ', 'T')) : new Date(a.date);
        const dateB = b.datetime ? new Date(b.datetime.replace(' ', 'T')) : new Date(b.date);
        return dateB - dateA; // 降序排列，最新日期在前
    });
    
    // 使用最新的微生物信息
    const latestInfo = organismInfoList[0] || organismResults[0];
    
    // 添加微生物基本信息標題
    const infoDiv = document.createElement('div');
    infoDiv.className = 'organism-info';
    
    // 特別處理TB微生物的顯示
    const isTB = latestInfo.testType === 'TB' || organismResults.some(r => r.testType === 'TB');
    
    // 序號文本
    const numberText = number && number !== '0' ? ` (序號:${number})` : '';
    
    // 收件編號文本
    const sampleIDText = sampleID ? ` (收件編號:${sampleID})` : '';
    
    // 檢查是否有時間信息
    const timeStr = latestInfo.sampleTime || (latestInfo.datetime && latestInfo.datetime.includes(' ') ? 
        latestInfo.datetime.split(' ')[1] : '');
    const timeText = timeStr ? ` ${timeStr}` : '';
    
    infoDiv.innerHTML = `
        <h4>${organism}${numberText} ${isTB ? '<span style="color:#c62828;">(結核菌)</span>' : ''}</h4>
        ${latestInfo ? `
            <p>檢驗日期：${latestInfo.date}${timeText}</p>
            <p>檢體：${latestInfo.specimen || '未知'}</p>
            <p>檢測類型：${latestInfo.testType || '未知'}</p>
            ${sampleIDText ? `<p>收件編號：${sampleID}</p>` : ''}
        ` : ''}
    `;
    resultsContainer.appendChild(infoDiv);
      
    // 按日期分組藥敏結果 - 使用datetime如果可用
    const resultsByDate = {};
    organismResults.forEach(result => {
        // 創建日期鍵，優先使用datetime
        const dateKey = result.datetime || result.shortDate;
        
        if (!resultsByDate[dateKey]) {
            resultsByDate[dateKey] = {
                results: [],
                testType: result.testType,
                specimen: result.specimen,
                date: result.date,
                shortDate: result.shortDate,
                datetime: result.datetime || result.shortDate,
                sampleTime: result.sampleTime || '',
                // 查找對應日期的生長情況
                growth: organismInfoList.find(o => 
                    (o.datetime && o.datetime === result.datetime) || 
                    (o.shortDate === result.shortDate)
                )?.growth || ''
            };
        }
        resultsByDate[dateKey].results.push(result);
    });
    
    // 獲取日期數組並按時間降序排序（最新的在前面）
    const dates = Object.keys(resultsByDate).sort((a, b) => {
        // 處理日期時間字符串，將其轉換為可比較的格式
        const dateA = a.includes(' ') ? new Date(a.replace(' ', 'T')) : new Date(resultsByDate[a].date);
        const dateB = b.includes(' ') ? new Date(b.replace(' ', 'T')) : new Date(resultsByDate[b].date);
        return dateB - dateA;
    });
    
    // 創建一個收集所有抗生素的集合
    const allAntibiotics = new Set();
    
    // 收集所有涉及的抗生素
    organismResults.forEach(result => {
        allAntibiotics.add(result.drug);
    });
    
    // 將抗生素按類別分組
    const antibioticsByClass = {};
    
    // 按抗生素類別收集藥物
    Object.keys(antibioticClasses).forEach(className => {
        antibioticsByClass[className] = [];
        antibioticClasses[className].forEach(drug => {
            // 檢查所有藥物集合中是否存在完全匹配的藥物
            if (allAntibiotics.has(drug)) {
                antibioticsByClass[className].push(drug);
            } else {
                // 嘗試使用基本藥物名稱匹配
                const baseDrugName = drug;
                // 檢查集合中是否有藥物以此基本名稱開頭
                for (const fullDrug of allAntibiotics) {
                    if (getBaseDrugName(fullDrug) === baseDrugName) {
                        antibioticsByClass[className].push(fullDrug);
                    }
                }
            }
        });
    });
    
    // 創建表格
    const table = document.createElement('table');
    table.className = 'sensitivity-table';
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.fontSize = '13px';
    table.style.marginTop = '15px';
    table.style.marginBottom = '20px';
    
    // 創建表頭
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headerRow.style.backgroundColor = '#f1f1f1';
    
    // 第一列：藥物名稱
    const drugHeaderCell = document.createElement('th');
    drugHeaderCell.textContent = '抗生素類別 / 日期';
    drugHeaderCell.style.padding = '8px';
    drugHeaderCell.style.border = '1px solid #ddd';
    drugHeaderCell.style.textAlign = 'left';
    drugHeaderCell.style.position = 'sticky';
    drugHeaderCell.style.left = '0';
    drugHeaderCell.style.backgroundColor = '#f1f1f1';
    drugHeaderCell.style.zIndex = '10';
    headerRow.appendChild(drugHeaderCell);
    
    // 為每個日期創建一個列標題
    dates.forEach(dateKey => {
        const dateInfo = resultsByDate[dateKey];
        const dateHeaderCell = document.createElement('th');
        
        // 顯示完整日期和時間（如果有）
        const displayDate = dateInfo.datetime && dateInfo.datetime.includes(' ') ? 
            dateInfo.datetime : dateInfo.date;
        
        dateHeaderCell.innerHTML = `
            <div style="font-size: 12px; font-weight: bold;">${displayDate}</div>
            <div style="font-size: 11px; color: #666;">${dateInfo.testType} ${dateInfo.specimen}</div>
            ${dateInfo.growth ? `<div style="font-size: 11px; color: #777; font-style: italic;">"${dateInfo.growth}"</div>` : ''}
        `;
        dateHeaderCell.style.padding = '8px';
        dateHeaderCell.style.border = '1px solid #ddd';
        dateHeaderCell.style.textAlign = 'center';
        dateHeaderCell.style.minWidth = '120px';
        headerRow.appendChild(dateHeaderCell);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // 創建表格內容
    const tbody = document.createElement('tbody');
    
    // 為每個抗生素類別創建行
    Object.keys(antibioticsByClass).forEach(className => {
        const drugsInClass = antibioticsByClass[className];
        
        // 如果這個類別沒有藥物，跳過
        if (drugsInClass.length === 0) return;
        
        // 創建類別標題行
        const classRow = document.createElement('tr');
        classRow.style.backgroundColor = '#f8f9fa';
        
        const classNameCell = document.createElement('td');
        classNameCell.textContent = className;
        classNameCell.colSpan = dates.length + 1;
        classNameCell.style.padding = '6px';
        classNameCell.style.border = '1px solid #ddd';
        classNameCell.style.fontWeight = 'bold';
        classNameCell.style.position = 'sticky';
        classNameCell.style.left = '0';
        classNameCell.style.backgroundColor = '#f8f9fa';
        classRow.appendChild(classNameCell);
        
        tbody.appendChild(classRow);
        
        // 為每個藥物創建行
        drugsInClass.forEach(drug => {
            const drugRow = document.createElement('tr');
            
            // 藥物名稱列
            const drugNameCell = document.createElement('td');
            // 檢查是否是TB藥物且包含濃度信息
            const isTBDrugWithConcentration = drug.match(/(.+?)\s*\(([^)]+)\)/);
            if (isTBDrugWithConcentration) {
                const baseName = isTBDrugWithConcentration[1].trim();
                const concentration = isTBDrugWithConcentration[2].trim();
                // 使用更細化的顯示格式
                drugNameCell.innerHTML = `<span>${baseName}</span> <span style="font-size:9px; color:#777;">(${concentration})</span>`;
            } else {
                drugNameCell.textContent = drug;
            }
            drugNameCell.style.padding = '6px';
            drugNameCell.style.border = '1px solid #ddd';
            drugNameCell.style.fontFamily = 'monospace';
            drugNameCell.style.fontSize = '12px';
            drugNameCell.style.position = 'sticky';
            drugNameCell.style.left = '0';
            drugNameCell.style.backgroundColor = '#fff';
            drugRow.appendChild(drugNameCell);
            
            // 為每個日期創建結果列
            dates.forEach(dateKey => {
                const dateResults = resultsByDate[dateKey].results;
                const drugResult = dateResults.find(r => r.drug === drug);
                
                const resultCell = document.createElement('td');
                resultCell.style.padding = '6px';
                resultCell.style.border = '1px solid #ddd';
                resultCell.style.textAlign = 'center';
                
                if (drugResult) {
                    // 根據敏感性結果設置顏色和樣式
                    switch (drugResult.result) {
                        case 'S':
                            resultCell.style.backgroundColor = '#e8f5e9';
                            resultCell.style.color = '#2e7d32';
                            resultCell.style.fontWeight = 'bold';
                            break;
                        case 'I':
                            resultCell.style.backgroundColor = '#fff8e1';
                            resultCell.style.color = '#f57f17';
                            resultCell.style.fontWeight = 'bold';
                            break;
                        case 'R':
                            resultCell.style.backgroundColor = '#ffebee';
                            resultCell.style.color = '#c62828';
                            resultCell.style.fontWeight = 'bold';
                            break;
                        case 'SDD':
                            resultCell.style.backgroundColor = '#e1f5fe';
                            resultCell.style.color = '#0277bd';
                            resultCell.style.fontWeight = 'bold';
                            break;
                        case 'D':
                            resultCell.style.backgroundColor = '#f3e5f5';
                            resultCell.style.color = '#6a1b9a';
                            resultCell.style.fontWeight = 'bold';
                            break;
                    }
                    
                    resultCell.textContent = drugResult.result;
                    
                    // 顯示MIC值（如果有）
                    if (drugResult.micValue) {
                        const micValue = document.createElement('div');
                        micValue.textContent = drugResult.micValue;
                        micValue.style.fontSize = '10px';
                        micValue.style.fontStyle = 'italic';
                        micValue.style.marginTop = '3px';
                        micValue.style.color = 'rgba(0,0,0,0.6)';
                        resultCell.appendChild(micValue);
                    }
                } else {
                    // 未測試的藥物顯示為淺灰色
                    resultCell.style.backgroundColor = '#f5f5f5';
                    resultCell.style.color = '#9e9e9e';
                    resultCell.textContent = '–';
                    resultCell.style.opacity = '0.5';
                }
                
                drugRow.appendChild(resultCell);
            });
            
            tbody.appendChild(drugRow);
        });
    });
    
    table.appendChild(tbody);
    resultsContainer.appendChild(table);
    
    // 添加顏色說明
    const legend = document.createElement('div');
    legend.className = 'sensitivity-legend';
    legend.style.display = 'flex';
    legend.style.flexWrap = 'wrap';
    legend.style.gap = '15px';
    legend.style.marginTop = '10px';
    legend.style.fontSize = '12px';
    
    const sensitivities = [
        { key: 'S', color: '#e8f5e9', text: '#2e7d32', label: '敏感' },
        { key: 'I', color: '#fff8e1', text: '#f57f17', label: '中間型' },
        { key: 'R', color: '#ffebee', text: '#c62828', label: '抗藥性' },
        { key: 'SDD', color: '#e1f5fe', text: '#0277bd', label: '劑量依賴的敏感性' },
        { key: 'D', color: '#f3e5f5', text: '#6a1b9a', label: '劑量依賴的敏感性' },
        { key: '–', color: '#f5f5f5', text: '#9e9e9e', label: '未測試', opacity: 0.5 }
    ];
    
    sensitivities.forEach(item => {
        const sensitivityDiv = document.createElement('div');
        sensitivityDiv.style.display = 'flex';
        sensitivityDiv.style.alignItems = 'center';
        
        const colorBox = document.createElement('span');
        colorBox.style.display = 'inline-block';
        colorBox.style.width = '14px';
        colorBox.style.height = '14px';
        colorBox.style.backgroundColor = item.color;
        colorBox.style.marginRight = '5px';
        colorBox.style.border = '1px solid #ddd';
        if (item.opacity) {
            colorBox.style.opacity = item.opacity;
        }
        
        const label = document.createElement('span');
        label.textContent = `${item.key}: ${item.label}`;
        label.style.color = item.text;
        
        sensitivityDiv.appendChild(colorBox);
        sensitivityDiv.appendChild(label);
        legend.appendChild(sensitivityDiv);
    });
    
    resultsContainer.appendChild(legend);
    
    // 如果有多次檢測，添加陽性率分析
    if (dates.length > 1) {
        addResistanceAnalysis(organism, organismResults);
    }
}

// 函數：多個微生物藥敏對比表格 (改進版) - 支持複合鍵包含序號和時間信息
function displayMultiOrganismComparison() {
    const resultsContainer = document.getElementById('antibioticResults');
    resultsContainer.innerHTML = '';
    
    // 檢查是否有足夠的藥敏結果
    if (allAntibioticResults.length === 0) {
        resultsContainer.innerHTML = '<p>無藥敏測試結果</p>';
        return;
    }
    
    // 獲取選中的微生物、檢體、序號和時間
    const selectedItems = [];
    document.querySelectorAll('.organism-button.active').forEach(button => {
        selectedItems.push({
            organism: button.getAttribute('data-organism'),
            specimen: button.getAttribute('data-specimen'),
            number: button.getAttribute('data-number') || '0',
            datetime: button.getAttribute('data-datetime') || '',
            sampleID: button.getAttribute('data-sampleid') || '',
            key: button.getAttribute('data-key')
        });
    });
    
    // 如果沒有選中的微生物，使用第一個
    if (selectedItems.length === 0) {
        const firstOrgButton = document.querySelector('.organism-button');
        if (firstOrgButton) {
            firstOrgButton.classList.add('active');
            selectedItems.push({
                organism: firstOrgButton.getAttribute('data-organism'),
                specimen: firstOrgButton.getAttribute('data-specimen'),
                number: firstOrgButton.getAttribute('data-number') || '0',
                datetime: firstOrgButton.getAttribute('data-datetime') || '',
                sampleID: firstOrgButton.getAttribute('data-sampleid') || '',
                key: firstOrgButton.getAttribute('data-key')
            });
        }
    }
    
    // 如果仍然沒有可用的微生物，顯示提示
    if (selectedItems.length === 0) {
        resultsContainer.innerHTML = '<p>請選擇要比較的微生物</p>';
        return;
    }
    
    // 添加比較說明
    const comparisonTitle = document.createElement('h4');
    comparisonTitle.textContent = '微生物藥敏對比表';
    comparisonTitle.style.marginBottom = '15px';
    resultsContainer.appendChild(comparisonTitle);
    
    // 收集所有選中微生物的藥敏結果 - 使用複合鍵進行篩選
    let selectedResults = [];
    selectedItems.forEach(item => {
        // 使用複合條件精確匹配
        const itemResults = allAntibioticResults.filter(r => 
            r.organism === item.organism && 
            r.specimen === item.specimen && 
            (r.number == item.number || (!r.number && item.number === '0'))
        );
        
        // 進一步按日期時間和樣本ID過濾
        let filteredResults = itemResults;
        if (item.datetime) {
            filteredResults = filteredResults.filter(r => 
                (r.datetime === item.datetime) || 
                (r.shortDate === item.datetime) || 
                (r.sampleTime && `${r.shortDate} ${r.sampleTime}` === item.datetime)
            );
        }
        
        if (item.sampleID) {
            filteredResults = filteredResults.filter(r => r.sampleID === item.sampleID);
        }
        
        selectedResults = [...selectedResults, ...filteredResults];
    });
    
    // 為每個選中的複合鍵組合找到最新的檢測結果
    const latestResultsByKey = {};
    
    selectedItems.forEach(item => {
        // 精確過濾此菌株的結果
        const itemResults = selectedResults.filter(r => 
            r.organism === item.organism && 
            r.specimen === item.specimen && 
            (r.number == item.number || (!r.number && item.number === '0'))
        );
        
        // 進一步按日期時間和樣本ID過濾
        let filteredResults = itemResults;
        if (item.datetime) {
            filteredResults = filteredResults.filter(r => 
                (r.datetime === item.datetime) || 
                (r.shortDate === item.datetime) || 
                (r.sampleTime && `${r.shortDate} ${r.sampleTime}` === item.datetime)
            );
        }
        
        if (item.sampleID) {
            filteredResults = filteredResults.filter(r => r.sampleID === item.sampleID);
        }
        
        // 如果過濾後有結果，使用這些結果
        if (filteredResults.length > 0) {
            // 找到最新的日期（可能都是同一日期）
            const latestDate = filteredResults[0].fullDateTime || filteredResults[0].date;
            
            // 使用日期時間和樣本ID創建唯一鍵
            const timeKey = filteredResults[0].datetime || filteredResults[0].shortDate;
            const sampleIDStr = filteredResults[0].sampleID || '';
            const uniqueKey = `${item.key}_${timeKey}_${sampleIDStr}`;
            
            latestResultsByKey[uniqueKey] = {
                results: filteredResults,
                date: latestDate,
                organism: item.organism,
                specimen: item.specimen,
                number: item.number,
                datetime: filteredResults[0].datetime || '', 
                sampleTime: filteredResults[0].sampleTime || '',
                sampleID: filteredResults[0].sampleID || '',
                testType: filteredResults[0].testType
            };
        }
    });
    
    // 收集所有涉及的抗生素
    const allAntibiotics = new Set();
    Object.values(latestResultsByKey).forEach(data => {
        data.results.forEach(result => {
            allAntibiotics.add(result.drug);
        });
    });
    
    // 創建表格
    const table = document.createElement('table');
    table.className = 'sensitivity-table';
    
    // 創建表頭
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    // 第一列：藥物名稱
    const drugHeaderCell = document.createElement('th');
    drugHeaderCell.textContent = '抗生素';
    headerRow.appendChild(drugHeaderCell);
    
    // 為每個微生物+檢體+序號+時間組合創建列標題
    selectedItems.forEach(item => {
        // 尋找匹配的結果集
        let matchingKey = null;
        for (const key in latestResultsByKey) {
            if (key.startsWith(item.key)) {
                matchingKey = key;
                break;
            }
        }
        
        if (!matchingKey || !latestResultsByKey[matchingKey]) return;
        
        const data = latestResultsByKey[matchingKey];
        const orgHeaderCell = document.createElement('th');
        
        // 獲取微生物的完整信息
        const isTB = data.testType === 'TB';
        
        // 添加序號和時間信息
        const numberText = item.number && item.number !== '0' ? `<div style="font-size: 11px; color: #444;">序號: ${item.number}</div>` : '';
        const timeText = data.sampleTime ? `<div style="font-size: 11px; color: #777;">${data.sampleTime}</div>` : '';
        const sampleIDText = data.sampleID ? `<div style="font-size: 10px; color: #999;">檢體號: ${data.sampleID}</div>` : '';
        
        orgHeaderCell.innerHTML = `
            <div style="font-size: 12px; font-weight: bold;">${data.organism}</div>
            <div style="font-size: 11px; color: #666;">${data.testType} ${data.specimen || ''}</div>
            ${numberText}
            <div style="font-size: 11px; color: #777;">
                ${data.date || ''}
            </div>
            ${sampleIDText}
            ${isTB ? '<div style="font-size: 11px; color: #c62828;">(結核菌)</div>' : ''}
        `;
        headerRow.appendChild(orgHeaderCell);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // 將抗生素按類別分組
    const antibioticsByClass = {};
    
    // 遍歷所有抗生素類別
    Object.keys(antibioticClasses).forEach(className => {
        antibioticsByClass[className] = [];
        
        // 檢查此類別中的藥物是否在結果中
        antibioticClasses[className].forEach(drug => {
            // 檢查所有藥物集合中是否存在完全匹配的藥物
            if (allAntibiotics.has(drug)) {
                antibioticsByClass[className].push(drug);
            } else {
                // 嘗試使用基本藥物名稱匹配
                const baseDrugName = drug;
                // 檢查集合中是否有藥物以此基本名稱開頭
                for (const fullDrug of allAntibiotics) {
                    if (getBaseDrugName(fullDrug) === baseDrugName) {
                        antibioticsByClass[className].push(fullDrug);
                    }
                }
            }
        });
    });
    
    // 創建表格內容
    const tbody = document.createElement('tbody');
    
    // 為每個抗生素類別創建行
    Object.keys(antibioticsByClass).forEach(className => {
        const drugsInClass = antibioticsByClass[className];
        
        // 如果這個類別沒有藥物，跳過
        if (drugsInClass.length === 0) return;
        
        // 創建類別標題行
        const classRow = document.createElement('tr');
        classRow.className = 'class-header';
        
        const classNameCell = document.createElement('td');
        classNameCell.textContent = className;
        classNameCell.colSpan = selectedItems.length + 1;
        classRow.appendChild(classNameCell);
        
        tbody.appendChild(classRow);
        
        // 為每個藥物創建行
        drugsInClass.forEach(drug => {
            const drugRow = document.createElement('tr');
            
            // 藥物名稱列
            const drugNameCell = document.createElement('td');
            // 檢查是否是TB藥物且包含濃度信息
            const isTBDrugWithConcentration = drug.match(/(.+?)\s*\(([^)]+)\)/);
            if (isTBDrugWithConcentration) {
                const baseName = isTBDrugWithConcentration[1].trim();
                const concentration = isTBDrugWithConcentration[2].trim();
                // 使用更細化的顯示格式
                drugNameCell.innerHTML = `<span>${baseName}</span> <span style="font-size:9px; color:#777;">(${concentration})</span>`;
            } else {
                drugNameCell.textContent = drug;
            }
            drugNameCell.style.fontFamily = 'monospace';
            drugRow.appendChild(drugNameCell);
            
            // 為每個微生物+檢體+序號+時間組合創建結果列
            selectedItems.forEach(item => {
                // 尋找匹配的結果集
                let matchingKey = null;
                for (const key in latestResultsByKey) {
                    if (key.startsWith(item.key)) {
                        matchingKey = key;
                        break;
                    }
                }
                
                if (!matchingKey || !latestResultsByKey[matchingKey]) {
                    // 如果沒有此微生物的數據，創建空單元格
                    const emptyCell = document.createElement('td');
                    emptyCell.className = 'untested';
                    emptyCell.textContent = '–';
                    drugRow.appendChild(emptyCell);
                    return;
                }
                
                const results = latestResultsByKey[matchingKey].results;
                const drugResult = results.find(r => r.drug === drug);
                
                const resultCell = document.createElement('td');
                
                if (drugResult) {
                    // 設置敏感性結果的樣式
                    resultCell.className = `sensitivity-${drugResult.result}`;
                    
                    // 創建主要結果標籤
                    const resultSpan = document.createElement('div');
                    resultSpan.textContent = drugResult.result;
                    resultSpan.style.fontWeight = 'bold';
                    resultCell.appendChild(resultSpan);
                    
                    // 顯示MIC值（如果有）
                    if (drugResult.micValue) {
                        const micValue = document.createElement('div');
                        micValue.textContent = drugResult.micValue;
                        micValue.style.fontSize = '10px';
                        micValue.style.fontStyle = 'italic';
                        micValue.style.marginTop = '3px';
                        resultCell.appendChild(micValue);
                    }
                } else {
                    // 未測試的藥物
                    resultCell.className = 'untested';
                    resultCell.textContent = '–';
                }
                
                drugRow.appendChild(resultCell);
            });
            
            tbody.appendChild(drugRow);
        });
    });
    
    table.appendChild(tbody);
    resultsContainer.appendChild(table);
    
    // 添加顏色說明
    const legend = document.createElement('div');
    legend.className = 'sensitivity-legend';
    legend.style.display = 'flex';
    legend.style.flexWrap = 'wrap';
    legend.style.gap = '15px';
    legend.style.marginTop = '10px';
    legend.style.fontSize = '12px';
    
    const sensitivities = [
        { key: 'S', color: '#e8f5e9', text: '#2e7d32', label: '敏感' },
        { key: 'I', color: '#fff8e1', text: '#f57f17', label: '中間型' },
        { key: 'R', color: '#ffebee', text: '#c62828', label: '抗藥性' },
        { key: 'SDD', color: '#e1f5fe', text: '#0277bd', label: '劑量依賴的敏感性' },
        { key: 'D', color: '#f3e5f5', text: '#6a1b9a', label: '劑量依賴的敏感性' },
        { key: '–', color: '#f5f5f5', text: '#9e9e9e', label: '未測試', opacity: 0.5 }
    ];
    
    sensitivities.forEach(item => {
        const sensitivityDiv = document.createElement('div');
        sensitivityDiv.style.display = 'flex';
        sensitivityDiv.style.alignItems = 'center';
        
        const colorBox = document.createElement('span');
        colorBox.style.display = 'inline-block';
        colorBox.style.width = '14px';
        colorBox.style.height = '14px';
        colorBox.style.backgroundColor = item.color;
        colorBox.style.marginRight = '5px';
        colorBox.style.border = '1px solid #ddd';
        if (item.opacity) {
            colorBox.style.opacity = item.opacity;
        }
        
        const label = document.createElement('span');
        label.textContent = `${item.key}: ${item.label}`;
        label.style.color = item.text;
        
        sensitivityDiv.appendChild(colorBox);
        sensitivityDiv.appendChild(label);
        legend.appendChild(sensitivityDiv);
    });
    
    resultsContainer.appendChild(legend);
}

// 增強微生物選擇器排序功能
function enhanceOrganismSelector() {

    // 清除之前存在的所有相關元素
    const existingButtonContainer = document.querySelector('.selector-buttons');
    if (existingButtonContainer) {
        existingButtonContainer.remove();
    }
    
    const existingSortingContainer = document.querySelector('.sorting-options');
    if (existingSortingContainer) {
        existingSortingContainer.remove();
    }
    
    // 清除可能存在的單獨比較按鈕
    const existingCompareButton = document.querySelector('.compare-button');
    if (existingCompareButton) {
        existingCompareButton.remove();
    }
    // 添加多選按鈕
    const organismSelector = document.getElementById('organismSelector');
    
    // 創建排序選項容器 - 新增
    const sortingContainer = document.createElement('div');
    sortingContainer.className = 'sorting-options';
    sortingContainer.style.display = 'flex';
    sortingContainer.style.alignItems = 'center';
    sortingContainer.style.marginBottom = '10px';
    sortingContainer.style.padding = '8px';
    sortingContainer.style.backgroundColor = '#f8f9fa';
    sortingContainer.style.borderRadius = '4px';
    
    // 添加排序標籤
    const sortLabel = document.createElement('span');
    sortLabel.textContent = '排序方式: ';
    sortLabel.style.marginRight = '10px';
    sortLabel.style.fontWeight = 'bold';
    sortingContainer.appendChild(sortLabel);
    
    // 創建排序選項
    const sortOptions = [
        { value: 'organism', label: '菌名', checked: true },
        { value: 'datetime', label: '採檢時間 (由新到舊)', checked: false },
        { value: 'datetime-asc', label: '採檢時間 (由舊到新)', checked: false }
    ];
    
    // 創建單選按鈕組
    sortOptions.forEach(option => {
        const radioContainer = document.createElement('label');
        radioContainer.style.marginRight = '15px';
        radioContainer.style.display = 'inline-flex';
        radioContainer.style.alignItems = 'center';
        radioContainer.style.cursor = 'pointer';
        
        const radioInput = document.createElement('input');
        radioInput.type = 'radio';
        radioInput.name = 'organism-sort';
        radioInput.value = option.value;
        radioInput.checked = option.checked;
        radioInput.style.marginRight = '5px';
        
        // 添加排序變更事件
        radioInput.addEventListener('change', function() {
            if (this.checked) {
                sortOrganismList(this.value);
            }
        });
        
        radioContainer.appendChild(radioInput);
        radioContainer.appendChild(document.createTextNode(option.label));
        sortingContainer.appendChild(radioContainer);
    });
    
    // 添加排序容器到選擇器前面
    organismSelector.parentNode.insertBefore(sortingContainer, organismSelector);
    
    // 創建比較按鈕
    const compareButton = document.createElement('button');
    compareButton.textContent = '比較選中的微生物';
    compareButton.className = 'compare-button';
    compareButton.style.backgroundColor = '#1e88e5';
    compareButton.style.color = 'white';
    compareButton.style.border = 'none';
    compareButton.style.borderRadius = '4px';
    compareButton.style.padding = '8px 12px';
    compareButton.style.cursor = 'pointer';
    compareButton.style.margin = '5px';
    compareButton.onclick = function() {
        // 檢查是否有多個微生物被選中
        const selectedButtons = document.querySelectorAll('.organism-button.active');
        if (selectedButtons.length <= 1) {
            alert('請選擇至少兩個微生物進行比較');
            return;
        }
        
        // 顯示比較視圖
        displayMultiOrganismComparison();
    };
    
    // 添加選擇全部和取消全部按鈕
    const selectAllButton = document.createElement('button');
    selectAllButton.textContent = '全選';
    selectAllButton.className = 'select-all-button';
    selectAllButton.style.backgroundColor = '#4caf50';
    selectAllButton.style.color = 'white';
    selectAllButton.style.border = 'none';
    selectAllButton.style.borderRadius = '4px';
    selectAllButton.style.padding = '8px 12px';
    selectAllButton.style.cursor = 'pointer';
    selectAllButton.style.margin = '5px';
    selectAllButton.onclick = function() {
        // 選中所有微生物
        document.querySelectorAll('.organism-button').forEach(button => {
            button.classList.add('active');
        });
    };
    
    const deselectAllButton = document.createElement('button');
    deselectAllButton.textContent = '取消全選';
    deselectAllButton.className = 'deselect-all-button';
    deselectAllButton.style.backgroundColor = '#f44336';
    deselectAllButton.style.color = 'white';
    deselectAllButton.style.border = 'none';
    deselectAllButton.style.borderRadius = '4px';
    deselectAllButton.style.padding = '8px 12px';
    deselectAllButton.style.cursor = 'pointer';
    deselectAllButton.style.margin = '5px';
    deselectAllButton.onclick = function() {
        // 取消選中所有微生物，並確保至少選中一個
        document.querySelectorAll('.organism-button').forEach(button => {
            button.classList.remove('active');
        });
        
        // 至少選中第一個
        const firstButton = document.querySelector('.organism-button');
        if (firstButton) {
            firstButton.classList.add('active');
            // 顯示單一微生物結果，包含完整時間信息
            const organism = firstButton.getAttribute('data-organism');
            const specimen = firstButton.getAttribute('data-specimen');
            const number = firstButton.getAttribute('data-number') || '0';
            const datetime = firstButton.getAttribute('data-datetime') || '';
            const sampleID = firstButton.getAttribute('data-sampleid') || '';
            displayAntibioticResultsAsTable(organism, specimen, number, datetime, sampleID);
        }
    };
    
    // 創建按鈕容器
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'selector-buttons';
    buttonContainer.style.display = 'flex';
    buttonContainer.style.flexWrap = 'wrap';
    buttonContainer.style.marginTop = '10px';
    buttonContainer.style.marginBottom = '15px';
    buttonContainer.appendChild(selectAllButton);
    buttonContainer.appendChild(deselectAllButton);
    buttonContainer.appendChild(compareButton);
    
    // 將按鈕容器插入到微生物選擇器後面
    organismSelector.parentNode.insertBefore(buttonContainer, organismSelector.nextSibling);
    
    // 修改微生物選擇按鈕的點擊事件以支持多選和時間信息
    document.querySelectorAll('.organism-button').forEach(button => {
        // 移除原有的點擊事件
        const oldClickEvent = button.onclick;
        button.onclick = null;
        
        // 添加新的點擊事件
        button.addEventListener('click', function(e) {
            const organism = this.getAttribute('data-organism');
            const specimen = this.getAttribute('data-specimen');
            const number = this.getAttribute('data-number') || '0';
            const datetime = this.getAttribute('data-datetime') || '';
            const sampleID = this.getAttribute('data-sampleid') || '';
            
            // 按住Ctrl鍵可以多選
            if (e.ctrlKey || e.metaKey) {
                this.classList.toggle('active');
            } else {
                // 不按Ctrl則只選中當前微生物
                document.querySelectorAll('.organism-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
            }
            
            // 如果只有一個選中的微生物，顯示其詳細結果
            const activeButtons = document.querySelectorAll('.organism-button.active');
            if (activeButtons.length === 1) {
                displayAntibioticResultsAsTable(organism, specimen, number, datetime, sampleID);
            } else if (activeButtons.length > 1) {
                // 自動顯示比較按鈕
                compareButton.style.backgroundColor = '#1a73e8';  // 突出顯示比較按鈕
                compareButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                
                // 如果選擇多個項目，顯示提示
                const resultsContainer = document.getElementById('antibioticResults');
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin-top: 20px;">
                        <p>已選擇 ${activeButtons.length} 個項目</p>
                        <button id="compareNowBtn" style="padding: 8px 16px; background-color: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            點擊這裡進行比較
                        </button>
                    </div>
                `;
                
                // 為新按鈕添加點擊事件
                document.getElementById('compareNowBtn').addEventListener('click', function() {
                    displayMultiOrganismComparison();
                });
            }
        });
    });
}

// 新增排序微生物列表功能
function sortOrganismList(sortMethod) {
    const organismSelector = document.getElementById('organismSelector');
    if (!organismSelector) return;
    
    // 收集所有微生物按鈕
    const buttons = Array.from(organismSelector.querySelectorAll('.organism-button'));
    
    // 找出當前選中的按鈕
    const activeButtons = buttons.filter(btn => btn.classList.contains('active'));
    const activeKeys = activeButtons.map(btn => btn.getAttribute('data-key'));
    
    // 根據排序方法進行排序
    buttons.sort((a, b) => {
        if (sortMethod === 'organism') {
            // 1. 按照微生物名稱排序
            const organismA = a.getAttribute('data-organism');
            const organismB = b.getAttribute('data-organism');
            if (organismA !== organismB) {
                return organismA.localeCompare(organismB);
            }
            
            // 2. 相同微生物按檢體類型排序
            const specimenA = a.getAttribute('data-specimen');
            const specimenB = b.getAttribute('data-specimen');
            if (specimenA !== specimenB) {
                return specimenA.localeCompare(specimenB);
            }
            
            // 3. 相同檢體按日期時間排序（降序）
            const datetimeA = a.getAttribute('data-datetime') || '';
            const datetimeB = b.getAttribute('data-datetime') || '';
            return compareDatetime(datetimeB, datetimeA);  // 注意順序，降序
        } 
        else if (sortMethod === 'datetime') {
            // 1. 按日期時間排序（降序，新→舊）
            const datetimeA = a.getAttribute('data-datetime') || '';
            const datetimeB = b.getAttribute('data-datetime') || '';
            const dateCompare = compareDatetime(datetimeB, datetimeA);  // 注意順序，降序
            if (dateCompare !== 0) {
                return dateCompare;
            }
            
            // 2. 相同時間按微生物名稱排序
            const organismA = a.getAttribute('data-organism');
            const organismB = b.getAttribute('data-organism');
            return organismA.localeCompare(organismB);
        }
        else if (sortMethod === 'datetime-asc') {
            // 1. 按日期時間排序（升序，舊→新）
            const datetimeA = a.getAttribute('data-datetime') || '';
            const datetimeB = b.getAttribute('data-datetime') || '';
            const dateCompare = compareDatetime(datetimeA, datetimeB);  // 注意順序，升序
            if (dateCompare !== 0) {
                return dateCompare;
            }
            
            // 2. 相同時間按微生物名稱排序
            const organismA = a.getAttribute('data-organism');
            const organismB = b.getAttribute('data-organism');
            return organismA.localeCompare(organismB);
        }
        
        // 默認按微生物名稱排序
        return a.getAttribute('data-organism').localeCompare(b.getAttribute('data-organism'));
    });
    
    // 重新添加排序後的按鈕
    buttons.forEach(button => {
        organismSelector.appendChild(button);
    });
    
    // 恢復選中狀態
    buttons.forEach(button => {
        const key = button.getAttribute('data-key');
        if (activeKeys.includes(key)) {
            button.classList.add('active');
        }
    });
}

// 比較日期時間字符串的輔助函數
function compareDatetime(dateA, dateB) {
    // 處理空日期
    if (!dateA && !dateB) return 0;
    if (!dateA) return -1;
    if (!dateB) return 1;
    
    // 提取日期和時間部分
    const hasTimeA = dateA.includes(' ');
    const hasTimeB = dateB.includes(' ');
    
    // 如果兩個都有完整的日期時間，直接比較字符串
    if (hasTimeA && hasTimeB) {
        // 轉換為標準格式進行比較（確保MM-DD變成MM/DD）
        const normalizedA = dateA.replace(/-/g, '/');
        const normalizedB = dateB.replace(/-/g, '/');
        return new Date(normalizedA).getTime() - new Date(normalizedB).getTime();
    }
    
    // 如果只有一個有時間，有時間的優先（較為精確）
    if (hasTimeA && !hasTimeB) return 1;
    if (!hasTimeA && hasTimeB) return -1;
    
    // 兩者都只有日期，直接比較日期
    const normalizedA = dateA.replace(/-/g, '/');
    const normalizedB = dateB.replace(/-/g, '/');
    return new Date(normalizedA).getTime() - new Date(normalizedB).getTime();
}

// 修改生成藥敏分析頁面的代碼，整合新的排序邏輯
function generateSensitivityAnalysis() {
    
    // 清除現有內容
    document.getElementById('antibioticResults').innerHTML = '';
    document.getElementById('organismSelector').innerHTML = '';
    
    // 清除可能存在的排序容器和按鈕
    const existingSortingContainer = document.querySelector('.sorting-options');
    if (existingSortingContainer) {
        existingSortingContainer.remove();
    }
    
    const existingButtonContainer = document.querySelector('.selector-buttons');
    if (existingButtonContainer) {
        existingButtonContainer.remove();
    }
    if (allAntibioticResults.length === 0) {
        document.getElementById('antibioticResults').innerHTML = '<p>無藥敏測試結果</p>';
        document.getElementById('organismSelector').innerHTML = '';
        return;
    }

    // 清除現有的排序選項元素 - 添加這段代碼
    const existingSortOptions = document.querySelectorAll('.sensitivity-analysis .排序方式-container');
    existingSortOptions.forEach(option => option.remove());
    
    // 創建微生物+檢體+序號+時間+樣本ID的複合鍵
    const uniqueOrgSpecimens = [];
    const orgSpecimenMap = {};
    
    // 為每個藥敏結果創建唯一鍵並存儲信息
    allAntibioticResults.forEach(item => {
        // 創建包含序號和時間信息的唯一鍵
        // 使用采樣時間和收件編號確保唯一性
        const sampleTimeStr = item.sampleTime || '';
        const sampleIDStr = item.sampleID || '';
        const key = `${item.organism}|${item.specimen}|${item.number || '0'}|${item.datetime || item.shortDate}|${sampleIDStr}`;
        
        if (!orgSpecimenMap[key]) {
            orgSpecimenMap[key] = {
                organism: item.organism,
                specimen: item.specimen,
                testType: item.testType,
                date: item.date,
                shortDate: item.shortDate,
                datetime: item.datetime || item.shortDate,  // 使用完整日期時間信息
                sampleTime: item.sampleTime || '',         // 保存采樣時間
                sampleID: item.sampleID || '',             // 保存收件編號
                number: item.number || '0',
                key: key
            };
            uniqueOrgSpecimens.push(key);
        }
    });
    
    // 生成微生物選擇器
    const organismSelector = document.getElementById('organismSelector');
    organismSelector.innerHTML = '';
    
    // 按默認方式排序 - 首先按微生物名稱，然後按日期時間（降序，最新的在前面）
    // 注意：稍後會由排序函數重新排序，所以這裡只是提供初始順序
    uniqueOrgSpecimens.sort((a, b) => {
        const infoA = orgSpecimenMap[a];
        const infoB = orgSpecimenMap[b];
        
        // 先比較微生物名稱
        if (infoA.organism !== infoB.organism) {
            return infoA.organism.localeCompare(infoB.organism);
        }
        
        // 微生物名稱相同時，比較檢體類型
        if (infoA.specimen !== infoB.specimen) {
            return infoA.specimen.localeCompare(infoB.specimen);
        }
        
        // 檢體類型相同時，先比較日期（降序，最新的在前面）
        const dateA = new Date(infoA.date + ' ' + (infoA.sampleTime || '00:00'));
        const dateB = new Date(infoB.date + ' ' + (infoB.sampleTime || '00:00'));
        if (dateA.getTime() !== dateB.getTime()) {
            return dateB.getTime() - dateA.getTime();
        }
        
        // 日期時間相同時，比較序號
        return parseInt(infoA.number || '0') - parseInt(infoB.number || '0');
    });
    
    // 為每個唯一的微生物+檢體+序號+時間組合創建選擇器按鈕
    uniqueOrgSpecimens.forEach((key, index) => {
        const info = orgSpecimenMap[key];
        
        // Decide on display text format for test type
        let testTypeText = '';
        if (info) {
            // Special handling for TB test type
            if (info.testType === 'TB') {
                testTypeText = '(TB Culture)';
            } else {
                // Get the number info if available
                const numberText = info.number && info.number !== '0' ? ` 序號:${info.number}` : '';
                
                // Full date formatting - use full date instead of shortDate
                const dateText = info.date || ''; // Use full date (e.g., "2023/04/15")
                
                // Time text formatting - use sampleTime if available
                const timeText = info.sampleTime ? ` ${info.sampleTime}` : '';
                
                testTypeText = `(${info.testType} ${info.specimen || ''} ${dateText}${timeText}${numberText})`;
            }
        }
        
        const button = document.createElement('div');
        button.className = 'organism-button' + (index === 0 ? ' active' : '');
        button.setAttribute('data-organism', info.organism);
        button.setAttribute('data-specimen', info.specimen);
        button.setAttribute('data-number', info.number || '0');       // Add number attribute
        button.setAttribute('data-datetime', info.datetime || '');    // Add datetime attribute
        button.setAttribute('data-sampleid', info.sampleID || '');    // Add specimen ID attribute
        button.setAttribute('data-key', key);
        button.innerHTML = `${info.organism} <span class="specimen-info">${testTypeText}</span>`;
        button.onclick = function() {
            // Remove active class from other buttons
            document.querySelectorAll('.organism-button').forEach(btn => btn.classList.remove('active'));
            // Add active class to current button
            this.classList.add('active');
            // Display antibiotic results for selected organism, including full time info
            const organism = this.getAttribute('data-organism');
            const specimen = this.getAttribute('data-specimen');
            const number = this.getAttribute('data-number');
            const datetime = this.getAttribute('data-datetime');
            const sampleID = this.getAttribute('data-sampleid');
            displayAntibioticResultsAsTable(organism, specimen, number, datetime, sampleID);
        };
        
        organismSelector.appendChild(button);
    });
    
    // 預設顯示第一個微生物+檢體+序號+時間組合的結果
    if (uniqueOrgSpecimens.length > 0) {
        const firstKey = uniqueOrgSpecimens[0];
        const firstInfo = orgSpecimenMap[firstKey];
        displayAntibioticResultsAsTable(
            firstInfo.organism, 
            firstInfo.specimen, 
            firstInfo.number, 
            firstInfo.datetime, 
            firstInfo.sampleID
        );
    }
    
    // 增強選擇器功能
    enhanceOrganismSelector();
}

// 初始化藥敏分析頁面
function initSensitivityTab() {
    // 註冊初始化函數，在頁面加載完成後執行
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', enhanceSensitivityAnalysis);
    } else {
        enhanceSensitivityAnalysis();
    }
}

// 增強藥敏分析功能 (改進版) - 確保使用改進的函數
function enhanceSensitivityAnalysis() {
    // 在藥敏分析頁面底部添加改進版說明
    const sensitivityTab = document.getElementById('sensitivityTab');
    const versionNote = document.createElement('div');
    versionNote.style.marginTop = '20px';
    versionNote.style.padding = '10px';
    versionNote.style.backgroundColor = '#f8f9fa';
    versionNote.style.borderRadius = '4px';
    versionNote.style.fontSize = '12px';
    versionNote.style.color = '#666';
    versionNote.innerHTML = `
        <div style="margin-top: 5px;">提示: 按住 Ctrl 鍵可多選微生物進行比較，或使用上方的【全選】和【比較選中的微生物】按鈕。</div>
    `;
    sensitivityTab.appendChild(versionNote);
}

// 添加函數用於從完整藥名中提取基本藥物名稱
function getBaseDrugName(drug) {
    // 檢查是否包含濃度信息 (括號內)
    const concentrationMatch = drug.match(/(.+?)\s*\(([^)]+)\)/);
    if (concentrationMatch) {
        return concentrationMatch[1].trim();
    }
    return drug;
}

// 在頁面加載時初始化
initSensitivityTab();

// Initialize the summary tab
function initSummaryTab() {
    const summaryControls = document.getElementById('summaryControls');
    const summaryTableContainer = document.getElementById('summaryTableContainer');
    
    // Clear previous content
    summaryControls.innerHTML = '';
    summaryTableContainer.innerHTML = '';
    
    // Create control panel
    const controlPanel = document.createElement('div');
    controlPanel.className = 'summary-control-panel';
    controlPanel.style.padding = '10px';
    controlPanel.style.backgroundColor = '#f8f9fa';
    controlPanel.style.borderRadius = '8px';
    controlPanel.style.marginBottom = '15px';
    
    // Create item selection
    const itemSelection = document.createElement('div');
    itemSelection.className = 'item-selection';
    itemSelection.style.marginBottom = '15px';
    
    // Create test item selector label
    const itemLabel = document.createElement('label');
    itemLabel.textContent = '選擇檢驗項目: ';
    itemLabel.style.marginRight = '10px';
    itemLabel.style.fontWeight = 'bold';
    
    // Create multiselect dropdown
    const itemSelect = document.createElement('select');
    itemSelect.id = 'itemSelect';
    itemSelect.multiple = true;
    itemSelect.size = 5;
    itemSelect.style.minWidth = '200px';
    itemSelect.style.marginRight = '15px';
    
    // Get all unique test items from labData
    const allTests = [...new Set(labData.map(item => item.test))];
    
    // Sort items: monitored items first, then alphabetically
    allTests.sort((a, b) => {
        const aMonitored = monitoredLabs.includes(a);
        const bMonitored = monitoredLabs.includes(b);
        
        if (aMonitored && !bMonitored) return -1;
        if (!aMonitored && bMonitored) return 1;
        
        // For monitored items, keep original order
        if (aMonitored && bMonitored) {
            return monitoredLabs.indexOf(a) - monitoredLabs.indexOf(b);
        }
        
        // Alphabetical order for others
        return a.localeCompare(b);
    });
    
    // Add options to select
    allTests.forEach(test => {
        const option = document.createElement('option');
        option.value = test;
        option.textContent = test;
        // Pre-select monitored items
        if (monitoredLabs.includes(test)) {
            option.selected = true;
        }
        itemSelect.appendChild(option);
    });
    
    // Create buttons for selection control
    const buttonContainer = document.createElement('div');
    buttonContainer.style.display = 'inline-block';
    buttonContainer.style.verticalAlign = 'top';
    
    const selectAllBtn = document.createElement('button');
    selectAllBtn.textContent = '全選';
    selectAllBtn.style.display = 'block';
    selectAllBtn.style.margin = '0 0 5px 0';
    selectAllBtn.style.padding = '5px 10px';
    selectAllBtn.style.backgroundColor = '#4CAF50';
    selectAllBtn.style.color = 'white';
    selectAllBtn.style.border = 'none';
    selectAllBtn.style.borderRadius = '4px';
    selectAllBtn.style.cursor = 'pointer';
    selectAllBtn.onclick = function() {
        Array.from(itemSelect.options).forEach(opt => opt.selected = true);
    };
    
    const deselectAllBtn = document.createElement('button');
    deselectAllBtn.textContent = '取消全選';
    deselectAllBtn.style.display = 'block';
    deselectAllBtn.style.margin = '0 0 5px 0';
    deselectAllBtn.style.padding = '5px 10px';
    deselectAllBtn.style.backgroundColor = '#f44336';
    deselectAllBtn.style.color = 'white';
    deselectAllBtn.style.border = 'none';
    deselectAllBtn.style.borderRadius = '4px';
    deselectAllBtn.style.cursor = 'pointer';
    deselectAllBtn.onclick = function() {
        Array.from(itemSelect.options).forEach(opt => opt.selected = false);
    };
    
    const monitoredOnlyBtn = document.createElement('button');
    monitoredOnlyBtn.textContent = '僅選監控項目';
    monitoredOnlyBtn.style.display = 'block';
    monitoredOnlyBtn.style.margin = '0 0 5px 0';
    monitoredOnlyBtn.style.padding = '5px 10px';
    monitoredOnlyBtn.style.backgroundColor = '#2196F3';
    monitoredOnlyBtn.style.color = 'white';
    monitoredOnlyBtn.style.border = 'none';
    monitoredOnlyBtn.style.borderRadius = '4px';
    monitoredOnlyBtn.style.cursor = 'pointer';
    monitoredOnlyBtn.onclick = function() {
        Array.from(itemSelect.options).forEach(opt => {
            opt.selected = monitoredLabs.includes(opt.value);
        });
    };
    
    buttonContainer.appendChild(selectAllBtn);
    buttonContainer.appendChild(deselectAllBtn);
    buttonContainer.appendChild(monitoredOnlyBtn);
    
    // Create refresh button
    const refreshBtn = document.createElement('button');
    refreshBtn.id = 'refreshSummary';
    refreshBtn.textContent = '更新表格';
    refreshBtn.style.display = 'block';
    refreshBtn.style.margin = '10px 0';
    refreshBtn.style.padding = '8px 16px';
    refreshBtn.style.backgroundColor = '#007bff';
    refreshBtn.style.color = 'white';
    refreshBtn.style.border = 'none';
    refreshBtn.style.borderRadius = '4px';
    refreshBtn.style.cursor = 'pointer';
    refreshBtn.style.fontWeight = 'bold';
    refreshBtn.onclick = function() {
        generateSummaryTable();
    };
    
    // Assemble the selection controls
    itemSelection.appendChild(itemLabel);
    itemSelection.appendChild(itemSelect);
    itemSelection.appendChild(buttonContainer);
    
    controlPanel.appendChild(itemSelection);
    controlPanel.appendChild(refreshBtn);
    
    summaryControls.appendChild(controlPanel);
    
    // Add initial empty table message
    summaryTableContainer.innerHTML = '<p style="text-align: center; padding: 20px;">請在上方選擇檢驗項目並點擊「更新表格」按鈕</p>';
}

// Generate the summary table based on selected items
function generateSummaryTable() {
    const summaryTableContainer = document.getElementById('summaryTableContainer');
    const itemSelect = document.getElementById('itemSelect');
    
    // Get selected tests
    const selectedTests = Array.from(itemSelect.selectedOptions).map(opt => opt.value);
    
    if (selectedTests.length === 0) {
        summaryTableContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #f44336;">請至少選擇一個檢驗項目</p>';
        return;
    }
    
    // Filter labData for selected tests
    const filteredData = labData.filter(item => selectedTests.includes(item.test));
    
    if (filteredData.length === 0) {
        summaryTableContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #f44336;">所選項目沒有任何數據</p>';
        return;
    }
    
    // Group data by date
    const groupedByDate = {};
    filteredData.forEach(item => {
        // Create a key using date and time (if available)
        const timeStr = item.time ? ` ${item.time}` : '';
        const dateTimeKey = `${item.date}${timeStr}`;
        
        if (!groupedByDate[dateTimeKey]) {
            groupedByDate[dateTimeKey] = {
                date: item.date,
                time: item.time || '',
                shortDate: item.shortDate,
                tests: {}
            };
        }
        
        // Store test value using the test name as key
        groupedByDate[dateTimeKey].tests[item.test] = {
            value: item.value,
            rawValue: item.rawValue
        };
    });
    
    // Convert to array and sort by date and time (newest first)
    const sortedDates = Object.values(groupedByDate).sort((a, b) => {
        // Convert to comparable datetime strings
        const dateTimeA = `${a.date} ${a.time || '00:00'}`;
        const dateTimeB = `${b.date} ${b.time || '00:00'}`;
        
        // Descending order (newest first)
        return new Date(dateTimeB) - new Date(dateTimeA);
    });
    
    // Create table
    const table = document.createElement('table');
    table.className = 'summary-table';
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginBottom = '20px';
    
    // Create header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    // Date and time header
    const dateHeader = document.createElement('th');
    dateHeader.textContent = '日期時間';
    dateHeader.style.padding = '10px';
    dateHeader.style.backgroundColor = '#f1f1f1';
    dateHeader.style.border = '1px solid #ddd';
    dateHeader.style.position = 'sticky';
    dateHeader.style.left = '0';
    dateHeader.style.zIndex = '1';
    headerRow.appendChild(dateHeader);
    
    // Test columns
    selectedTests.forEach(test => {
        const th = document.createElement('th');
        th.textContent = `${test} (${getUnitForTest(test)})`;
        th.style.padding = '10px';
        th.style.backgroundColor = '#f1f1f1';
        th.style.border = '1px solid #ddd';
        th.setAttribute('data-test', test);
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create body
    const tbody = document.createElement('tbody');
    
    // For each date, create a row
    sortedDates.forEach(dateData => {
        const row = document.createElement('tr');
        
        // Date cell
        const dateCell = document.createElement('td');
        dateCell.style.padding = '8px';
        dateCell.style.border = '1px solid #ddd';
        dateCell.style.backgroundColor = '#fff';
        dateCell.style.position = 'sticky';
        dateCell.style.left = '0';
        dateCell.style.fontWeight = 'bold';
        
        // Format the date display
        const timeStr = dateData.time ? ` ${dateData.time}` : '';
        dateCell.textContent = `${dateData.date}${timeStr}`;
        
        row.appendChild(dateCell);
        
        // For each test, add a cell
        selectedTests.forEach(test => {
            const cell = document.createElement('td');
            cell.style.padding = '8px';
            cell.style.border = '1px solid #ddd';
            cell.style.textAlign = 'center';
            
            if (dateData.tests[test]) {
                // Use raw value for display
                cell.textContent = dateData.tests[test].rawValue;
                
                // Add color highlighting for abnormal values
                const value = dateData.tests[test].rawValue;
                if (value.includes('H') || value.includes('>')) {
                    cell.style.color = '#d32f2f';
                    cell.style.fontWeight = 'bold';
                } else if (value.includes('L') || value.includes('<')) {
                    cell.style.color = '#1976d2';
                    cell.style.fontWeight = 'bold';
                }
            } else {
                cell.textContent = '-';
                cell.style.color = '#999';
            }
            
            row.appendChild(cell);
        });
        
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    
    // Clear and add the table
    summaryTableContainer.innerHTML = '';
    
    // Add table info
    const tableInfo = document.createElement('div');
    tableInfo.style.marginBottom = '10px';
    tableInfo.style.fontSize = '14px';
    tableInfo.style.color = '#555';
    tableInfo.innerHTML = `
        <span>共有 ${sortedDates.length} 個檢測日期時間點，${selectedTests.length} 個檢驗項目</span>
        <span style="float: right; color: #777;">表格可左右滾動查看更多項目 →</span>
    `;
    
    summaryTableContainer.appendChild(tableInfo);
    
    // Create a scrollable container for the table
    const tableScroller = document.createElement('div');
    tableScroller.style.width = '100%';
    tableScroller.style.overflowX = 'auto';
    tableScroller.appendChild(table);
    
    summaryTableContainer.appendChild(tableScroller);
}

// Helper function to get unit for a test
function getUnitForTest(test) {
    const unitMap = {
        'WBC': '1000/uL',
        'RBC': 'million/uL',
        'Hemoglobin': 'g/dL',
        'Hb': 'g/dL',
        'Hematocrit': '%',
        'Plt': '1000/uL',
        'Platelets': '1000/uL',
        'Cr': 'mg/dL',
        'Na': 'mEq/L',
        'K': 'mEq/L',
        'CRP': 'mg/dL',
        'AST': 'U/L',
        'ALT': 'U/L',
        'Bil-T': 'mg/dL',
        'Segment': '%',
        'Lymphocyte': '%',
        'P.T': 'sec',
        'APTT': 'sec',
        'INR': '',
        'MPV': 'fL',
        'MCHC': 'g/dL',
        'MCH': 'pg',
        'MCV': 'fL'
    };
    
    return unitMap[test] || '';
}

// 添加到解析報告按鈕的點擊事件
const originalParseReport = parseReport;
window.parseReport = function() {
    originalParseReport();
    
    // 自動切換到藥敏標籤頁
    if (allAntibioticResults.length > 0) {
        openTab({ currentTarget: document.querySelector('.tab-button[onclick*="sensitivityTab"]') }, 'sensitivityTab');
    } 
    // 如果沒有藥敏結果但有微生物結果，則切換到微生物標籤頁
    else if (document.getElementById('inputReport').value.includes('Blood Culture') || 
             document.getElementById('inputReport').value.includes('Aerobic Culture') || 
             document.getElementById('inputReport').value.includes('Anaerobic Cultu') || 
             document.getElementById('inputReport').value.includes('MIC') || 
             document.getElementById('inputReport').value.includes('TB Culture')) {
        openTab({ currentTarget: document.querySelector('.tab-button[onclick*="microTab"]') }, 'microTab');
    }
};

// 修改 generateCharts 函數，添加動態趨勢圖選項並整合日期範圍選擇功能
function generateCharts() {
    if (labData.length === 0) return;
    
    const chartContainer = document.getElementById('chartContainer');
    chartContainer.innerHTML = ''; // 清空現有圖表
    
    // 創建控制面板
    createChartControlPanel();
    
    // 按照檢驗項目分組數據
    const groupedData = {};
    
    // 首先收集所有出現的檢驗項目
    const allTests = new Set();
    labData.forEach(item => {
        allTests.add(item.test);
        if (!groupedData[item.test]) {
            groupedData[item.test] = [];
        }
        groupedData[item.test].push(item);
    });
    
    // 轉換為數組並排序：優先顯示監控項目，其他按字母排序
    const allTestsArray = Array.from(allTests).sort((a, b) => {
        const aMonitored = monitoredLabs.includes(a);
        const bMonitored = monitoredLabs.includes(b);
        
        if (aMonitored && !bMonitored) return -1;
        if (!aMonitored && bMonitored) return 1;
        
        // 對於監控項目，保持原有順序
        if (aMonitored && bMonitored) {
            return monitoredLabs.indexOf(a) - monitoredLabs.indexOf(b);
        }
        
        // 非監控項目按字母排序
        return a.localeCompare(b);
    });
    
    // 初始時顯示監控的檢驗項目
    renderSelectedCharts(groupedData, monitoredLabs);
    
    // 更新自定義選擇下拉框
    updateCustomSelector(allTestsArray);
    
    // 如果已有日期範圍信息，則顯示
    updateDateRangeInfo('all');
}

// 修改 createChartControlPanel 函數來整合時間範圍選擇器
function createChartControlPanel() {
    const chartContainer = document.getElementById('chartContainer');
    
    // 創建控制面板容器
    const controlPanel = document.createElement('div');
    controlPanel.id = 'chartControlPanel';
    controlPanel.style.gridColumn = '1 / -1'; // 跨所有列
    controlPanel.style.display = 'flex';
    controlPanel.style.flexWrap = 'wrap';
    controlPanel.style.alignItems = 'center';
    controlPanel.style.justifyContent = 'space-between';
    controlPanel.style.padding = '10px';
    controlPanel.style.marginBottom = '15px';
    controlPanel.style.backgroundColor = '#f8f9fa';
    controlPanel.style.borderRadius = '8px';
    controlPanel.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
    
    // 創建預設模式選擇器
    const presetModes = document.createElement('div');
    presetModes.className = 'preset-modes';
    
    // 添加模式按鈕：監控項目、所有項目、自定義
    const modes = [
        { id: 'monitored', label: '監控項目', active: true },
        { id: 'all', label: '所有項目', active: false },
        { id: 'custom', label: '自定義選擇', active: false }
    ];
    
    modes.forEach(mode => {
        const button = document.createElement('button');
        button.id = `mode-${mode.id}`;
        button.className = `mode-button ${mode.active ? 'active' : ''}`;
        button.textContent = mode.label;
        
        button.style.margin = '0 5px 5px 0';
        button.style.padding = '8px 12px';
        button.style.backgroundColor = mode.active ? '#4CAF50' : '#e9ecef';
        button.style.color = mode.active ? 'white' : '#333';
        button.style.border = 'none';
        button.style.borderRadius = '4px';
        button.style.cursor = 'pointer';
        button.style.fontWeight = mode.active ? 'bold' : 'normal';
        
        button.addEventListener('click', function() {
            // 切換按鈕樣式
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.backgroundColor = '#e9ecef';
                btn.style.color = '#333';
                btn.style.fontWeight = 'normal';
            });
            this.classList.add('active');
            this.style.backgroundColor = '#4CAF50';
            this.style.color = 'white';
            this.style.fontWeight = 'bold';
            
            // 根據模式切換顯示內容
            const customSelector = document.getElementById('customChartSelector');
            if (mode.id === 'custom') {
                customSelector.style.display = 'flex';
            } else {
                customSelector.style.display = 'none';
            }
            
            // 更新圖表顯示
            handleModeChange(mode.id);
        });
        
        presetModes.appendChild(button);
    });
    
    // 創建自定義選擇區域
    const customSelector = document.createElement('div');
    customSelector.id = 'customChartSelector';
    customSelector.style.display = 'none'; // 初始隱藏
    customSelector.style.flexGrow = '1';
    customSelector.style.margin = '5px 0';
    customSelector.style.padding = '10px';
    customSelector.style.backgroundColor = '#f1f8e9';
    customSelector.style.borderRadius = '4px';
    customSelector.style.flexWrap = 'wrap';
    
    // 創建右側工具區
    const toolsArea = document.createElement('div');
    toolsArea.className = 'chart-tools';
    toolsArea.style.display = 'flex';
    toolsArea.style.flexWrap = 'wrap';
    toolsArea.style.alignItems = 'center';
    
    // 首先添加日期範圍選擇器
    addDateRangeSelector(toolsArea);
    
    // 添加搜尋框
    const searchBox = document.createElement('input');
    searchBox.type = 'text';
    searchBox.id = 'chartSearchBox';
    searchBox.placeholder = '搜尋檢驗項目...';
    searchBox.style.padding = '6px 10px';
    searchBox.style.borderRadius = '4px';
    searchBox.style.border = '1px solid #ced4da';
    searchBox.style.marginRight = '10px';
    
    // 搜尋功能
    searchBox.addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        filterCharts(searchText);
    });
    
    toolsArea.appendChild(searchBox);
    
    // 添加排序選項
    const sortSelect = document.createElement('select');
    sortSelect.id = 'chartSortOption';
    sortSelect.style.padding = '6px 10px';
    sortSelect.style.borderRadius = '4px';
    sortSelect.style.border = '1px solid #ced4da';
    
    const sortOptions = [
        { value: 'default', label: '默認排序' },
        { value: 'nameAsc', label: '名稱升序 (A-Z)' },
        { value: 'nameDesc', label: '名稱降序 (Z-A)' },
        { value: 'dateAsc', label: '日期升序 (舊->新)' },
        { value: 'dateDesc', label: '日期降序 (新->舊)' },
        { value: 'valueAsc', label: '數值升序 (低->高)' },
        { value: 'valueDesc', label: '數值降序 (高->低)' }
    ];
    
    sortOptions.forEach(option => {
        const optElement = document.createElement('option');
        optElement.value = option.value;
        optElement.textContent = option.label;
        sortSelect.appendChild(optElement);
    });
    
    // 排序功能
    sortSelect.addEventListener('change', function() {
        sortCharts(this.value);
    });
    
    toolsArea.appendChild(sortSelect);
    
    // 組合控制面板
    controlPanel.appendChild(presetModes);
    controlPanel.appendChild(toolsArea);
    chartContainer.appendChild(controlPanel);
    chartContainer.appendChild(customSelector);
}

// 更新自定義選擇下拉框
function updateCustomSelector(allTests) {
    const customSelector = document.getElementById('customChartSelector');
    customSelector.innerHTML = '';
    
    // 添加選擇器標題
    const selectorTitle = document.createElement('div');
    selectorTitle.textContent = '選擇要顯示的檢驗項目:';
    selectorTitle.style.width = '100%';
    selectorTitle.style.marginBottom = '10px';
    selectorTitle.style.fontWeight = 'bold';
    customSelector.appendChild(selectorTitle);
    
    // 創建檢驗項目容器
    const itemsContainer = document.createElement('div');
    itemsContainer.style.display = 'flex';
    itemsContainer.style.flexWrap = 'wrap';
    itemsContainer.style.gap = '8px';
    itemsContainer.style.marginBottom = '10px';
    
    // 添加檢驗項目選擇器
    allTests.forEach(test => {
        const isMonitored = monitoredLabs.includes(test);
        
        const checkboxLabel = document.createElement('label');
        checkboxLabel.className = 'test-checkbox-label';
        checkboxLabel.style.display = 'inline-flex';
        checkboxLabel.style.alignItems = 'center';
        checkboxLabel.style.padding = '5px 10px';
        checkboxLabel.style.backgroundColor = isMonitored ? '#e8f5e9' : '#f5f5f5';
        checkboxLabel.style.borderRadius = '4px';
        checkboxLabel.style.cursor = 'pointer';
        checkboxLabel.style.border = '1px solid ' + (isMonitored ? '#4CAF50' : '#ddd');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = test;
        checkbox.className = 'test-checkbox';
        checkbox.checked = isMonitored; // 默認選中監控項目
        checkbox.style.marginRight = '5px';
        
        // 添加顏色標記
        const colorMark = document.createElement('span');
        colorMark.style.display = 'inline-block';
        colorMark.style.width = '12px';
        colorMark.style.height = '12px';
        colorMark.style.borderRadius = '50%';
        colorMark.style.backgroundColor = getChartColor(test);
        colorMark.style.marginRight = '5px';
        
        const labelText = document.createElement('span');
        labelText.textContent = test + (isMonitored ? ' (監控項目)' : '');
        
        checkboxLabel.appendChild(checkbox);
        checkboxLabel.appendChild(colorMark);
        checkboxLabel.appendChild(labelText);
        itemsContainer.appendChild(checkboxLabel);
        
        // 添加點擊事件
        checkbox.addEventListener('change', updateCustomCharts);
    });
    
    customSelector.appendChild(itemsContainer);
    
    // 添加操作按鈕
    const buttonsContainer = document.createElement('div');
    buttonsContainer.style.display = 'flex';
    buttonsContainer.style.gap = '10px';
    buttonsContainer.style.marginTop = '10px';
    
    // 全選按鈕
    const selectAllBtn = document.createElement('button');
    selectAllBtn.textContent = '全選';
    selectAllBtn.className = 'selector-control-btn';
    selectAllBtn.style.padding = '5px 10px';
    selectAllBtn.style.backgroundColor = '#2196F3';
    selectAllBtn.style.color = 'white';
    selectAllBtn.style.border = 'none';
    selectAllBtn.style.borderRadius = '4px';
    selectAllBtn.style.cursor = 'pointer';
    
    selectAllBtn.addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.test-checkbox');
        checkboxes.forEach(cb => { cb.checked = true; });
        updateCustomCharts();
    });
    
    // 取消全選按鈕
    const deselectAllBtn = document.createElement('button');
    deselectAllBtn.textContent = '取消全選';
    deselectAllBtn.className = 'selector-control-btn';
    deselectAllBtn.style.padding = '5px 10px';
    deselectAllBtn.style.backgroundColor = '#f44336';
    deselectAllBtn.style.color = 'white';
    deselectAllBtn.style.border = 'none';
    deselectAllBtn.style.borderRadius = '4px';
    deselectAllBtn.style.cursor = 'pointer';
    
    deselectAllBtn.addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.test-checkbox');
        checkboxes.forEach(cb => { cb.checked = false; });
        updateCustomCharts();
    });
    
    // 僅選監控項目按鈕
    const monitoredOnlyBtn = document.createElement('button');
    monitoredOnlyBtn.textContent = '僅選監控項目';
    monitoredOnlyBtn.className = 'selector-control-btn';
    monitoredOnlyBtn.style.padding = '5px 10px';
    monitoredOnlyBtn.style.backgroundColor = '#4CAF50';
    monitoredOnlyBtn.style.color = 'white';
    monitoredOnlyBtn.style.border = 'none';
    monitoredOnlyBtn.style.borderRadius = '4px';
    monitoredOnlyBtn.style.cursor = 'pointer';
    
    monitoredOnlyBtn.addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.test-checkbox');
        checkboxes.forEach(cb => { 
            cb.checked = monitoredLabs.includes(cb.value);
        });
        updateCustomCharts();
    });
    
    buttonsContainer.appendChild(selectAllBtn);
    buttonsContainer.appendChild(deselectAllBtn);
    buttonsContainer.appendChild(monitoredOnlyBtn);
    
    customSelector.appendChild(buttonsContainer);
}

// 更新自定義選擇的圖表
function updateCustomCharts() {
    const selectedTests = [];
    document.querySelectorAll('.test-checkbox:checked').forEach(cb => {
        selectedTests.push(cb.value);
    });
    
    // 獲取分組數據
    const groupedData = {};
    labData.forEach(item => {
        if (!groupedData[item.test]) {
            groupedData[item.test] = [];
        }
        groupedData[item.test].push(item);
    });
    
    // 渲染選中的圖表
    renderSelectedCharts(groupedData, selectedTests);
}

// 根據模式切換圖表並處理模式變更時的日期範圍維持
function handleModeChange(modeId) {
    // 獲取當前日期範圍
    const dateRangeSelect = document.getElementById('dateRangeSelect');
    const currentRange = dateRangeSelect ? dateRangeSelect.value : 'all';
    
    // 獲取分組數據
    const groupedData = {};
    
    // 根據當前的日期範圍過濾數據
    let filteredLabData = [...labData]; // 創建副本以避免修改原始數據
    
    if (currentRange !== 'all') {
        if (currentRange === 'custom') {
            // 處理自定義範圍
            const startDateValue = document.getElementById('startDateInput').value;
            const endDateValue = document.getElementById('endDateInput').value;
            
            if (startDateValue && endDateValue) {
                const startDate = new Date(startDateValue);
                const endDate = new Date(endDateValue);
                endDate.setHours(23, 59, 59, 999);
                
                filteredLabData = filteredLabData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= startDate && itemDate <= endDate;
                });
            }
        } else {
            // 處理預設範圍
            const now = new Date();
            let startDate;
            
            switch (currentRange) {
                case 'last7':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'last14':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 14);
                    break;
                case 'last30':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 30);
                    break;
                case 'last90':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 90);
                    break;
            }
            
            if (startDate) {
                filteredLabData = filteredLabData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= startDate && itemDate <= now;
                });
            }
        }
    }
    
    // 更新可用的測試項目列表
    const availableTests = new Set();
    filteredLabData.forEach(item => {
        availableTests.add(item.test);
        if (!groupedData[item.test]) {
            groupedData[item.test] = [];
        }
        groupedData[item.test].push(item);
    });
    
    // 根據模式選擇要顯示的測試項目
    let selectedTests = [];
    
    switch(modeId) {
        case 'monitored':
            // 只顯示在過濾數據中存在的監控項目
            selectedTests = monitoredLabs.filter(test => availableTests.has(test));
            break;
        case 'all':
            selectedTests = Array.from(availableTests);
            break;
        case 'custom':
            // 獲取用戶自定義選擇的項目（如果已經選擇了）
            selectedTests = Array.from(document.querySelectorAll('.test-checkbox:checked')).map(cb => cb.value);
            // 只保留在過濾數據中存在的項目
            selectedTests = selectedTests.filter(test => availableTests.has(test));
            
            // 如果沒有選中任何項目，默認選中所有可用的監控項目
            if (selectedTests.length === 0) {
                selectedTests = monitoredLabs.filter(test => availableTests.has(test));
                
                // 更新選擇框狀態
                document.querySelectorAll('.test-checkbox').forEach(cb => {
                    cb.checked = selectedTests.includes(cb.value);
                });
            }
            break;
        default:
            selectedTests = monitoredLabs.filter(test => availableTests.has(test));
    }
    
    // 使用過濾後的數據渲染圖表
    renderSelectedCharts(groupedData, selectedTests, true);
}

// 根據搜尋詞過濾圖表
function filterCharts(searchText) {
    // 首先檢查當前選擇的模式
    const currentMode = document.querySelector('.mode-button.active').id.replace('mode-', '');
    
    if (currentMode === 'custom') {
        // 如果是自定義模式，過濾選擇器中的項目
        document.querySelectorAll('.test-checkbox-label').forEach(label => {
            const testName = label.textContent.toLowerCase();
            if (testName.includes(searchText)) {
                label.style.display = 'inline-flex';
            } else {
                label.style.display = 'none';
            }
        });
    } else {
        // 如果是其他模式，過濾圖表
        document.querySelectorAll('.chart-wrapper').forEach(chart => {
            const chartTitle = chart.querySelector('.chart-title').textContent.toLowerCase();
            if (chartTitle.includes(searchText)) {
                chart.style.display = 'block';
            } else {
                chart.style.display = 'none';
            }
        });
    }
}

// 排序圖表
function sortCharts(sortOption) {
    const chartContainer = document.getElementById('chartContainer');
    const charts = Array.from(document.querySelectorAll('.chart-wrapper:not(#chartControlPanel):not(.micro-timeline-wrapper)'));
    
    // 先移除所有圖表
    charts.forEach(chart => chart.remove());
    
    // 根據選擇的排序選項進行排序
    switch(sortOption) {
        case 'nameAsc':
            charts.sort((a, b) => {
                const titleA = a.querySelector('.chart-title').textContent;
                const titleB = b.querySelector('.chart-title').textContent;
                return titleA.localeCompare(titleB);
            });
            break;
        case 'nameDesc':
            charts.sort((a, b) => {
                const titleA = a.querySelector('.chart-title').textContent;
                const titleB = b.querySelector('.chart-title').textContent;
                return titleB.localeCompare(titleA);
            });
            break;
        case 'dateAsc':
            charts.sort((a, b) => {
                // 嘗試獲取每個圖表的最早日期
                const datesA = getChartDates(a);
                const datesB = getChartDates(b);
                return new Date(datesA[0] || 0) - new Date(datesB[0] || 0);
            });
            break;
        case 'dateDesc':
            charts.sort((a, b) => {
                // 嘗試獲取每個圖表的最近日期
                const datesA = getChartDates(a);
                const datesB = getChartDates(b);
                return new Date(datesB[datesB.length - 1] || 0) - new Date(datesA[datesA.length - 1] || 0);
            });
            break;
        case 'valueAsc':
            charts.sort((a, b) => {
                // 獲取最新值
                const valuesA = getChartValues(a);
                const valuesB = getChartValues(b);
                return (valuesA[valuesA.length - 1] || 0) - (valuesB[valuesB.length - 1] || 0);
            });
            break;
        case 'valueDesc':
            charts.sort((a, b) => {
                // 獲取最新值
                const valuesA = getChartValues(a);
                const valuesB = getChartValues(b);
                return (valuesB[valuesB.length - 1] || 0) - (valuesA[valuesA.length - 1] || 0);
            });
            break;
        default: // 默認順序
            charts.sort((a, b) => {
                const testA = a.getAttribute('data-test');
                const testB = b.getAttribute('data-test');
                
                // 優先監控項目
                const aMonitored = monitoredLabs.includes(testA);
                const bMonitored = monitoredLabs.includes(testB);
                
                if (aMonitored && !bMonitored) return -1;
                if (!aMonitored && bMonitored) return 1;
                
                // 監控項目內部保持原順序
                if (aMonitored && bMonitored) {
                    return monitoredLabs.indexOf(testA) - monitoredLabs.indexOf(testB);
                }
                
                // 其他按名稱排序
                return testA.localeCompare(testB);
            });
    }
    
    // 重新添加圖表
    charts.forEach(chart => chartContainer.appendChild(chart));
    
    // 確保微生物時間軸始終在頂部
    const microTimeline = document.querySelector('.micro-timeline-wrapper');
    if (microTimeline) {
        chartContainer.insertBefore(microTimeline, chartContainer.firstChild);
    }
    
    // 確保控制面板始終在最頂部
    const controlPanel = document.getElementById('chartControlPanel');
    if (controlPanel) {
        chartContainer.insertBefore(controlPanel, chartContainer.firstChild);
    }
    
    // 重新設置拖放功能
    setupDragAndDrop();
}

// 輔助函數：從圖表元素中提取日期
function getChartDates(chartElement) {
    try {
        const chartCanvas = chartElement.querySelector('canvas');
        const chart = Chart.getChart(chartCanvas);
        return chart.data.labels || [];
    } catch (e) {
        return [];
    }
}

// 輔助函數：從圖表元素中提取數值
function getChartValues(chartElement) {
    try {
        const chartCanvas = chartElement.querySelector('canvas');
        const chart = Chart.getChart(chartCanvas);
        return chart.data.datasets[0].data.map(d => d.y) || [];
    } catch (e) {
        return [];
    }
}

// 修改 renderSelectedCharts 函數以支援日期範圍過濾
function renderSelectedCharts(groupedData, selectedTests, isFiltered = false) {
    // 首先移除舊的圖表，保留控制面板和微生物時間軸
    const chartContainer = document.getElementById('chartContainer');
    const existingCharts = document.querySelectorAll('.chart-wrapper:not(#chartControlPanel):not(.micro-timeline-wrapper):not(#customChartSelector):not(#dateRangeInfo)');
    existingCharts.forEach(chart => chart.remove());
    
    // 確保 Chart.js Zoom 插件已註冊
    const zoomPluginLoaded = Chart.registry.getPlugin('zoom') !== undefined;
    if (!zoomPluginLoaded) {
        console.warn('Chart.js Zoom 插件未找到，圖表將不支持縮放功能');
    }
    
    // 檢查是否有數據
    if (selectedTests.length === 0 || Object.keys(groupedData).length === 0) {
        const noDataMessage = document.createElement('div');
        noDataMessage.style.gridColumn = '1 / -1';
        noDataMessage.style.padding = '20px';
        noDataMessage.style.textAlign = 'center';
        noDataMessage.style.backgroundColor = '#f8f9fa';
        noDataMessage.style.borderRadius = '8px';
        noDataMessage.style.color = '#666';
        noDataMessage.style.fontSize = '16px';
        noDataMessage.style.fontWeight = 'bold';
        noDataMessage.textContent = '所選範圍內沒有檢測數據，請調整時間範圍或選擇其他項目';
        chartContainer.appendChild(noDataMessage);
        return;
    }
    
    // 按照指定順序創建圖表
    for (const test of selectedTests) {
        const data = groupedData[test];
        if (!data || data.length === 0) continue;
        
        // 特殊處理：當繪製 ALT 圖表時，同時顯示 AST 數據（如果有）
        const isAltChart = test === 'ALT';
        const astData = isAltChart ? groupedData['AST'] || [] : [];
        
        // 如果是 AST 圖表，且 ALT 已經繪製過，則跳過（因為 AST 已經在 ALT 圖表中顯示）
        if (test === 'AST' && selectedTests.includes('ALT') && 
            selectedTests.indexOf('ALT') < selectedTests.indexOf('AST')) {
            continue;
        }
        
        // 排序數據以確保時間順序 - 先按照日期排序，同一天內再按時間排序
        data.sort((a, b) => {
            // 先比較日期
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            const dateDiff = dateA - dateB;
            
            // 如果日期相同且有時間資訊，則依據時間排序
            if (dateDiff === 0 && a.time && b.time) {
                // 將時間轉換為比較值 (例如 "13:45" -> 13.75)
                const timeValueA = convertTimeToDecimal(a.time);
                const timeValueB = convertTimeToDecimal(b.time);
                return timeValueA - timeValueB;
            }
            
            return dateDiff;
        });
        
        // 如果有 AST 數據，也做同樣排序
        if (astData.length > 0) {
            astData.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                const dateDiff = dateA - dateB;
                
                if (dateDiff === 0 && a.time && b.time) {
                    const timeValueA = convertTimeToDecimal(a.time);
                    const timeValueB = convertTimeToDecimal(b.time);
                    return timeValueA - timeValueB;
                }
                
                return dateDiff;
            });
        }
        
        // 創建圖表容器
        const chartWrapper = document.createElement('div');
        chartWrapper.className = 'chart-wrapper';
        chartWrapper.setAttribute('draggable', 'true');
        chartWrapper.setAttribute('data-test', test); // 添加測試項目標識
        
        const chartTitle = document.createElement('div');
        chartTitle.className = 'chart-title';
        
        // 為 ALT 圖表添加特殊標題，說明也包含 AST
        if (isAltChart && astData.length > 0) {
            chartTitle.textContent = `${getLabFullName(test)} 與 ${getLabFullName('AST')}`;
        } else {
            chartTitle.textContent = getLabFullName(test);
        }
        
        chartWrapper.appendChild(chartTitle);
        
        // 創建圖表控制區域
        const chartControls = document.createElement('div');
        chartControls.className = 'chart-controls';
        chartControls.style.display = 'flex';
        chartControls.style.justifyContent = 'flex-end';
        chartControls.style.marginBottom = '5px';
        chartControls.style.padding = '5px';
        chartControls.style.backgroundColor = '#f8f8f8';
        chartControls.style.borderRadius = '4px';
        chartControls.style.alignItems = 'center';
        
        // 添加控制按鈕和提示（右側）
        const controlActions = document.createElement('div');
        controlActions.style.display = 'flex';
        controlActions.style.alignItems = 'center';
        controlActions.style.gap = '10px';
        
        // 添加資料點數量顯示
        const dataPointsInfo = document.createElement('div');
        dataPointsInfo.style.fontSize = '12px';
        dataPointsInfo.style.color = '#666';
        dataPointsInfo.style.marginRight = '10px';
        dataPointsInfo.textContent = `共 ${data.length} 筆數據`;
        controlActions.appendChild(dataPointsInfo);
        
        // 添加重置縮放按鈕
        const resetZoomBtn = document.createElement('button');
        resetZoomBtn.textContent = '🔍 重置縮放';
        resetZoomBtn.style.fontSize = '11px';
        resetZoomBtn.style.padding = '6px 12px';
        resetZoomBtn.style.backgroundColor = '#4CAF50'; // 使用綠色
        resetZoomBtn.style.color = 'white'; // 白色文字
        resetZoomBtn.style.border = 'none';
        resetZoomBtn.style.borderRadius = '4px';
        resetZoomBtn.style.cursor = 'pointer';
        resetZoomBtn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)'; // 添加陰影
        resetZoomBtn.style.transition = 'all 0.3s ease'; // 添加過渡效果
        resetZoomBtn.style.display = 'none'; // 初始隱藏
        resetZoomBtn.style.fontWeight = 'bold'; // 加粗文字
        controlActions.appendChild(resetZoomBtn);

        // 添加懸停效果
        resetZoomBtn.onmouseover = function() {
            this.style.backgroundColor = '#45a049'; // 深一點的綠色
            this.style.boxShadow = '0 3px 5px rgba(0,0,0,0.3)'; // 更明顯的陰影
        };
        resetZoomBtn.onmouseout = function() {
            this.style.backgroundColor = '#4CAF50'; // 恢復原色
            this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)'; // 恢復原陰影
        };
        
        // 添加縮放提示
        const zoomHint = document.createElement('div');
        zoomHint.textContent = '滑鼠點兩下後可框選區域放大';
        zoomHint.style.fontSize = '12px';
        zoomHint.style.color = '#666';
        zoomHint.style.display = 'flex';
        zoomHint.style.alignItems = 'center';
        controlActions.appendChild(zoomHint);
        
        chartControls.appendChild(controlActions);
        
        // 將控制區添加到圖表容器
        chartWrapper.appendChild(chartControls);
        
        const canvas = document.createElement('canvas');
        canvas.id = `chart-${test}-${Date.now()}`; // 確保每個圖表有唯一ID
        chartWrapper.appendChild(canvas);
        chartContainer.appendChild(chartWrapper);
        
        // 設置圖表數據
        const dates = data.map(item => item.shortDate);
        const values = data.map(item => item.value);
        
        // 生成 x 軸坐標 - 考慮同一天多個時間點的情況
        const dateTimePoints = data.map(item => {
            const baseDate = new Date(item.date);
            
            // 如果有時間資訊，加上時間偏移
            if (item.time) {
                const [hours, minutes] = item.time.split(':').map(Number);
                baseDate.setHours(hours, minutes, 0, 0);
            }
            
            return baseDate;
        });
        
        // 計算日期範圍
        const minDate = new Date(Math.min(...dateTimePoints));
        const maxDate = new Date(Math.max(...dateTimePoints));
        
        // 轉換為時間戳記後計算間隔（天數）
        const minTimestamp = minDate.getTime();
        const maxTimestamp = maxDate.getTime();
        
        // 計算每個點到起始時間的時間間隔（天為單位，包含小數部分表示一天內的時間）
        const timeIntervals = dateTimePoints.map(dateTime => {
            const totalDays = (dateTime.getTime() - minTimestamp) / (1000 * 60 * 60 * 24);
            return totalDays;
        });
        
        // 計算日期範圍（天數）
        const dateRange = (maxTimestamp - minTimestamp) / (1000 * 60 * 60 * 24);
        
        // 動態調整標記間隔
        let dayStep;
        if (dateRange > 180) dayStep = 30;       // 超過180天，每月一個標記
        else if (dateRange > 90) dayStep = 14;   // 超過90天，每兩周一個標記
        else if (dateRange > 60) dayStep = 10;   // 超過60天，每10天一個標記
        else if (dateRange > 30) dayStep = 7;    // 超過30天，每7天一個標記
        else if (dateRange > 14) dayStep = 3;    // 超過14天，每3天一個標記
        else if (dateRange > 7) dayStep = 2;     // 超過7天，每2天一個標記
        else dayStep = 1;                        // 少於7天，每天一個標記
        
        // 確保至少有5個標記
        const estimatedTickCount = Math.floor(dateRange / dayStep);
        if (estimatedTickCount < 5 && dateRange > 5) {
            dayStep = Math.floor(dateRange / 5);
        }
        
        // 生成均勻分佈的標記
        const tickPositions = [];
        const tickLabels = [];
        
        // 日期範圍很小時的特殊處理
        if (dateRange < 0.5) {  // 如果範圍小於半天
            // 使用時間作為標記
            const hourIntervals = Math.max(1, Math.floor(dateRange * 24 / 4));  // 確保至少分4個時間段
            
            for (let hour = 0; hour <= 24; hour += hourIntervals) {
                const tickDate = new Date(minTimestamp + hour * 60 * 60 * 1000);
                if (tickDate <= maxDate) {
                    const hourStr = tickDate.getHours().toString().padStart(2, '0');
                    const minStr = tickDate.getMinutes().toString().padStart(2, '0');
                    const position = (hour / 24) * dateRange;
                    
                    tickPositions.push(position);
                    tickLabels.push(`${hourStr}:${minStr}`);
                }
            }
        } else {
            // 生成第一個標記（起始日期）
            tickPositions.push(0);
            tickLabels.push(`${minDate.getMonth() + 1}/${minDate.getDate()}`);
            
            // 生成中間標記
            for (let day = dayStep; day < dateRange; day += dayStep) {
                const tickDate = new Date(minTimestamp + day * 1000 * 60 * 60 * 24);
                const month = tickDate.getMonth() + 1;
                const dayOfMonth = tickDate.getDate();
                tickPositions.push(day);
                tickLabels.push(`${month}/${dayOfMonth}`);
            }
            
            // 確保最後一個標記存在（結束日期）
            const lastDay = dateRange;
            if (tickPositions[tickPositions.length - 1] < lastDay - dayStep/2) {
                tickPositions.push(lastDay);
                tickLabels.push(`${maxDate.getMonth() + 1}/${maxDate.getDate()}`);
            }
        }
        
        // 存儲原始圖表範圍，供重置使用
        const originalChartMin = -dayStep/10;
        const originalChartMax = dateRange + dayStep/10;
        
        // 準備數據集 - 默認包含主要數據和回歸線
        const datasets = [
            {
                label: test,
                data: timeIntervals.map((t, i) => ({
                    x: t,  // 使用實際時間間隔作為 x 值，包含時間信息
                    y: values[i],
                    // 添加原始值和特殊標記屬性，供工具提示使用
                    _rawValue: data[i].rawValue,
                    _hasSpecialMarker: 
                        (data[i].hasSpecialMarker || 
                         data[i].rawValue.toLowerCase().includes('not detected')) || false
                })),
                borderColor: getChartColor(test),
                backgroundColor: getChartColor(test, 0.2),
                borderWidth: 2,
                pointRadius: 4,
                pointStyle: 'rect',
                tension: 0.1
            }
        ];
        
        // 如果有兩個或更多資料點，添加回歸線
        if (values.length >= 2 && values.every(v => typeof v === 'number')) {
            datasets.push({
                label: `${test} 趨勢線`,
                data: timeIntervals.map((t, i) => ({
                    x: t,
                    y: linearRegression(timeIntervals, values).slope * t + linearRegression(timeIntervals, values).intercept
                })),
                borderColor: 'rgba(180, 180, 180, 0.6)',  // 淡灰色
                backgroundColor: 'rgba(180, 180, 180, 0.1)',
                borderWidth: 1,
                pointRadius: 0,
                borderDash: [4, 4],  // 虛線
                fill: false
            });
        }
        
        // 如果是 ALT 圖表，並且有 AST 數據，添加 AST 數據集和趨勢線
        if (isAltChart && astData.length > 0) {
            // 獲取 AST 數據點
            const astDateTimePoints = astData.map(item => {
                const baseDate = new Date(item.date);
                
                if (item.time) {
                    const [hours, minutes] = item.time.split(':').map(Number);
                    baseDate.setHours(hours, minutes, 0, 0);
                }
                
                return baseDate;
            });
            
            // 計算 AST 時間間隔
            const astTimeIntervals = astDateTimePoints.map(dateTime => {
                const totalDays = (dateTime.getTime() - minTimestamp) / (1000 * 60 * 60 * 24);
                return totalDays;
            });
            
            const astValues = astData.map(item => item.value);
            
            // 添加 AST 數據集
            datasets.push({
                label: 'AST',
                data: astTimeIntervals.map((t, i) => ({
                    x: t,
                    y: astValues[i],
                    // 添加原始值和特殊標記屬性
                    _rawValue: astData[i].rawValue,
                    _hasSpecialMarker: astData[i].hasSpecialMarker || false
                })),
                borderColor: getChartColor('AST'),
                backgroundColor: getChartColor('AST', 0.2),
                borderWidth: 2,
                pointRadius: 4,
                pointStyle: 'circle',  // 使用圓形標記區分 AST
                tension: 0.1
            });
            
            // 如果 AST 有兩個或更多資料點，添加 AST 回歸線
            if (astValues.length >= 2 && astValues.every(v => typeof v === 'number')) {
                datasets.push({
                    label: 'AST 趨勢線',
                    data: astTimeIntervals.map((t, i) => ({
                        x: t,
                        y: linearRegression(astTimeIntervals, astValues).slope * t + linearRegression(astTimeIntervals, astValues).intercept
                    })),
                    borderColor: 'rgba(180, 180, 180, 0.6)',  // 淡灰色
                    backgroundColor: 'rgba(180, 180, 180, 0.1)',
                    borderWidth: 1,
                    pointRadius: 0,
                    borderDash: [4, 4],  // 虛線
                    fill: false
                });
            }
        }
        
        // 創建圖表
        const chart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: dates.map((date, i) => {
                    // 為每個標籤添加時間資訊(如果有的話)
                    return data[i].time ? `${date} ${data[i].time}` : date;
                }),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: isAltChart && astData.length > 0, // 只在 ALT+AST 圖表中顯示圖例
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 6
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.label.includes('趨勢線')) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                }
                                
                                const currentTest = context.dataset.label;
                                const dataPoint = context.raw;
                                
                                // 優先從數據點直接獲取原始值
                                if (dataPoint && dataPoint._rawValue) {
                                    // 特定測試類型總是顯示原始值
                                    if (currentTest === 'CMV-DNA' || 
                                        currentTest === 'EBV DNA Q-PCR' ||
                                        currentTest === 'Aspergi-Ag-BAL' || 
                                        currentTest === 'Aspergillus-Ag') {
                                        return `${currentTest}: ${dataPoint._rawValue}`;
                                    }
                                    
                                    // 如果原始值包含特殊標記 (< 或 >)，則顯示原始值
                                    if (dataPoint._hasSpecialMarker || 
                                        dataPoint._rawValue.includes('<') || 
                                        dataPoint._rawValue.includes('>')) {
                                        return `${currentTest}: ${dataPoint._rawValue}`;
                                    }
                                }
                                
                                // 後備方案：使用舊的查找邏輯（當數據點沒有_rawValue時）
                                const dataIndex = context.dataIndex;
                                
                                // 尋找對應的原始數據
                                let originalData;
                                if (currentTest === test) {
                                    originalData = data[dataIndex];
                                } else if (currentTest === 'AST' && astData.length > 0) {
                                    // 對於 AST 數據，需要查找對應的時間點
                                    const xValue = context.parsed.x;
                                    
                                    // 找到最接近的 AST 時間點
                                    const astIndex = astTimeIntervals.findIndex(t => t === xValue);
                                    if (astIndex !== -1) {
                                        originalData = astData[astIndex];
                                    }
                                }
                                
                                if (originalData && originalData.rawValue) {
                                    // 特定測試類型總是顯示原始值
                                    if (currentTest === 'CMV-DNA' || 
                                        currentTest === 'Aspergi-Ag-BAL' || 
                                        currentTest === 'Aspergillus-Ag') {
                                        return `${currentTest}: ${originalData.rawValue}`;
                                    }
                                    
                                    // 如果原始值包含特殊標記，則顯示原始值
                                    if (originalData.rawValue.includes('<') || 
                                        originalData.rawValue.includes('>')) {
                                        return `${currentTest}: ${originalData.rawValue}`;
                                    }
                                }
                                
                                // 使用數值（對於無特殊標記的值）
                                return `${currentTest}: ${context.parsed.y}`;
                            },
                            title: function(context) {
                                // 顯示完整日期，包含年份和時間
                                const dataIndex = context[0].dataIndex;
                                const currentTest = context[0].dataset.label;
                                
                                // 根據數據集選擇正確的數據源
                                let relevantData;
                                if (currentTest === test || currentTest.includes(`${test} 趨勢線`)) {
                                    relevantData = data[dataIndex];
                                } else if ((currentTest === 'AST' || currentTest.includes('AST 趨勢線')) && astData.length > 0) {
                                    // 對於 AST 數據，需要查找對應的時間點
                                    const xValue = context[0].parsed.x;
                                    
                                    // 找到最接近的 AST 時間點
                                    const astIndex = astTimeIntervals.findIndex(t => t === xValue);
                                    if (astIndex !== -1) {
                                        relevantData = astData[astIndex];
                                    } else {
                                        // 回退方案：使用 x 值尋找最近的資料點
                                        const closestIndex = astTimeIntervals.reduce((closest, t, idx) => {
                                            return Math.abs(t - xValue) < Math.abs(astTimeIntervals[closest] - xValue) ? idx : closest;
                                        }, 0);
                                        relevantData = astData[closestIndex];
                                    }
                                }
                                
                                // 如果找到了相關數據並有時間信息，顯示完整日期時間
                                if (relevantData) {
                                    if (relevantData.time) {
                                        return `${relevantData.date} ${relevantData.time}`;
                                    }
                                    // 否則只顯示日期
                                    return relevantData.date;
                                }
                                
                                // 回退方案：顯示數據集名稱
                                return currentTest;
                            }
                        }
                    },
                    // 縮放插件設定
                    zoom: {
                        limits: {
                            x: {min: 'original', max: 'original'}, 
                            y: {min: 'original', max: 'original'}
                        },
                        pan: {
                            enabled: false, // 禁用平移功能
                        },
                        zoom: {
                            wheel: {
                                enabled: false,
                                speed: 0.1
                            },
                            pinch: {
                                enabled: true
                            },
                            drag: {
                                enabled: true, // 啟用拖曳縮放
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 0.5)',
                                borderWidth: 1,
                                threshold: 10
                            },
                            mode: 'xy',
                            onZoomComplete: function() {
                                // 縮放完成時顯示重置按鈕
                                resetZoomBtn.style.display = 'block';
                                // 縮放時自動隱藏提示
                                zoomHint.style.display = 'none';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',  // 使用線性比例
                        position: 'bottom',
                        ticks: {
                            callback: function(value, index) {
                                // 找出最接近的刻度位置
                                const closestIndex = findClosestIndex(tickPositions, value);
                                
                                // 如果值與刻度位置的差距在容許範圍內，則顯示標籤
                                // 增加容許範圍以確保所有刻度標記都能顯示
                                if (Math.abs(value - tickPositions[closestIndex]) < dayStep / 2) {
                                    return tickLabels[closestIndex];
                                }
                                return '';
                            },
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 45
                        },
                        title: {
                            display: false
                        },
                        grid: {
                            display: true
                        },
                        // 設置軸的最小值和最大值，確保包含所有標記
                        min: originalChartMin,
                        max: originalChartMax
                    },
                    y: {
                        beginAtZero: false
                    }
                },
                // 禁用動畫以避免刻度標籤閃爍
                animation: {
                    duration: 0
                }
            }
        });
        
        // 設置初始遊標樣式
        canvas.style.cursor = 'crosshair';
        
        // 為重置縮放按鈕添加事件監聽器
        resetZoomBtn.addEventListener('click', function() {
            // 重置圖表縮放
            chart.resetZoom();
            // 隱藏重置按鈕
            this.style.display = 'none';
            // 顯示提示
            zoomHint.style.display = 'flex';
        });
    }
    
    // 添加拖放功能
    setupDragAndDrop();
    
    // 添加微生物時間軸（如果需要的話）
    if (!document.querySelector('.micro-timeline-wrapper') && allOrganisms.length > 0) {
        createMicrobiologyTimeline();
    }
    
    // 應用排序
    const sortOption = document.getElementById('chartSortOption')?.value || 'default';
    if (sortOption !== 'default') {
        sortCharts(sortOption);
    }
    
    // 在函數末尾，如果是首次渲染(非過濾狀態)，設置日期選擇器的默認範圍
    if (!isFiltered) {
        // 獲取所有不同的檢測日期
        const allDates = getAllDatesFromData();
        
        if (allDates.length > 0) {
            // 設置日期選擇器的範圍
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            
            if (startDateInput && endDateInput) {
                const minDate = new Date(Math.min(...allDates.map(d => new Date(d).getTime())));
                const maxDate = new Date(Math.max(...allDates.map(d => new Date(d).getTime())));
                
                startDateInput.value = formatDateForInput(minDate);
                endDateInput.value = formatDateForInput(maxDate);
            }
        }
    }
}

// 獲取檢驗項目的完整名稱 - 增強版，支持更多檢驗項目
function getLabFullName(test) {
    const names = {
        'Cr': '肌酐酸 (Creatinine)',
        'Na': '鈉 (Sodium)',
        'K': '鉀 (Potassium)',
        'CRP': 'C-反應蛋白 (CRP)',
        'ALT': '丙氨酸轉氨酶 (ALT/GPT)',
        'AST': '天門冬胺酸轉氨酶 (AST/GOT)',
        'WBC': '白血球 (WBC)',
        'Plt': '血小板 (Platelets)',
        'Hb': '血紅素 (Hemoglobin)',
        'Bil-T': '總膽紅素 (Total Bilirubin)',
        'CMV-DNA': '巨細胞病毒 DNA定量 (CMV-DNA Q-PCR)',
        'Aspergi-Ag-BAL': '麯菌抗原 (Aspergi.Ag BAL)',
        'Aspergillus-Ag': '麯菌抗原 (Aspergillus Ag)',
        'BUN': '尿素氮 (BUN)',
        'Glucose': '血糖 (Glucose)',
        'Ca': '鈣 (Calcium)',
        'Mg': '鎂 (Magnesium)',
        'P': '磷 (Phosphorus)',
        'AST': '天門冬胺酸轉氨酶 (AST/GOT)',
        'LDH': '乳酸脫氫酶 (LDH)',
        'ALP': '鹼性磷酸酶 (ALP)',
        'Alb': '白蛋白 (Albumin)',
        'TP': '總蛋白 (Total Protein)',
        'CK': '肌酸激酶 (CK)',
        'Bil-D': '直接膽紅素 (Direct Bilirubin)',
        'T3': '三碘甲狀腺素 (T3)',
        'T4': '甲狀腺素 (T4)',
        'TSH': '促甲狀腺激素 (TSH)',
        'HbA1c': '糖化血色素 (HbA1c)',
        'Lym': '淋巴球 (Lymphocyte)',
        'Seg': '嗜中性球 (Segment)',
        'RBC': '紅血球 (RBC)',
        'Hct': '血球容積比 (Hematocrit)',
        'UA': '尿酸 (Uric Acid)',
        'ANC': '絕對嗜中性白血球計數 (ANC)',
        'P.T': '凝血酶原時間 (PT)',
        'APTT': '活化部分凝血活酶時間 (APTT)',
        'INR': '國際標準化比值 (INR)',
        'Cl': '氯 (Chloride)',
        'CO2': '二氧化碳 (CO2)',
        'pH': '酸鹼值 (pH)',
        'NH3': '氨 (Ammonia)',
        'MCH': '平均紅血球血紅素 (MCH)',
        'MCHC': '平均紅血球血紅素濃度 (MCHC)',
        'MCV': '平均紅血球體積 (MCV)'
        // 可以根據需要繼續添加
    };
    
    // 如果有預定義的名稱，返回它，否則返回原始測試代碼
    return names[test] || test;
}

// 從動態檢測項目獲取顏色
function getChartColor(test, alpha = 1) {
    // 為預定義的測試項目指定特定顏色
    const colors = {
        'Cr': `rgba(220, 53, 69, ${alpha})`,          // 紅色
        'Na': `rgba(255, 193, 7, ${alpha})`,          // 黃色
        'K': `rgba(40, 167, 69, ${alpha})`,           // 綠色
        'CRP': `rgba(111, 66, 193, ${alpha})`,        // 紫色
        'ALT': `rgba(23, 162, 184, ${alpha})`,        // 藍綠色
        'AST': `rgba(255, 64, 129, ${alpha})`,        // 粉紅色
        'WBC': `rgba(0, 123, 255, ${alpha})`,         // 藍色
        'Plt': `rgba(255, 102, 0, ${alpha})`,         // 橙色
        'Hb': `rgba(102, 16, 242, ${alpha})`,         // 靛藍色
        'Bil-T': `rgba(76, 175, 80, ${alpha})`,       // 深綠色
        'CMV-DNA': `rgba(153, 50, 204, ${alpha})`,    // 紫羅蘭色
        'Aspergi-Ag-BAL': `rgba(210, 105, 30, ${alpha})`,   // 巧克力色
        'Aspergillus-Ag': `rgba(139, 69, 19, ${alpha})`     // 鞍褐色
    };
    
    // 如果有預定義的顏色，使用它
    if (colors[test]) {
        return colors[test];
    }
    
    // 對於其他項目，使用基於項目名稱的哈希生成一致的顏色
    const hash = getStringHashCode(test);
    
    // 使用哈希生成 HSL 顏色（飽和度和亮度固定，只變色相）
    // 色相: 0-360, 飽和度: 70%, 亮度: 50%
    const hue = hash % 360;
    
    return `hsla(${hue}, 70%, 50%, ${alpha})`;
}

// 生成字符串的哈希碼
function getStringHashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0; // 轉為32位整數
    }
    return Math.abs(hash);
}

// 改進的微生物時間軸生成函數
function createMicrobiologyTimeline() {
    // 檢查是否有微生物數據
    if (allOrganisms.length === 0) return;
    
    // 在圖表容器開頭創建時間軸容器
    const chartContainer = document.getElementById('chartContainer');
    const timelineWrapper = document.createElement('div');
    timelineWrapper.className = 'chart-wrapper micro-timeline-wrapper';
    timelineWrapper.style.gridColumn = '1 / -1'; // 跨越所有列
    timelineWrapper.style.marginBottom = '30px'; // 增加下方間距
    timelineWrapper.setAttribute('draggable', 'true');
    
    const timelineTitle = document.createElement('div');
    timelineTitle.className = 'chart-title';
    timelineTitle.textContent = '微生物檢測時間軸';
    timelineTitle.style.fontSize = '16px'; // 增大標題字體
    timelineWrapper.appendChild(timelineTitle);
    
    const timelineContent = document.createElement('div');
    timelineContent.className = 'micro-timeline';
    timelineContent.style.height = '180px'; // 增加高度以容納更多信息
    timelineContent.style.position = 'relative';
    timelineContent.style.marginTop = '10px';
    timelineContent.style.padding = '20px 10px';
    timelineWrapper.appendChild(timelineContent);
    
    // 在容器開頭插入時間軸
    chartContainer.insertBefore(timelineWrapper, chartContainer.firstChild);
    
    // 獲取所有微生物數據
    const microData = [...allOrganisms];
    
    // 轉換日期為日期對象並排序
    microData.forEach(item => {
        item.dateObj = new Date(item.date);
    });
    microData.sort((a, b) => a.dateObj - b.dateObj);
    
    // 計算時間範圍
    if (microData.length === 0) return;
    
    const minDate = microData[0].dateObj;
    const maxDate = microData[microData.length - 1].dateObj;
    
    // 擴展時間範圍，前後各加 5 天
    const expandedMinDate = new Date(minDate);
    expandedMinDate.setDate(expandedMinDate.getDate() - 5);
    
    const expandedMaxDate = new Date(maxDate);
    expandedMaxDate.setDate(expandedMaxDate.getDate() + 5);
    
    // 創建水平時間軸
    const timelineAxis = document.createElement('div');
    timelineAxis.style.position = 'absolute';
    timelineAxis.style.height = '2px';
    timelineAxis.style.backgroundColor = '#ddd';
    timelineAxis.style.top = '50%';
    timelineAxis.style.left = '0';
    timelineAxis.style.right = '0';
    timelineContent.appendChild(timelineAxis);
    
    // 生成月份標記
    const monthTicks = generateMonthTicks(expandedMinDate, expandedMaxDate);
    
    monthTicks.forEach(tick => {
        const tickMark = document.createElement('div');
        tickMark.style.position = 'absolute';
        tickMark.style.left = `${tick.position}%`;
        tickMark.style.top = '50%';
        tickMark.style.height = '10px';
        tickMark.style.width = '1px';
        tickMark.style.backgroundColor = '#999';
        tickMark.style.transform = 'translateY(-50%)';
        timelineContent.appendChild(tickMark);
        
        const tickLabel = document.createElement('div');
        tickLabel.style.position = 'absolute';
        tickLabel.style.left = `${tick.position}%`;
        tickLabel.style.top = 'calc(50% + 15px)';
        tickLabel.style.transform = 'translateX(-50%)';
        tickLabel.style.fontSize = '13px'; // 增大刻度標籤字體
        tickLabel.style.color = '#666';
        tickLabel.textContent = tick.label;
        timelineContent.appendChild(tickLabel);
    });
    
    // 按類型對微生物進行分組，以便在不同行顯示
    const microTypes = ['B/C', 'Aerobic', 'Anaerobic', 'MIC', 'TB', 'Fungus'];
    const typeColors = {
        'B/C': '#dc3545', // 紅色
        'Aerobic': '#fd7e14', // 橙色
        'Anaerobic': '#6f42c1', // 紫色
        'MIC': '#17a2b8', // 藍綠色
        'TB': '#d63384', // 洋紅色
        'Fungus': '#20c997', // 薄荷綠
        'default': '#6c757d' // 灰色 - 默認顏色
    };
    
    // 創建圖例
    const legendContainer = document.createElement('div');
    legendContainer.style.display = 'flex';
    legendContainer.style.flexWrap = 'wrap';
    legendContainer.style.gap = '10px';
    legendContainer.style.marginBottom = '10px';
    legendContainer.style.fontSize = '13px'; // 增大圖例字體
    
    microTypes.forEach(type => {
        const legendItem = document.createElement('div');
        legendItem.style.display = 'flex';
        legendItem.style.alignItems = 'center';
        legendItem.style.marginRight = '10px';
        
        const colorBox = document.createElement('div');
        colorBox.style.width = '14px'; // 增大圖例色塊
        colorBox.style.height = '14px';
        colorBox.style.borderRadius = '50%';
        colorBox.style.backgroundColor = typeColors[type] || typeColors.default;
        colorBox.style.marginRight = '5px';
        
        legendItem.appendChild(colorBox);
        legendItem.appendChild(document.createTextNode(type));
        legendContainer.appendChild(legendItem);
    });
    
    timelineContent.appendChild(legendContainer);
    
    // 按日期分組微生物數據
    const microByDate = {};
    
    microData.forEach(item => {
        // 使用日期字符串作為鍵
        const dateKey = item.date; 
        if (!microByDate[dateKey]) {
            microByDate[dateKey] = [];
        }
        microByDate[dateKey].push(item);
    });
    
    // 為每個日期創建標記
    Object.keys(microByDate).forEach((dateKey, dateIndex) => {
        const itemsOnDate = microByDate[dateKey];
        const dateObj = new Date(dateKey);
        const position = calculatePosition(dateObj, expandedMinDate, expandedMaxDate);
        
        // 創建標記點 (一個日期只創建一個點)
        const marker = document.createElement('div');
        marker.className = 'micro-marker';
        marker.style.position = 'absolute';
        marker.style.left = `${position}%`;
        marker.style.top = '50%';
        marker.style.width = '12px'; // 增大標記點
        marker.style.height = '12px';
        marker.style.borderRadius = '50%';
        marker.style.backgroundColor = '#fd7e14'; // 默認標記顏色
        marker.style.transform = 'translate(-50%, -50%)';
        marker.style.cursor = 'pointer';
        marker.style.zIndex = '10';
        marker.style.transition = 'all 0.2s';
        marker.style.border = '2px solid white'; // 添加白色邊框使標記更明顯
        marker.style.boxShadow = '0 0 3px rgba(0,0,0,0.3)';
        
        // 創建包含該日期所有檢測的詳細工具提示
        const tooltip = document.createElement('div');
        tooltip.className = 'micro-tooltip';
        tooltip.style.position = 'absolute';
        tooltip.style.left = `${position}%`;
        tooltip.style.top = '0';
        tooltip.style.transform = 'translateX(-50%)';
        tooltip.style.backgroundColor = 'rgba(0,0,0,0.85)';
        tooltip.style.color = 'white';
        tooltip.style.padding = '8px 12px';
        tooltip.style.borderRadius = '5px';
        tooltip.style.fontSize = '14px'; // 增大工具提示字體
        tooltip.style.zIndex = '100';
        tooltip.style.display = 'none';
        tooltip.style.pointerEvents = 'none'; // 允許工具提示接收鼠標事件，以便按鈕點擊
        tooltip.style.minWidth = '250px'; // 增加最小寬度以容納藥敏結果
        tooltip.style.maxWidth = '450px'; // 設置最大寬度避免過寬
        tooltip.style.boxShadow = '0 3px 10px rgba(0,0,0,0.3)';
        tooltip.style.overflowY = 'auto'; // 添加滾動功能
        tooltip.style.maxHeight = '80vh'; // 最大高度為視窗高度的80%
        
        // 創建固定顯示模式下的工具提示
        const fixedTooltip = document.createElement('div');
        fixedTooltip.className = 'micro-fixed-tooltip';
        fixedTooltip.style.position = 'absolute';
        fixedTooltip.style.left = `${position}%`;
        fixedTooltip.style.top = '30px'; // 位置調整，避免與懸停提示重疊
        fixedTooltip.style.transform = 'translateX(-50%)';
        fixedTooltip.style.backgroundColor = 'rgba(255,255,255,0.95)';
        fixedTooltip.style.color = '#333';
        fixedTooltip.style.padding = '8px 12px';
        fixedTooltip.style.borderRadius = '5px';
        fixedTooltip.style.fontSize = '13px';
        fixedTooltip.style.zIndex = '99';
        fixedTooltip.style.display = 'none';
        fixedTooltip.style.pointerEvents = 'auto'; // 允許滾動和點擊
        fixedTooltip.style.minWidth = '200px';
        fixedTooltip.style.maxWidth = '350px';
        fixedTooltip.style.boxShadow = '0 3px 15px rgba(0,0,0,0.2)';
        fixedTooltip.style.overflowY = 'auto';
        fixedTooltip.style.maxHeight = '60vh';
        fixedTooltip.style.border = '1px solid #ddd';
        
        // 添加日期標題到懸停提示
        const dateHeader = document.createElement('div');
        dateHeader.style.borderBottom = '1px solid rgba(255,255,255,0.3)';
        dateHeader.style.paddingBottom = '5px';
        dateHeader.style.marginBottom = '5px';
        dateHeader.style.fontWeight = 'bold';
        dateHeader.style.display = 'flex';
        dateHeader.style.justifyContent = 'space-between';
        dateHeader.style.alignItems = 'center';
        
        const dateTitle = document.createElement('span');
        dateTitle.textContent = dateKey;
        dateHeader.appendChild(dateTitle);
        
        // 添加固定按鈕
        const pinButton = document.createElement('button');
        pinButton.textContent = '固定';
        pinButton.style.fontSize = '11px';
        pinButton.style.padding = '2px 5px';
        pinButton.style.backgroundColor = 'rgba(255,255,255,0.2)';
        pinButton.style.border = 'none';
        pinButton.style.borderRadius = '3px';
        pinButton.style.color = 'white';
        pinButton.style.cursor = 'pointer';
        pinButton.style.marginLeft = '10px';
        
        // 為按鈕添加懸停效果
        pinButton.onmouseover = function() {
            this.style.backgroundColor = 'rgba(255,255,255,0.3)';
        };
        pinButton.onmouseout = function() {
            this.style.backgroundColor = 'rgba(255,255,255,0.2)';
        };
        
        dateHeader.appendChild(pinButton);
        tooltip.appendChild(dateHeader);
        
        // 為固定提示創建標題（包含關閉按鈕）
        const fixedHeader = document.createElement('div');
        fixedHeader.style.borderBottom = '1px solid #ddd';
        fixedHeader.style.paddingBottom = '5px';
        fixedHeader.style.marginBottom = '5px';
        fixedHeader.style.fontWeight = 'bold';
        fixedHeader.style.display = 'flex';
        fixedHeader.style.justifyContent = 'space-between';
        fixedHeader.style.alignItems = 'center';
        
        const fixedTitle = document.createElement('span');
        fixedTitle.textContent = dateKey + ' (只顯示敏感藥物)';
        fixedTitle.style.color = '#333';
        fixedHeader.appendChild(fixedTitle);
        
        const closeButton = document.createElement('button');
        closeButton.textContent = '×';
        closeButton.style.fontSize = '16px';
        closeButton.style.backgroundColor = 'transparent';
        closeButton.style.border = 'none';
        closeButton.style.color = '#777';
        closeButton.style.cursor = 'pointer';
        closeButton.style.width = '24px';
        closeButton.style.height = '24px';
        closeButton.style.display = 'flex';
        closeButton.style.justifyContent = 'center';
        closeButton.style.alignItems = 'center';
        closeButton.style.borderRadius = '50%';
        
        closeButton.onmouseover = function() {
            this.style.backgroundColor = '#f0f0f0';
        };
        closeButton.onmouseout = function() {
            this.style.backgroundColor = 'transparent';
        };
        
        fixedHeader.appendChild(closeButton);
        fixedTooltip.appendChild(fixedHeader);
        
        // 為每個微生物準備懸停顯示內容
        itemsOnDate.forEach((item, index) => {
            const typeColor = typeColors[item.testType] || typeColors.default;
            
            // ===== 懸停提示的內容 =====
            const itemLine = document.createElement('div');
            itemLine.style.display = 'flex';
            itemLine.style.marginTop = index > 0 ? '8px' : '0';
            itemLine.style.alignItems = 'flex-start';
            
            // 添加微生物類型色塊
            const itemTypeMarker = document.createElement('div');
            itemTypeMarker.style.width = '10px';
            itemTypeMarker.style.height = '10px';
            itemTypeMarker.style.borderRadius = '50%';
            itemTypeMarker.style.backgroundColor = typeColor;
            itemTypeMarker.style.marginRight = '6px';
            itemTypeMarker.style.marginTop = '4px';
            itemLine.appendChild(itemTypeMarker);
            
            // 添加文字信息
            const itemInfo = document.createElement('div');
            itemInfo.style.flex = '1';
            
            // 第一行：測試類型、檢體
            const infoLine1 = document.createElement('div');
            infoLine1.style.fontWeight = 'bold';
            infoLine1.textContent = `${item.testType} ${item.specimen}`;
            itemInfo.appendChild(infoLine1);
            
            // 第二行：微生物名稱
            const infoLine2 = document.createElement('div');
            infoLine2.textContent = item.name;
            itemInfo.appendChild(infoLine2);
            
            // 第三行：生長情況 (如果有)
            if (item.growth) {
                const infoLine3 = document.createElement('div');
                infoLine3.style.fontStyle = 'italic';
                infoLine3.style.fontSize = '12px';
                infoLine3.style.color = 'rgba(255,255,255,0.8)';
                infoLine3.textContent = `"${item.growth}"`;
                itemInfo.appendChild(infoLine3);
            }
            
            // 查詢此微生物的藥敏結果
            const antibioticResults = allAntibioticResults.filter(r => 
                r.organism === item.name && r.date === item.date
            );
            
            // 如果有藥敏結果，添加到懸停顯示
            if (antibioticResults.length > 0) {
                // 添加藥敏標題
                const sensTitle = document.createElement('div');
                sensTitle.style.fontSize = '12px';
                sensTitle.style.margin = '5px 0 3px 0';
                sensTitle.style.color = 'rgba(255,255,255,0.9)';
                sensTitle.style.borderTop = '1px dotted rgba(255,255,255,0.2)';
                sensTitle.style.paddingTop = '3px';
                sensTitle.textContent = '藥敏結果:';
                itemInfo.appendChild(sensTitle);
                
                // 創建藥敏結果容器
                const sensContainer = document.createElement('div');
                sensContainer.style.display = 'flex';
                sensContainer.style.flexWrap = 'wrap';
                sensContainer.style.gap = '3px 6px';
                sensContainer.style.fontSize = '12px';
                sensContainer.style.paddingLeft = '8px';
                
                // 添加每個藥敏結果
                antibioticResults.forEach(abx => {
                    const sensItem = document.createElement('div');
                    sensItem.style.display = 'flex';
                    sensItem.style.alignItems = 'center';
                    
                    // 藥物名稱
                    const drugName = document.createElement('span');
                    drugName.style.marginRight = '4px';
                    drugName.style.fontFamily = 'monospace';
                    drugName.textContent = abx.drug;
                    
                    // 敏感性結果
                    const sensitivity = document.createElement('span');
                    sensitivity.style.padding = '1px 4px';
                    sensitivity.style.borderRadius = '3px';
                    sensitivity.style.fontWeight = 'bold';
                    sensitivity.textContent = abx.result;
                    
                    // 設置敏感性標籤樣式
                    switch (abx.result) {
                        case 'S':
                            sensitivity.style.backgroundColor = '#e8f5e9';
                            sensitivity.style.color = '#2e7d32';
                            break;
                        case 'I':
                            sensitivity.style.backgroundColor = '#fff8e1';
                            sensitivity.style.color = '#f57f17';
                            break;
                        case 'R':
                            sensitivity.style.backgroundColor = '#ffebee';
                            sensitivity.style.color = '#c62828';
                            break;
                        case 'SDD':
                            sensitivity.style.backgroundColor = '#e1f5fe';
                            sensitivity.style.color = '#0277bd';
                            break;
                        default:
                            sensitivity.style.backgroundColor = '#f3e5f5';
                            sensitivity.style.color = '#6a1b9a';
                    }
                    
                    // 添加MIC值（如果有）
                    if (abx.micValue) {
                        const micValue = document.createElement('span');
                        micValue.style.marginLeft = '3px';
                        micValue.style.fontSize = '10px';
                        micValue.style.color = 'rgba(255,255,255,0.7)';
                        micValue.textContent = `(${abx.micValue})`;
                        sensItem.appendChild(drugName);
                        sensItem.appendChild(sensitivity);
                        sensItem.appendChild(micValue);
                    } else {
                        sensItem.appendChild(drugName);
                        sensItem.appendChild(sensitivity);
                    }
                    
                    sensContainer.appendChild(sensItem);
                });
                
                itemInfo.appendChild(sensContainer);
            }
            
            itemLine.appendChild(itemInfo);
            tooltip.appendChild(itemLine);
            
            // ===== 固定提示的內容（更精簡，只顯示敏感結果）=====
            // 僅過濾敏感(S)的藥敏結果
            const sensitiveDrugs = antibioticResults.filter(r => r.result === 'S');
            
            // 無論是否有藥敏結果，都添加微生物信息到固定顯示中
            const fixedItemLine = document.createElement('div');
            fixedItemLine.style.marginBottom = '10px';
            fixedItemLine.style.paddingBottom = index < itemsOnDate.length - 1 ? '10px' : '0';
            fixedItemLine.style.borderBottom = index < itemsOnDate.length - 1 ? '1px solid #eee' : 'none';
            
            // 微生物信息標題
            const microTitle = document.createElement('div');
            microTitle.style.fontWeight = 'bold';
            microTitle.style.marginBottom = '3px';
            microTitle.style.color = typeColor;
            microTitle.textContent = `${item.testType} - ${item.name}`;
            fixedItemLine.appendChild(microTitle);
            
            // 檢體信息
            const specimenInfo = document.createElement('div');
            specimenInfo.style.fontSize = '12px';
            specimenInfo.style.color = '#666';
            specimenInfo.style.marginBottom = '5px';
            specimenInfo.textContent = `${item.specimen}${item.growth ? ` "${item.growth}"` : ''}`;
            fixedItemLine.appendChild(specimenInfo);
            
            // 只有在有敏感藥物時才顯示藥敏相關信息
            if (sensitiveDrugs.length > 0) {
                // 敏感藥物標題
                const sensHeader = document.createElement('div');
                sensHeader.style.fontSize = '12px';
                sensHeader.style.marginTop = '5px';
                sensHeader.style.color = '#2e7d32';
                sensHeader.style.fontWeight = 'bold';
                sensHeader.textContent = '敏感藥物:';
                fixedItemLine.appendChild(sensHeader);
                
                // 敏感藥物列表
                const drugsList = document.createElement('div');
                drugsList.style.display = 'flex';
                drugsList.style.flexWrap = 'wrap';
                drugsList.style.gap = '5px';
                drugsList.style.marginTop = '3px';
                drugsList.style.paddingLeft = '8px';
                
                sensitiveDrugs.forEach(drug => {
                    const drugItem = document.createElement('div');
                    drugItem.style.backgroundColor = '#e8f5e9';
                    drugItem.style.color = '#2e7d32';
                    drugItem.style.padding = '2px 6px';
                    drugItem.style.borderRadius = '3px';
                    drugItem.style.fontSize = '12px';
                    drugItem.style.fontFamily = 'monospace';
                    drugItem.textContent = drug.drug + (drug.micValue ? ` (${drug.micValue})` : '');
                    drugsList.appendChild(drugItem);
                });
                
                fixedItemLine.appendChild(drugsList);
            } else if (antibioticResults.length > 0) {
                // 有藥敏結果但沒有敏感藥物時顯示提示
                const noSensitive = document.createElement('div');
                noSensitive.style.fontSize = '12px';
                noSensitive.style.fontStyle = 'italic';
                noSensitive.style.color = '#999';
                noSensitive.textContent = '無敏感藥物';
                fixedItemLine.appendChild(noSensitive);
            }
            
            fixedTooltip.appendChild(fixedItemLine);
            
            // 如果不是最後一項，添加分隔線（僅懸停提示）
            if (index < itemsOnDate.length - 1) {
                const divider = document.createElement('div');
                divider.style.borderBottom = '1px dashed rgba(255,255,255,0.2)';
                divider.style.margin = '8px 0 0 16px';
                tooltip.appendChild(divider);
            }
        });
        
        // 設置按鈕功能
        pinButton.addEventListener('click', function(e) {
            e.stopPropagation(); // 防止事件冒泡
            fixedTooltip.style.display = 'block';
        });
        
        closeButton.addEventListener('click', function(e) {
            e.stopPropagation(); // 防止事件冒泡
            fixedTooltip.style.display = 'none';
        });
        
        // 設置懸停效果
        marker.addEventListener('mouseover', function() {
            this.style.width = '16px';
            this.style.height = '16px';
            this.style.boxShadow = '0 0 6px rgba(0,0,0,0.5)';
            tooltip.style.display = 'block';
            tooltip.style.pointerEvents = 'auto'; // 允許在工具提示上互動
        });
        
        marker.addEventListener('mouseout', function(e) {
            // 檢查滑鼠是否移到工具提示上
            if (!e.relatedTarget || !tooltip.contains(e.relatedTarget)) {
                this.style.width = '12px';
                this.style.height = '12px';
                this.style.boxShadow = '0 0 3px rgba(0,0,0,0.3)';
                tooltip.style.display = 'none';
                tooltip.style.pointerEvents = 'none';
            }
        });
        
        // 滑鼠離開工具提示時隱藏
        tooltip.addEventListener('mouseleave', function() {
            marker.style.width = '12px';
            marker.style.height = '12px';
            marker.style.boxShadow = '0 0 3px rgba(0,0,0,0.3)';
            tooltip.style.display = 'none';
            tooltip.style.pointerEvents = 'none';
        });
        
        // 交錯顯示日期標籤，避免重疊
        const offset = dateIndex % 2 === 0 ? -35 : 35;
        
        // 創建日期標籤
        const dateLabel = document.createElement('div');
        dateLabel.className = 'micro-date-label';
        dateLabel.style.position = 'absolute';
        dateLabel.style.left = `${position}%`;
        dateLabel.style.top = `calc(50% - ${offset}px)`;
        dateLabel.style.transform = 'translateX(-50%)';
        dateLabel.style.fontSize = '13px'; // 增大日期標籤字體
        dateLabel.style.color = '#333';
        dateLabel.style.fontWeight = 'bold';
        dateLabel.style.backgroundColor = 'rgba(255,255,255,0.8)';
        dateLabel.style.padding = '2px 5px';
        dateLabel.style.borderRadius = '3px';
        dateLabel.textContent = dateKey.split('/').slice(1).join('/'); // 只顯示月/日
        
        // 添加元素到時間軸
        timelineContent.appendChild(marker);
        timelineContent.appendChild(dateLabel);
        timelineContent.appendChild(tooltip);
        timelineContent.appendChild(fixedTooltip);
    });
    
    // 添加查看詳情按鈕
    const detailButton = document.createElement('button');
    detailButton.textContent = '查看詳細微生物結果';
    detailButton.style.position = 'absolute';
    detailButton.style.bottom = '5px';
    detailButton.style.right = '10px';
    detailButton.style.padding = '6px 12px';
    detailButton.style.fontSize = '13px'; // 增大按鈕字體
    detailButton.style.backgroundColor = '#6c757d';
    detailButton.style.color = 'white';
    detailButton.style.border = 'none';
    detailButton.style.borderRadius = '4px';
    detailButton.style.cursor = 'pointer';
    
    detailButton.onclick = function() {
        // 切換到微生物標籤頁
        openTab({ currentTarget: document.querySelector('.tab-button[onclick*="microTab"]') }, 'microTab');
    };
    
    timelineContent.appendChild(detailButton);
    
    // 添加微生物計數信息
    const countInfo = document.createElement('div');
    countInfo.style.position = 'absolute';
    countInfo.style.bottom = '5px';
    countInfo.style.left = '10px';
    countInfo.style.fontSize = '13px';
    countInfo.style.color = '#555';
    countInfo.textContent = `共 ${microData.length} 筆微生物檢測結果，${Object.keys(microByDate).length} 個檢測日期`;
    
    timelineContent.appendChild(countInfo);
}

// 計算日期在時間軸上的相對位置
function calculatePosition(date, minDate, maxDate) {
    const totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24);
    const dayPosition = (date - minDate) / (1000 * 60 * 60 * 24);
    return (dayPosition / totalDays) * 100;
}

// 生成月份刻度標記
function generateMonthTicks(minDate, maxDate) {
    const ticks = [];
    const currentDate = new Date(minDate);
    
    // 設置為當月第一天
    currentDate.setDate(1);
    
    // 如果第一天不是報告的起始日，添加起始日標記
    if (currentDate.getTime() > minDate.getTime()) {
        ticks.push({
            date: new Date(minDate),
            position: 0,
            label: `${minDate.getMonth() + 1}/${minDate.getDate()}`
        });
    }
    
    // 向後叠代每個月的1號，直到超過最大日期
    while (currentDate <= maxDate) {
        const position = calculatePosition(currentDate, minDate, maxDate);
        
        ticks.push({
            date: new Date(currentDate),
            position: position,
            label: `${currentDate.getMonth() + 1}/1`
        });
        
        // 前進到下個月的1號
        currentDate.setMonth(currentDate.getMonth() + 1);
    }
    
    // 添加最後一個日期標記
    if (ticks[ticks.length - 1].date.getTime() < maxDate.getTime()) {
        ticks.push({
            date: new Date(maxDate),
            position: 100,
            label: `${maxDate.getMonth() + 1}/${maxDate.getDate()}`
        });
    }
    
    return ticks;
}

// 移除原有的微生物標記圖例
document.addEventListener('DOMContentLoaded', function() {
    const oldLegend = document.querySelector('.micro-marker-legend');
    if (oldLegend) {
        oldLegend.style.display = 'none';
    }
});

// 整合動態趨勢圖功能到您的應用程序
// 在檔案載入時初始化動態趨勢圖
document.addEventListener('DOMContentLoaded', function() {
    // 檢查是否有 #chartTab 元素
    const chartTab = document.getElementById('chartTab');
    if (chartTab) {
        // 在趨勢圖標籤頁底部添加說明
        const tabNote = document.createElement('div');
        tabNote.style.marginTop = '10px';
        tabNote.style.padding = '10px';
        tabNote.style.backgroundColor = '#f8f9fa';
        tabNote.style.borderRadius = '4px';
        tabNote.style.fontSize = '13px';
        tabNote.style.color = '#666';
        tabNote.innerHTML = `
            <div>趨勢圖功能已增強：您可以選擇"所有項目"查看所有檢驗結果，或使用"自定義選擇"選擇特定項目，並可透過搜尋和排序功能快速找到需要的圖表。</div>
        `;
        chartTab.appendChild(tabNote);
    }
});

// 設置拖放功能
function setupDragAndDrop() {
    const chartWrappers = document.querySelectorAll('.chart-wrapper');
    let draggedItem = null;
    
    chartWrappers.forEach(wrapper => {
        // 拖動開始
        wrapper.addEventListener('dragstart', function(e) {
            draggedItem = this;
            setTimeout(() => {
                this.style.opacity = '0.5';
            }, 0);
        });
        
        // 拖動結束
        wrapper.addEventListener('dragend', function() {
            this.style.opacity = '1';
            draggedItem = null;
        });
        
        // 拖動進入目標區域
        wrapper.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        // 拖動進入目標
        wrapper.addEventListener('dragenter', function(e) {
            e.preventDefault();
            this.style.border = '2px dashed #666';
        });
        
        // 拖動離開目標
        wrapper.addEventListener('dragleave', function() {
            this.style.border = 'none';
        });
        
        // 放下
        wrapper.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.border = 'none';
            
            if (draggedItem !== this) {
                const allItems = Array.from(document.querySelectorAll('.chart-wrapper'));
                const container = document.getElementById('chartContainer');
                
                const draggedIndex = allItems.indexOf(draggedItem);
                const dropIndex = allItems.indexOf(this);
                
                if (dropIndex < draggedIndex) {
                    container.insertBefore(draggedItem, this);
                } else {
                    container.insertBefore(draggedItem, this.nextSibling);
                }
            }
        });
    });
}

// 添加函數用於從完整藥名中提取基本藥物名稱
function getBaseDrugName(drug) {
    // 檢查是否包含濃度信息 (括號內)
    const concentrationMatch = drug.match(/(.+?)\s*\(([^)]+)\)/);
    if (concentrationMatch) {
        return concentrationMatch[1].trim();
    }
    return drug;
}

// 添加專門處理 TB 藥物分組的輔助函數

/**
 * 對 TB 藥物結果進行分組和整理
 * @param {Array} tbDrugs - TB 藥物結果數組
 * @return {Object} 分組後的藥物結果
 */
function groupTBDrugs(tbDrugs) {
    // 按基本藥物名稱分組
    const groupedDrugs = {};
    
    tbDrugs.forEach(drug => {
        const baseName = getBaseDrugName(drug.drug);
        if (!groupedDrugs[baseName]) {
            groupedDrugs[baseName] = [];
        }
        groupedDrugs[baseName].push(drug);
    });
    
    // 為每組藥物添加不同濃度的結果
    const organizedDrugs = {};
    
    Object.keys(groupedDrugs).forEach(baseName => {
        // 按濃度值排序（如果有）
        groupedDrugs[baseName].sort((a, b) => {
            // 提取濃度數值進行比較
            const getConcentrationValue = (drug) => {
                if (!drug.concentration) return 0;
                const match = drug.concentration.match(/(\d+(\.\d+)?)/);
                return match ? parseFloat(match[1]) : 0;
            };
            
            return getConcentrationValue(a) - getConcentrationValue(b);
        });
        
        // 將同類藥物整理為一個條目
        const firstDrug = groupedDrugs[baseName][0];
        organizedDrugs[baseName] = {
            baseName: baseName,
            variations: groupedDrugs[baseName].map(d => ({
                fullName: d.drug,
                concentration: d.concentration || '',
                result: d.result
            })),
            // 保留原始信息用於其他處理
            organism: firstDrug.organism,
            testType: firstDrug.testType,
            specimen: firstDrug.specimen,
            date: firstDrug.date,
            shortDate: firstDrug.shortDate
        };
    });
    
    return organizedDrugs;
}

/**
 * 在表格中顯示 TB 藥物的所有濃度變體
 * @param {Object} drugInfo - 藥物信息
 * @param {HTMLTableRowElement} drugRow - 表格行元素
 */
function renderTBDrugVariations(drugInfo, drugRow) {
    // 藥物名稱單元格已在調用函數中創建
    
    // 添加結果單元格
    drugInfo.variations.forEach((variation, index) => {
        const resultCell = document.createElement('td');
        resultCell.className = `sensitivity-${variation.result}`;
        
        // 添加結果和濃度信息
        resultCell.innerHTML = `
            <span>${variation.result}</span>
            ${variation.concentration ? 
              `<span style="display: block; font-size: 9px; color: #777;">${variation.concentration}</span>` : 
              ''}
        `;
        
        drugRow.appendChild(resultCell);
    });
}

// 從動態檢測項目獲取顏色
function getChartColor(test, alpha = 1) {
    // 為預定義的測試項目指定特定顏色
    const colors = {
        // 監控項目的顏色
        'Cr': `rgba(220, 53, 69, ${alpha})`,          // 紅色
        'Na': `rgba(255, 193, 7, ${alpha})`,          // 黃色
        'K': `rgba(40, 167, 69, ${alpha})`,           // 綠色
        'CRP': `rgba(111, 66, 193, ${alpha})`,        // 紫色
        'ALT': `rgba(23, 162, 184, ${alpha})`,        // 藍綠色
        'WBC': `rgba(0, 123, 255, ${alpha})`,         // 藍色
        'Plt': `rgba(255, 102, 0, ${alpha})`,         // 橙色
        'Hb': `rgba(102, 16, 242, ${alpha})`,         // 靛藍色
        'Bil-T': `rgba(76, 175, 80, ${alpha})`,       // 深綠色
        'CMV-DNA': `rgba(153, 50, 204, ${alpha})`,    // 紫羅蘭色
        'Aspergi-Ag-BAL': `rgba(210, 105, 30, ${alpha})`,   // 巧克力色
        'Aspergillus-Ag': `rgba(139, 69, 19, ${alpha})`,     // 鞍褐色
        
        // 添加更多常見檢驗項目的顏色
        'AST': `rgba(255, 64, 129, ${alpha})`,        // 粉紅色
        'BUN': `rgba(121, 85, 72, ${alpha})`,         // 棕色
        'Glucose': `rgba(0, 150, 136, ${alpha})`,     // 青綠色
        'Alb': `rgba(63, 81, 181, ${alpha})`,         // 靛藍色
        'TP': `rgba(103, 58, 183, ${alpha})`,         // 深紫色
        'Bil-D': `rgba(139, 195, 74, ${alpha})`,      // 亮綠色
        'Seg': `rgba(233, 30, 99, ${alpha})`,         // 粉紅色
        'Lym': `rgba(156, 39, 176, ${alpha})`,        // 紫色
        'ALP': `rgba(255, 235, 59, ${alpha})`,        // 檸檬色
        'Ca': `rgba(255, 152, 0, ${alpha})`,          // 橙色
        'Mg': `rgba(96, 125, 139, ${alpha})`,         // 藍灰色
        'P': `rgba(33, 150, 243, ${alpha})`,          // 亮藍色
        'RBC': `rgba(244, 67, 54, ${alpha})`,         // 亮紅色
        'Hct': `rgba(121, 85, 72, ${alpha})`,         // 深棕色
        'T3': `rgba(0, 188, 212, ${alpha})`,          // 青色
        'T4': `rgba(3, 169, 244, ${alpha})`,          // 淺藍色
        'TSH': `rgba(121, 85, 72, ${alpha})`,         // 棕色
        'INR': `rgba(255, 87, 34, ${alpha})`          // 深橙色
    };
    
    // 如果有預定義的顏色，使用它
    if (colors[test]) {
        return colors[test];
    }
    
    // 對於其他項目，使用基於項目名稱的哈希生成一致的顏色
    const hash = getStringHashCode(test);
    
    // 使用哈希生成 HSL 顏色（飽和度和亮度固定，只變色相）
    // 色相: 0-360, 飽和度: 70%, 亮度: 50%
    const hue = hash % 360;
    
    return `hsla(${hue}, 70%, 50%, ${alpha})`;
}
// 頁籤切換功能
function openTab(evt, tabName) {
    // 隱藏所有頁籤內容
    const tabContents = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
    }
    
    // 取消所有頁籤按鈕的活動狀態
    const tabButtons = document.getElementsByClassName("tab-button");
    for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
    }
    
    // 顯示當前頁籤內容並將按鈕設為活動狀態
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
    
    // 如果切換到圖表頁籤，確保圖表正確顯示
    if (tabName === 'chartTab' && labData.length > 0) {
        setTimeout(() => {
            window.dispatchEvent(new Event('resize'));
        }, 10);
    }
    
    // 如果切換到表格頁籤且尚未初始化，進行初始化
    if (tabName === 'summaryTab' && labData.length > 0) {
        const summaryControls = document.getElementById('summaryControls');
        if (!summaryControls.innerHTML.trim()) {
            initSummaryTab();
        }
    }
}
// 輔助函數：將時間字符串轉換為小數值以便比較
// 例如："13:45" -> 13.75
function convertTimeToDecimal(timeStr) {
    if (!timeStr) return 0;
    
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours + (minutes / 60);
}

// 添加到 HTML head 的 JavaScript，自動加載 Chart.js 縮放插件
function addZoomPluginScript() {
    if (!Chart.registry.getPlugin('zoom')) {
        console.warn('Chart.js Zoom 插件未找到或未正確載入');
        return false;
    }
    return true;
}

// ======== 時間範圍選擇功能 ========

// 從所有數據中獲取日期列表
function getAllDatesFromData() {
    const allDates = [];
    
    labData.forEach(item => {
        if (item.date && !allDates.includes(item.date)) {
            allDates.push(item.date);
        }
    });
    
    return allDates;
}

// 格式化日期為 input 元素使用的格式 (YYYY-MM-DD)
function formatDateForInput(date) {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// 創建日期範圍選擇器
function addDateRangeSelector(toolsArea) {
    // 創建日期範圍選擇容器
    const dateRangeContainer = document.createElement('div');
    dateRangeContainer.className = 'date-range-container';
    dateRangeContainer.style.display = 'flex';
    dateRangeContainer.style.alignItems = 'center';
    dateRangeContainer.style.marginRight = '15px';
    dateRangeContainer.style.marginBottom = '5px';
    
    // 創建日期範圍標籤
    const dateRangeLabel = document.createElement('span');
    dateRangeLabel.textContent = '時間範圍: ';
    dateRangeLabel.style.marginRight = '5px';
    dateRangeLabel.style.fontSize = '13px';
    dateRangeContainer.appendChild(dateRangeLabel);
    
    // 創建日期範圍選擇下拉框
    const dateRangeSelect = document.createElement('select');
    dateRangeSelect.id = 'dateRangeSelect';
    dateRangeSelect.style.padding = '6px 10px';
    dateRangeSelect.style.borderRadius = '4px';
    dateRangeSelect.style.border = '1px solid #ced4da';
    dateRangeSelect.style.marginRight = '10px';
    
    // 添加日期範圍選項
    const rangeOptions = [
        { value: 'all', label: '全部數據' },
        { value: 'last7', label: '最近 7 天' },
        { value: 'last14', label: '最近 14 天' },
        { value: 'last30', label: '最近 30 天' },
        { value: 'last90', label: '最近 90 天' },
        { value: 'custom', label: '自定義範圍' }
    ];
    
    rangeOptions.forEach(option => {
        const optElement = document.createElement('option');
        optElement.value = option.value;
        optElement.textContent = option.label;
        dateRangeSelect.appendChild(optElement);
    });
    
    dateRangeContainer.appendChild(dateRangeSelect);
    
    // 創建自定義日期範圍容器
    const customDateContainer = document.createElement('div');
    customDateContainer.id = 'customDateContainer';
    customDateContainer.style.display = 'none';
    customDateContainer.style.alignItems = 'center';
    customDateContainer.style.flexWrap = 'wrap';
    
    // 創建起始日期選擇
    const startDateLabel = document.createElement('span');
    startDateLabel.textContent = '起始: ';
    startDateLabel.style.marginRight = '5px';
    startDateLabel.style.fontSize = '13px';
    customDateContainer.appendChild(startDateLabel);
    
    const startDateInput = document.createElement('input');
    startDateInput.type = 'date';
    startDateInput.id = 'startDateInput';
    startDateInput.style.padding = '5px';
    startDateInput.style.borderRadius = '4px';
    startDateInput.style.border = '1px solid #ced4da';
    startDateInput.style.marginRight = '10px';
    customDateContainer.appendChild(startDateInput);
    
    // 創建結束日期選擇
    const endDateLabel = document.createElement('span');
    endDateLabel.textContent = '結束: ';
    endDateLabel.style.marginRight = '5px';
    endDateLabel.style.fontSize = '13px';
    customDateContainer.appendChild(endDateLabel);
    
    const endDateInput = document.createElement('input');
    endDateInput.type = 'date';
    endDateInput.id = 'endDateInput';
    endDateInput.style.padding = '5px';
    endDateInput.style.borderRadius = '4px';
    endDateInput.style.border = '1px solid #ced4da';
    endDateInput.style.marginRight = '10px';
    customDateContainer.appendChild(endDateInput);
    
    // 創建應用按鈕
    const applyButton = document.createElement('button');
    applyButton.textContent = '應用';
    applyButton.style.padding = '5px 10px';
    applyButton.style.backgroundColor = '#4CAF50';
    applyButton.style.color = 'white';
    applyButton.style.border = 'none';
    applyButton.style.borderRadius = '4px';
    applyButton.style.cursor = 'pointer';
    customDateContainer.appendChild(applyButton);
    
    dateRangeContainer.appendChild(customDateContainer);
    
    // 設置日期範圍選擇的變更事件
    dateRangeSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            customDateContainer.style.display = 'flex';
            
            // 設置起始日期為最早的資料日期
            const allDates = getAllDatesFromData();
            if (allDates.length > 0) {
                const minDate = new Date(Math.min(...allDates.map(d => new Date(d).getTime())));
                const maxDate = new Date(Math.max(...allDates.map(d => new Date(d).getTime())));
                
                startDateInput.value = formatDateForInput(minDate);
                endDateInput.value = formatDateForInput(maxDate);
            }
        } else {
            customDateContainer.style.display = 'none';
            applyDateRangeFilter(this.value);
        }
    });
    
    // 設置應用按鈕點擊事件
    applyButton.addEventListener('click', function() {
        applyCustomDateRange();
    });
    
    // 將日期範圍選擇器添加到工具區域
    toolsArea.insertBefore(dateRangeContainer, toolsArea.firstChild);
}

// 應用日期範圍過濾器
function applyDateRangeFilter(rangeType) {
    // 獲取分組數據
    const groupedData = {};
    let filteredLabData = [...labData]; // 創建副本以避免修改原始數據
    
    // 根據選擇的範圍過濾數據
    if (rangeType !== 'all') {
        const now = new Date();
        let startDate;
        
        switch (rangeType) {
            case 'last7':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 7);
                break;
            case 'last14':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 14);
                break;
            case 'last30':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 30);
                break;
            case 'last90':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - 90);
                break;
        }
        
        // 過濾數據以僅包含範圍內的日期
        if (startDate) {
            filteredLabData = filteredLabData.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate >= startDate && itemDate <= now;
            });
        }
    }
    
    // 更新可用的測試項目列表
    const availableTests = new Set();
    filteredLabData.forEach(item => {
        availableTests.add(item.test);
    });
    
    // 按測試類型分組過濾後的數據
    filteredLabData.forEach(item => {
        if (!groupedData[item.test]) {
            groupedData[item.test] = [];
        }
        groupedData[item.test].push(item);
    });
    
    // 獲取當前顯示模式
    const currentMode = document.querySelector('.mode-button.active').id.replace('mode-', '');
    
    // 根據模式選擇要顯示的測試項目
    let selectedTests = [];
    
    switch(currentMode) {
        case 'monitored':
            // 只顯示在過濾數據中存在的監控項目
            selectedTests = monitoredLabs.filter(test => availableTests.has(test));
            break;
        case 'all':
            selectedTests = Array.from(availableTests);
            break;
        case 'custom':
            // 獲取用戶自定義選擇的項目
            selectedTests = Array.from(document.querySelectorAll('.test-checkbox:checked')).map(cb => cb.value);
            // 只保留在過濾數據中存在的項目
            selectedTests = selectedTests.filter(test => availableTests.has(test));
            break;
        default:
            selectedTests = monitoredLabs.filter(test => availableTests.has(test));
    }
    
    // 使用過濾後的數據渲染圖表
    renderSelectedCharts(groupedData, selectedTests, true);
    
    // 更新日期範圍提示
    updateDateRangeInfo(rangeType);
}

// 應用自定義日期範圍
function applyCustomDateRange() {
    const startDateValue = document.getElementById('startDateInput').value;
    const endDateValue = document.getElementById('endDateInput').value;
    
    if (!startDateValue || !endDateValue) {
        alert('請選擇有效的起始和結束日期');
        return;
    }
    
    const startDate = new Date(startDateValue);
    const endDate = new Date(endDateValue);
    
    // 設置結束日期為當天的最後一刻，以包含該天的所有數據
    endDate.setHours(23, 59, 59, 999);
    
    if (startDate > endDate) {
        alert('起始日期不能晚於結束日期');
        return;
    }
    
    // 過濾數據以僅包含範圍內的日期
    const filteredLabData = labData.filter(item => {
        const itemDate = new Date(item.date);
        return itemDate >= startDate && itemDate <= endDate;
    });
    
    // 檢查是否有數據
    if (filteredLabData.length === 0) {
        alert('所選時間範圍內沒有數據');
        return;
    }
    
    // 更新可用的測試項目列表
    const availableTests = new Set();
    filteredLabData.forEach(item => {
        availableTests.add(item.test);
    });
    
    // 按測試類型分組過濾後的數據
    const groupedData = {};
    filteredLabData.forEach(item => {
        if (!groupedData[item.test]) {
            groupedData[item.test] = [];
        }
        groupedData[item.test].push(item);
    });
    
    // 獲取當前顯示模式
    const currentMode = document.querySelector('.mode-button.active').id.replace('mode-', '');
    
    // 根據模式選擇要顯示的測試項目
    let selectedTests = [];
    
    switch(currentMode) {
        case 'monitored':
            // 只顯示在過濾數據中存在的監控項目
            selectedTests = monitoredLabs.filter(test => availableTests.has(test));
            break;
        case 'all':
            selectedTests = Array.from(availableTests);
            break;
        case 'custom':
            // 獲取用戶自定義選擇的項目
            selectedTests = Array.from(document.querySelectorAll('.test-checkbox:checked')).map(cb => cb.value);
            // 只保留在過濾數據中存在的項目
            selectedTests = selectedTests.filter(test => availableTests.has(test));
            break;
        default:
            selectedTests = monitoredLabs.filter(test => availableTests.has(test));
    }
    
    // 使用過濾後的數據渲染圖表
    renderSelectedCharts(groupedData, selectedTests, true);
    
    // 更新日期範圍提示
    updateDateRangeInfo('custom', startDate, endDate);
}

// 更新日期範圍提示信息
function updateDateRangeInfo(rangeType, startDate, endDate) {
    let infoText = '';
    
    switch (rangeType) {
        case 'all':
            infoText = '顯示全部數據';
            break;
        case 'last7':
            infoText = '顯示最近 7 天數據';
            break;
        case 'last14':
            infoText = '顯示最近 14 天數據';
            break;
        case 'last30':
            infoText = '顯示最近 30 天數據';
            break;
        case 'last90':
            infoText = '顯示最近 90 天數據';
            break;
        case 'custom':
            if (startDate && endDate) {
                const formatDate = (date) => {
                    return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                };
                infoText = `顯示 ${formatDate(startDate)} 至 ${formatDate(endDate)} 間的數據`;
            } else {
                infoText = '顯示自定義範圍數據';
            }
            break;
        default:
            infoText = '顯示全部數據';
    }
    
    // 移除舊的提示信息
    const oldInfo = document.getElementById('dateRangeInfo');
    if (oldInfo) {
        oldInfo.remove();
    }
    
    // 創建新的提示信息
    const infoElement = document.createElement('div');
    infoElement.id = 'dateRangeInfo';
    infoElement.style.gridColumn = '1 / -1';
    infoElement.style.marginBottom = '15px';
    infoElement.style.padding = '8px 15px';
    infoElement.style.backgroundColor = '#e8f5fe';
    infoElement.style.borderRadius = '4px';
    infoElement.style.color = '#1890ff';
    infoElement.style.fontSize = '14px';
    infoElement.style.fontWeight = 'bold';
    infoElement.style.display = 'flex';
    infoElement.style.justifyContent = 'space-between';
    infoElement.style.alignItems = 'center';
    
    infoElement.innerHTML = `
        <span>${infoText}</span>
        <button id="resetDateRange" style="background-color: transparent; border: none; color: #1890ff; cursor: pointer; text-decoration: underline; padding: 0;">重置為全部數據</button>
    `;
    
    // 將提示信息添加到圖表容器
    const chartContainer = document.getElementById('chartContainer');
    const controlPanel = document.getElementById('chartControlPanel');
    
    if (controlPanel && chartContainer) {
        chartContainer.insertBefore(infoElement, controlPanel.nextSibling);
    }
    
    // 添加重置按鈕事件
    document.getElementById('resetDateRange').addEventListener('click', function() {
        document.getElementById('dateRangeSelect').value = 'all';
        document.getElementById('customDateContainer').style.display = 'none';
        applyDateRangeFilter('all');
    });
}

// 修改 DOMContentLoaded 事件監聽器，更新說明文字
document.addEventListener('DOMContentLoaded', function() {
    // 檢查插件是否已載入
    const zoomPluginLoaded = Chart.registry.getPlugin('zoom') !== undefined;
    if (!zoomPluginLoaded) {
        console.warn('Chart.js Zoom 插件未找到或未正確載入');
    }
    
    // 在圖表標籤頁添加操作說明
    const tabNote = document.createElement('div');
    tabNote.style.marginTop = '10px';
    tabNote.style.padding = '10px';
    tabNote.style.backgroundColor = '#f8f8f8';
    tabNote.style.borderRadius = '4px';
    tabNote.style.fontSize = '13px';
    tabNote.style.color = '#666';
    tabNote.innerHTML = `
        <div style="margin-bottom: 5px; font-weight: bold;">趨勢圖操作指南：</div>
        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            <div style="min-width: 200px;">
                <div style="font-weight: bold; color: #1890ff;">縮放功能：</div>
                <ul style="margin: 5px 0 0 20px; padding: 0;">
                    <li>滑鼠點兩下後拖曳可選擇區域放大</li>
                    <li>點「重置縮放」可恢復原圖</li>
                </ul>
            </div>
            <div style="min-width: 200px;">
                <div style="font-weight: bold; color: #fa8c16;">其他功能：</div>
                <ul style="margin: 5px 0 0 20px; padding: 0;">
                    <li>同一天的多筆資料按時間順序排列</li>
                    <li>可拖曳調整圖表位置順序</li>
                    <li>搜尋和排序功能快速找到所需圖表</li>
                </ul>
            </div>
        </div>
    `;
    
    const chartTab = document.getElementById('chartTab');
    if (chartTab) {
        // 檢查是否已經添加了說明
        const existingNote = chartTab.querySelector('div[style*="margin-top: 10px"]');
        if (existingNote) {
            chartTab.replaceChild(tabNote, existingNote);
        } else {
            chartTab.appendChild(tabNote);
        }
    }
});

// 註冊初始化函數，在頁面加載完成後執行
document.addEventListener('DOMContentLoaded', function() {
    // 檢查是否已經初始化
    if (typeof window.timeRangeInitialized === 'undefined') {
        // 初始化時間範圍選擇功能
        initTimeRangeFeature();
        
        // 標記已初始化
        window.timeRangeInitialized = true;
    }
});

// 添加高級排序切換按鈕
function addAdvancedSortButton() {
    // 檢查是否已經添加過按鈕
    if (document.getElementById('advancedSort')) {
        return;
    }
    
    // 創建新按鈕
    const sortButton = document.createElement('button');
    sortButton.id = 'advancedSort';
    sortButton.innerHTML = '切換排序 <span id="sortModeIcon">T↑</span>';
    sortButton.title = '切換排序模式 (時間升序/時間降序/項目升序/項目降序)';
    
    // 套用與其他按鈕一致的樣式
    sortButton.style.marginRight = '10px';
    sortButton.style.padding = '10px 20px';
    sortButton.style.cursor = 'pointer';
    sortButton.style.backgroundColor = '#4CAF50'; // 初始為綠色
    sortButton.style.color = 'white';
    sortButton.style.border = 'none';
    sortButton.style.borderRadius = '4px';
    
    // 添加懸停效果
    sortButton.onmouseover = function() {
        this.style.backgroundColor = '#45a049';
    };
    sortButton.onmouseout = function() {
        // 根據當前模式設置顏色
        const mode = parseInt(this.getAttribute('data-mode') || '1');
        switch(mode) {
            case 1: this.style.backgroundColor = '#4CAF50'; break; // 時間升序
            case 2: this.style.backgroundColor = '#2196F3'; break; // 時間降序
            case 3: this.style.backgroundColor = '#FF9800'; break; // 項目升序
            case 4: this.style.backgroundColor = '#9C27B0'; break; // 項目降序
        }
    };
    
    // 設置初始排序模式（1: 時間升序）
    sortButton.setAttribute('data-mode', '1');
    
    // 添加點擊事件
    sortButton.onclick = function() {
        advancedSortText(this);
    };
    
    // 將按鈕插入到現有的按鈕容器中
    const buttonContainer = document.querySelector('.button-container');
    if (buttonContainer) {
        // 尋找「上下對調」按鈕位置，插在它之後
        const toggleOrderButton = document.querySelector('button[onclick="toggleOrder()"]');
        if (toggleOrderButton) {
            buttonContainer.insertBefore(sortButton, toggleOrderButton.nextSibling);
        } else {
            // 如果找不到特定按鈕，添加到容器末尾
            buttonContainer.appendChild(sortButton);
        }
    }
}

// 高級排序函數
function advancedSortText(button) {
    const outputElement = document.getElementById('output');
    if (!outputElement || !outputElement.textContent.trim()) {
        return; // 如果沒有文字內容，不執行任何操作
    }
    
    // 獲取當前顯示的文字內容
    const textContent = outputElement.textContent;
    
    // 按行分割
    let lines = textContent.split('\n').filter(line => line.trim());
    
    // 獲取並更新當前模式
    let currentMode = parseInt(button.getAttribute('data-mode') || '1');
    let nextMode = (currentMode % 4) + 1;
    button.setAttribute('data-mode', nextMode.toString());
    
    // 根據新模式更新圖標和顏色
    const iconElement = document.getElementById('sortModeIcon');
    switch(nextMode) {
        case 1: // 時間升序
            if (iconElement) iconElement.textContent = 'T↑';
            button.title = '時間升序 - 點擊切換為時間降序';
            button.style.backgroundColor = '#4CAF50'; // 綠色
            break;
        case 2: // 時間降序
            if (iconElement) iconElement.textContent = 'T↓';
            button.title = '時間降序 - 點擊切換為項目升序';
            button.style.backgroundColor = '#2196F3'; // 藍色
            break;
        case 3: // 項目升序
            if (iconElement) iconElement.textContent = 'I↑';
            button.title = '項目升序 - 點擊切換為項目降序';
            button.style.backgroundColor = '#FF9800'; // 橙色
            break;
        case 4: // 項目降序
            if (iconElement) iconElement.textContent = 'I↓';
            button.title = '項目降序 - 點擊切換為時間升序';
            button.style.backgroundColor = '#9C27B0'; // 紫色
            break;
    }
    
    // 應用排序邏輯
    lines = sortLines(lines, nextMode);
    
    // 更新顯示內容
    outputElement.textContent = lines.join('\n');
    
    // 添加視覺反饋
    const originalColor = button.style.backgroundColor;
    button.style.animation = 'pulse 0.3s';
    setTimeout(() => {
        button.style.animation = '';
    }, 300);
    
    // 添加一個簡短的提示顯示當前排序模式
    showSortNotification(nextMode);
}

// 根據模式對行進行排序
function sortLines(lines, mode) {
    // 確保傳入的是有效數據
    if (!Array.isArray(lines) || lines.length === 0) return lines;
    
    // 嘗試檢測行的格式
    const hasCorrectFormat = lines.some(line => {
        // 檢查是否符合「XX-XX 項目名」的格式 (如 "01-03 WBC 10.5")
        return /^\d{2}-\d{2}\s+.+/.test(line.trim());
    });
    
    // 如果沒有正確的格式，返回原始行
    if (!hasCorrectFormat) return lines;
    
    // 定義排序函數
    return lines.sort((a, b) => {
        // 提取日期部分 (前5個字符，形如 "01-03")
        const dateA = a.substring(0, 5);
        const dateB = b.substring(0, 5);
        
        // 提取項目名稱部分 (第7個字符之後)
        const itemA = a.substring(6).trim();
        const itemB = b.substring(6).trim();
        
        // 根據模式應用不同的排序邏輯
        switch(mode) {
            case 1: // 時間升序：先按日期升序排，日期相同則按項目名稱升序排
                return dateA === dateB ? itemA.localeCompare(itemB) : dateA.localeCompare(dateB);
                
            case 2: // 時間降序：先按日期降序排，日期相同則按項目名稱升序排
                return dateA === dateB ? itemA.localeCompare(itemB) : dateB.localeCompare(dateA);
                
            case 3: // 項目升序：先按項目名稱升序排，項目名稱相同則按日期升序排
                return itemA === itemB ? dateA.localeCompare(dateB) : itemA.localeCompare(itemB);
                
            case 4: // 項目降序：先按項目名稱降序排，項目名稱相同則按日期升序排
                return itemA === itemB ? dateA.localeCompare(dateB) : itemB.localeCompare(itemA);
                
            default: // 默認時間升序
                return dateA === dateB ? itemA.localeCompare(itemB) : dateA.localeCompare(dateB);
        }
    });
}

// 顯示排序模式提示
function showSortNotification(mode) {
    // 移除現有提示（如果有）
    const existingNotification = document.getElementById('sortModeNotification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // 創建新提示
    const notification = document.createElement('div');
    notification.id = 'sortModeNotification';
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.left = '50%';
    notification.style.transform = 'translateX(-50%)';
    notification.style.padding = '10px 15px';
    notification.style.borderRadius = '5px';
    notification.style.color = 'white';
    notification.style.fontWeight = 'bold';
    notification.style.zIndex = '9999';
    notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    notification.style.transition = 'opacity 0.3s';
    
    // 根據模式設置提示內容和樣式
    switch(mode) {
        case 1:
            notification.textContent = '排序模式：時間升序（先按日期，再按項目名）';
            notification.style.backgroundColor = '#4CAF50';
            break;
        case 2:
            notification.textContent = '排序模式：時間降序（先按日期，再按項目名）';
            notification.style.backgroundColor = '#2196F3';
            break;
        case 3:
            notification.textContent = '排序模式：項目升序（先按項目名，再按日期）';
            notification.style.backgroundColor = '#FF9800';
            break;
        case 4:
            notification.textContent = '排序模式：項目降序（先按項目名，再按日期）';
            notification.style.backgroundColor = '#9C27B0';
            break;
    }
    
    // 添加到頁面
    document.body.appendChild(notification);
    
    // 2秒後淡出
    setTimeout(() => {
        notification.style.opacity = '0';
        // 動畫結束後移除元素
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// 確保在HTML結構準備好後添加按鈕
function ensureSortButtonAdded() {
    if (document.querySelector('.button-container') && !document.getElementById('advancedSort')) {
        addAdvancedSortButton();
    }
}

// 在頁面載入完成後添加按鈕
document.addEventListener('DOMContentLoaded', function() {
    ensureSortButtonAdded();
    
    // 監視DOM變化，確保按鈕始終存在
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                ensureSortButtonAdded();
            }
        });
    });
    
    // 配置觀察者
    observer.observe(document.body, { childList: true, subtree: true });
    
    // 添加CSS動畫
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    `;
    document.head.appendChild(style);
});

// 修改解析報告函數，確保按鈕在每次解析時都添加
if (typeof window.parseReport === 'function') {
    const originalParseReport = window.parseReport;
    window.parseReport = function() {
        originalParseReport.apply(this, arguments);
        ensureSortButtonAdded();
    };
}

if (typeof window.parseAndCopy === 'function') {
    const originalParseAndCopy = window.parseAndCopy;
    window.parseAndCopy = function() {
        originalParseAndCopy.apply(this, arguments);
        ensureSortButtonAdded();
    };
}

if (typeof window.clearAndParse === 'function') {
    const originalClearAndParse = window.clearAndParse;
    window.clearAndParse = function() {
        originalClearAndParse.apply(this, arguments);
        ensureSortButtonAdded();
    };
}

// 立即添加按鈕（適用於已載入的頁面）
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(function() {
        ensureSortButtonAdded();
    }, 100);
}

// Add to the existing <style> tag or create a new one
function addSummaryTableStyles() {
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        .summary-table th, .summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        
        .summary-table th {
            background-color: #f1f1f1;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .summary-table th:first-child,
        .summary-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .summary-table th:first-child {
            z-index: 3;
        }
        
        .summary-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .summary-table tr:hover {
            background-color: #f1f8e9;
        }
        
        #summaryTableContainer {
            margin-top: 15px;
            overflow-x: auto;
        }
    `;
    document.head.appendChild(styleElement);
}

// Call this function when the document is ready
document.addEventListener('DOMContentLoaded', function() {
    addSummaryTableStyles();
});

// 修改Tab顯示邏輯 - 水平顯示在右側頂部
document.addEventListener('DOMContentLoaded', function() {
    // 移動Tab按鈕到主內容區頂部
    moveTabButtonsToTop();
    
    // 增強Tab按鈕
    enhanceTabButtons();
    
    // 監聽窗口大小變化，響應式調整
    window.addEventListener('resize', handleResponsiveLayout);
    handleResponsiveLayout();
});

// 將Tab按鈕移動到主內容區頂部
function moveTabButtonsToTop() {
    // 獲取Tab按鈕容器
    const tabButtonsContainer = document.querySelector('.tab-buttons');
    
    if (!tabButtonsContainer) return;
    
    // 從側邊欄中移除Tab按鈕容器
    if (tabButtonsContainer.parentNode) {
        tabButtonsContainer.parentNode.removeChild(tabButtonsContainer);
    }
    
    // 獲取主內容區
    const mainContent = document.querySelector('.main-content');
    if (!mainContent) return;
    
    // 將Tab按鈕容器插入到主內容區的最前面
    mainContent.insertBefore(tabButtonsContainer, mainContent.firstChild);
    
    // 設置 tab 按鈕容器為 sticky (在此直接添加功能)
    tabButtonsContainer.style.position = 'sticky';
    tabButtonsContainer.style.top = '0';
    tabButtonsContainer.style.zIndex = '50';
    tabButtonsContainer.style.width = '100%'; // 使用百分比寬度而非動態計算
}

// 增強Tab按鈕顯示
function enhanceTabButtons() {
    const tabButtons = document.querySelectorAll('.tab-button');
    
    tabButtons.forEach((button, index) => {
        // 如果按鈕已經有icon則跳過
        if (button.querySelector('i')) return;
        
        // 根據索引/內容添加適當的圖標
        const iconClass = getIconClassForButton(button.textContent.trim() || index);
        
        // 創建圖標元素
        const icon = document.createElement('i');
        icon.className = iconClass;
        
        // 將圖標添加到按鈕開頭
        if (button.firstChild) {
            button.insertBefore(icon, button.firstChild);
        } else {
            button.appendChild(icon);
        }
    });
}

// 根據按鈕內容選擇合適的圖標
function getIconClassForButton(btnText) {
    // 預設圖標映射
    const iconMap = {
        '文字': 'fas fa-align-left',
        '趨勢': 'fas fa-chart-line',
        '微生物': 'fas fa-bacterium',
        '藥敏': 'fas fa-tablets',
        '表格': 'fas fa-table'
    };
    
    return iconMap[btnText] || 'fas fa-circle'; // 默認圖標
}

// 處理響應式布局
function handleResponsiveLayout() {
    const isMobile = window.innerWidth <= 768;
    const tabButtons = document.querySelector('.tab-buttons');
    
    if (!tabButtons) return;
    
    if (isMobile) {
        // 移動設備顯示方式 - 更小的padding
        tabButtons.style.padding = '5px';
        
        // 縮小Tab按鈕
        document.querySelectorAll('.tab-button').forEach(button => {
            button.style.padding = '8px 12px';
            button.style.fontSize = '13px';
        });
    } else {
        // 桌面顯示方式 - 正常大小
        tabButtons.style.padding = '';
        
        // 恢復Tab按鈕
        document.querySelectorAll('.tab-button').forEach(button => {
            button.style.padding = '';
            button.style.fontSize = '';
        });
    }
}

</script>
</body>
</html>
